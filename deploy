#!/usr/bin/env node

/**
 * ################################################################################
 * ğŸš€ Benchmark ç»Ÿä¸€éƒ¨ç½²è„šæœ¬
 * åŠŸèƒ½: è·¨å¹³å°ä¸€é”®éƒ¨ç½²ï¼ˆWindows/Linux/macOSï¼‰
 * æ”¯æŒ: è°ƒè¯•/å•æœº/åˆ†å¸ƒå¼/æœ¬åœ°/ç”Ÿäº§ç­‰æ‰€æœ‰éƒ¨ç½²åœºæ™¯
 * ################################################################################
 */

import { execSync, spawn } from 'child_process';
import fs from 'fs';
import path from 'path';
import readline from 'readline';
import { fileURLToPath } from 'url';
import os from 'os';

// ES module ä¸­çš„ __dirname æ›¿ä»£
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==================== é¢œè‰²å®šä¹‰ ====================
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  magenta: '\x1b[35m'
};

// Windows å¹³å°ç¦ç”¨é¢œè‰²
if (process.platform === 'win32' && !process.env.FORCE_COLOR) {
  Object.keys(colors).forEach(key => colors[key] = '');
}

// ==================== å·¥å…·å‡½æ•° ====================
function print(msg, color = 'reset') {
  console.log(`${colors[color]}${msg}${colors.reset}`);
}

function printHeader(msg) {
  console.log('');
  print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
  print(msg, 'cyan');
  print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
  console.log('');
}

function printSuccess(msg) {
  print(`âœ… ${msg}`, 'green');
}

function printError(msg) {
  print(`âŒ ${msg}`, 'red');
}

function printWarning(msg) {
  print(`âš ï¸  ${msg}`, 'yellow');
}

function printInfo(msg) {
  print(`â„¹ï¸  ${msg}`, 'blue');
}

function printStep(msg) {
  print(`â¤ ${msg}`, 'cyan');
}

function printBanner() {
  console.clear();
  console.log('');
  print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'cyan');
  print('â•‘                                                        â•‘', 'cyan');
  print('â•‘     ğŸš€ Benchmark ç»Ÿä¸€éƒ¨ç½²è„šæœ¬                          â•‘', 'cyan');
  print('â•‘                                                        â•‘', 'cyan');
  print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
  console.log('');
}

// åˆ›å»ºreadlineæ¥å£
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => rl.question(query, resolve));
}

// ==================== ç¯å¢ƒæ£€æµ‹ ====================
function detectOS() {
  const platform = process.platform;
  const osMap = {
    'win32': 'Windows',
    'darwin': 'macOS',
    'linux': 'Linux'
  };
  return osMap[platform] || 'Unknown';
}

function checkNode() {
  printStep('æ£€æŸ¥ Node.js ç¯å¢ƒ...');

  const nodeVersion = process.version.substring(1); // ç§»é™¤ 'v'
  const majorVersion = parseInt(nodeVersion.split('.')[0]);

  if (majorVersion < 18) {
    printError(`Node.js ç‰ˆæœ¬è¿‡ä½: v${nodeVersion} (éœ€è¦ >= v18.0.0)`);
    process.exit(1);
  }

  printSuccess(`Node.js v${nodeVersion}`);

  try {
    const npmVersion = execSync('npm -v', { encoding: 'utf-8' }).trim();
    printSuccess(`npm v${npmVersion}`);
  } catch (e) {
    printError('npm æœªå®‰è£…');
    process.exit(1);
  }
}

async function checkPort(port = 3000) {
  printStep(`æ£€æŸ¥ç«¯å£ ${port} æ˜¯å¦å¯ç”¨...`);

  const net = await import('net');
  return new Promise((resolve) => {
    const tester = net.default.createServer()
      .once('error', async (err) => {
        if (err.code === 'EADDRINUSE') {
          printWarning(`ç«¯å£ ${port} å·²è¢«å ç”¨`);
          console.log('');
          console.log('è¯·é€‰æ‹©æ“ä½œ:');
          console.log('  1) ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹');
          console.log('  2) å–æ¶ˆéƒ¨ç½²');
          console.log('');

          const choice = await question('è¯·è¾“å…¥é€‰é¡¹ [1/2]: ');

          if (choice === '1') {
            printStep('ç»ˆæ­¢å ç”¨è¿›ç¨‹...');
            try {
              if (process.platform === 'win32') {
                execSync(`for /f "tokens=5" %a in ('netstat -ano ^| findstr :${port}') do taskkill /F /PID %a`, { shell: 'cmd' });
              } else {
                execSync(`lsof -ti:${port} | xargs kill -9`);
              }
              printSuccess('ç«¯å£å·²é‡Šæ”¾');
              resolve(true);
            } catch (e) {
              printWarning('é‡Šæ”¾ç«¯å£å¤±è´¥ï¼Œä½†å°†ç»§ç»­éƒ¨ç½²');
              resolve(true);
            }
          } else {
            printInfo('éƒ¨ç½²å·²å–æ¶ˆ');
            process.exit(0);
          }
        } else {
          resolve(true);
        }
      })
      .once('listening', () => {
        tester.close();
        printSuccess(`ç«¯å£ ${port} å¯ç”¨`);
        resolve(true);
      })
      .listen(port);
  });
}

// ==================== éƒ¨ç½²æ¨¡å¼é€‰æ‹© ====================
async function selectDeployMode() {
  printHeader('é€‰æ‹©éƒ¨ç½²æ¨¡å¼');

  console.log('è¯·é€‰æ‹©éƒ¨ç½²æ¨¡å¼:');
  console.log('');
  console.log('  1) ğŸ”§ è°ƒè¯•æ¨¡å¼ (å¼€å‘è°ƒè¯•)');
  console.log('  2) ğŸ’» å•æœºæ¨¡å¼ (Master + Worker åŒæœº)');
  console.log('  3) ğŸŒ åˆ†å¸ƒå¼ - Master (ä¸»æ§æœåŠ¡å™¨)');
  console.log('  4) âš¡ åˆ†å¸ƒå¼ - Worker (æ‰§è¡ŒèŠ‚ç‚¹)');
  console.log('  5) ğŸš€ ç”Ÿäº§æ¨¡å¼ (ä½¿ç”¨ PM2)');
  console.log('  6) ğŸ³ Docker æ¨¡å¼');
  console.log('  7) ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡');
  console.log('  8) å–æ¶ˆ');
  console.log('');

  const choice = await question('è¯·è¾“å…¥é€‰é¡¹ [1-8]: ');

  switch (choice) {
    case '1': return 'debug';
    case '2': return 'standalone';
    case '3': return 'master';
    case '4': return 'worker';
    case '5': return 'production';
    case '6': return 'docker';
    case '7': return 'stop';
    case '8':
      printInfo('å·²å–æ¶ˆ');
      process.exit(0);
    default:
      printError('æ— æ•ˆé€‰é¡¹');
      return selectDeployMode();
  }
}

// ==================== ä¾èµ–å®‰è£… ====================
function installDependencies() {
  printHeader('å®‰è£…ä¾èµ–');

  if (!fs.existsSync('node_modules')) {
    printStep('å®‰è£… npm ä¾èµ–...');
    execSync('npm install', { stdio: 'inherit' });
    printSuccess('ä¾èµ–å®‰è£…å®Œæˆ');
  } else {
    printInfo('ä¾èµ–å·²å®‰è£…');
  }
}

function buildProject() {
  printHeader('æ„å»ºé¡¹ç›®');

  printStep('ç¼–è¯‘ TypeScript...');
  execSync('npm run build', { stdio: 'inherit' });
  printSuccess('æ„å»ºå®Œæˆ');
}

// ==================== å¯åŠ¨æœåŠ¡ ====================
async function startDebugMode() {
  printHeader('å¯åŠ¨è°ƒè¯•æ¨¡å¼');

  const port = (await question('Web æœåŠ¡ç«¯å£ [é»˜è®¤: 3000]: ')) || '3000';

  printInfo('è°ƒè¯•æ¨¡å¼å°†åœ¨å‰å°è¿è¡Œ,æŒ‰ Ctrl+C åœæ­¢');
  console.log('');

  const env = { ...process.env, PORT: port };
  spawn('npm', ['run', 'dev'], { stdio: 'inherit', env, shell: true });
}

async function startStandaloneMode() {
  printHeader('å¯åŠ¨å•æœºæ¨¡å¼');

  const port = (await question('Web æœåŠ¡ç«¯å£ [é»˜è®¤: 3000]: ')) || '3000';

  printInfo('å•æœºæ¨¡å¼: Master å’Œ Worker å°†åœ¨æœ¬æœºè¿è¡Œ');
  console.log('');

  // å¯åŠ¨ Master
  printStep('å¯åŠ¨ Master...');
  const masterEnv = { ...process.env, PORT: port };
  const master = spawn('npm', ['start'], {
    stdio: 'inherit',
    env: masterEnv,
    shell: true,
    detached: true
  });

  // ç­‰å¾… Master å¯åŠ¨
  await new Promise(resolve => setTimeout(resolve, 5000));

  // å¯åŠ¨ Worker
  printStep('å¯åŠ¨ Worker...');
  const workerEnv = {
    ...process.env,
    MASTER_URL: `http://localhost:${port}`,
    WORKER_NAME: `Worker-${os.hostname()}`,
    PERFORMANCE_TIER: 'medium'
  };

  const worker = spawn('npx', ['tsx', 'server/worker-client.ts'], {
    stdio: 'inherit',
    env: workerEnv,
    shell: true,
    detached: true
  });

  console.log('');
  printSuccess('å•æœºæ¨¡å¼å¯åŠ¨æˆåŠŸï¼');
  print(`ğŸ“¡ è®¿é—®åœ°å€: http://localhost:${port}`, 'cyan');
}

async function startMasterMode() {
  printHeader('å¯åŠ¨ Master æ¨¡å¼');

  // è°ƒç”¨ç°æœ‰çš„ standalone-deploy è„šæœ¬
  const scriptExt = process.platform === 'win32' ? 'bat' : 'sh';
  const scriptPath = path.join(__dirname, 'scripts', `standalone-deploy.${scriptExt}`);

  if (fs.existsSync(scriptPath)) {
    if (process.platform !== 'win32') {
      execSync(`chmod +x "${scriptPath}"`);
    }

    const cmd = process.platform === 'win32' ? scriptPath : `bash "${scriptPath}"`;
    spawn(cmd, [], { stdio: 'inherit', shell: true });
  } else {
    printError('æœªæ‰¾åˆ°éƒ¨ç½²è„šæœ¬');
  }
}

async function startWorkerMode() {
  printHeader('å¯åŠ¨ Worker æ¨¡å¼');

  const masterUrl = await question('Master URL (ä¾‹å¦‚: http://192.168.1.100:3000): ');
  const workerName = await question(`Worker åç§° [é»˜è®¤: Worker-${os.hostname()}]: `) || `Worker-${os.hostname()}`;

  console.log('');
  console.log('æ€§èƒ½ç­‰çº§:');
  console.log('  1) high   - é«˜é… (16æ ¸+, 32GB+)');
  console.log('  2) medium - ä¸­é… (4-8æ ¸, 8-16GB)');
  console.log('  3) low    - ä½é… (2-4æ ¸, 4-8GB)');
  console.log('');

  const perfChoice = await question('è¯·é€‰æ‹© [1-3]: ');
  const perfMap = { '1': 'high', '2': 'medium', '3': 'low' };
  const perfTier = perfMap[perfChoice] || 'medium';

  const env = {
    ...process.env,
    MASTER_URL: masterUrl,
    WORKER_NAME: workerName,
    PERFORMANCE_TIER: perfTier
  };

  printStep('å¯åŠ¨ Worker...');
  spawn('npx', ['tsx', 'server/worker-client.ts'], {
    stdio: 'inherit',
    env,
    shell: true
  });
}

async function startProductionMode() {
  printHeader('ç”Ÿäº§æ¨¡å¼ (PM2)');

  // æ£€æŸ¥ PM2
  try {
    execSync('pm2 -v', { stdio: 'ignore' });
  } catch (e) {
    printWarning('PM2 æœªå®‰è£…');
    const install = await question('æ˜¯å¦å®‰è£… PM2? [y/n]: ');
    if (install.toLowerCase() === 'y') {
      printStep('å®‰è£… PM2...');
      execSync('npm install -g pm2', { stdio: 'inherit' });
    } else {
      printInfo('å·²å–æ¶ˆ');
      return;
    }
  }

  printStep('ä½¿ç”¨ PM2 å¯åŠ¨...');
  execSync('npm run pm2:start', { stdio: 'inherit' });
  printSuccess('æœåŠ¡å·²å¯åŠ¨');

  console.log('');
  print('ç®¡ç†å‘½ä»¤:', 'cyan');
  print('  pm2 status       - æŸ¥çœ‹çŠ¶æ€', 'yellow');
  print('  pm2 logs         - æŸ¥çœ‹æ—¥å¿—', 'yellow');
  print('  pm2 restart all  - é‡å¯æœåŠ¡', 'yellow');
  print('  pm2 stop all     - åœæ­¢æœåŠ¡', 'yellow');
}

async function startDockerMode() {
  printHeader('Docker æ¨¡å¼');

  try {
    execSync('docker -v', { stdio: 'ignore' });
  } catch (e) {
    printError('Docker æœªå®‰è£…');
    return;
  }

  console.log('è¯·é€‰æ‹©:');
  console.log('  1) ä½¿ç”¨ Docker');
  console.log('  2) ä½¿ç”¨ Docker Compose');
  console.log('');

  const choice = await question('è¯·é€‰æ‹© [1/2]: ');

  if (choice === '1') {
    printStep('æ„å»º Docker é•œåƒ...');
    execSync('npm run docker:build', { stdio: 'inherit' });
    printStep('å¯åŠ¨å®¹å™¨...');
    execSync('npm run docker:run', { stdio: 'inherit' });
  } else if (choice === '2') {
    printStep('ä½¿ç”¨ Docker Compose å¯åŠ¨...');
    execSync('npm run compose:up', { stdio: 'inherit' });
  }

  printSuccess('Docker å®¹å™¨å·²å¯åŠ¨');
}

async function stopAllServices() {
  printHeader('åœæ­¢æ‰€æœ‰æœåŠ¡');

  printStep('åœæ­¢ PM2 æœåŠ¡...');
  try {
    execSync('pm2 stop all', { stdio: 'inherit' });
    printSuccess('PM2 æœåŠ¡å·²åœæ­¢');
  } catch (e) {
    printWarning('æœªæ‰¾åˆ° PM2 æœåŠ¡');
  }

  printStep('åœæ­¢ Docker å®¹å™¨...');
  try {
    execSync('npm run compose:down', { stdio: 'ignore' });
    execSync('npm run docker:stop', { stdio: 'ignore' });
    printSuccess('Docker å®¹å™¨å·²åœæ­¢');
  } catch (e) {
    printWarning('æœªæ‰¾åˆ° Docker å®¹å™¨');
  }

  printStep('åœæ­¢ç«¯å£ 3000 çš„è¿›ç¨‹...');
  try {
    if (process.platform === 'win32') {
      execSync('for /f "tokens=5" %a in (\'netstat -ano ^| findstr :3000\') do taskkill /F /PID %a', { shell: 'cmd', stdio: 'ignore' });
    } else {
      execSync('lsof -ti:3000 | xargs kill -9', { stdio: 'ignore' });
    }
    printSuccess('ç«¯å£è¿›ç¨‹å·²åœæ­¢');
  } catch (e) {
    printWarning('æœªæ‰¾åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹');
  }

  printSuccess('æ‰€æœ‰æœåŠ¡å·²åœæ­¢');
}

// ==================== ä¸»æµç¨‹ ====================
async function main() {
  try {
    printBanner();

    // ç¯å¢ƒæ£€æµ‹
    printHeader('ç¯å¢ƒæ£€æµ‹');
    const osName = detectOS();
    printInfo(`æ“ä½œç³»ç»Ÿ: ${osName}`);
    checkNode();
    await checkPort();

    // é€‰æ‹©éƒ¨ç½²æ¨¡å¼
    const mode = await selectDeployMode();

    // æ ¹æ®æ¨¡å¼æ‰§è¡Œ
    if (mode === 'stop') {
      await stopAllServices();
      rl.close();
      return;
    }

    // å®‰è£…ä¾èµ–å’Œæ„å»º(è°ƒè¯•æ¨¡å¼é™¤å¤–)
    if (mode !== 'debug') {
      installDependencies();
      buildProject();
    }

    // å¯åŠ¨å¯¹åº”æ¨¡å¼
    switch (mode) {
      case 'debug':
        await startDebugMode();
        break;
      case 'standalone':
        await startStandaloneMode();
        break;
      case 'master':
        await startMasterMode();
        break;
      case 'worker':
        await startWorkerMode();
        break;
      case 'production':
        await startProductionMode();
        break;
      case 'docker':
        await startDockerMode();
        break;
    }

    rl.close();
  } catch (error) {
    printError(`é”™è¯¯: ${error.message}`);
    rl.close();
    process.exit(1);
  }
}

// æ‰§è¡Œä¸»æµç¨‹
main();
