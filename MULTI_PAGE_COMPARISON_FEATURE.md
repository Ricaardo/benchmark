# 📊 多页面均值比较表功能

## 功能概述

在测试记录的图表展开区域，新增了**多页面均值比较表**功能，用于直观对比多个页面的性能指标。

---

## 🎯 功能特点

### 表格布局
- **行表头**: 页面名称
- **列表头**: 性能指标（FP、FCP、LCP、TTFB等）
- **最后一列**: 平均差值百分比（相对于基准页面）

### 视觉设计
1. **基准页面标识**
   - 第一行为基准页面，背景色为淡蓝色 (#f0f9ff)
   - 带有 📍 图标和"(基准)"标签
   - 所有差值百分比都相对于此页面计算

2. **差值颜色编码**
   - 🔴 **红色**: 性能下降（数值增大）超过5%
   - 🟢 **绿色**: 性能提升（数值减小）超过5%
   - ⚪ **灰色**: 变化在±5%以内

3. **平均差值列**
   - 黄色背景 (#fef3c7)
   - 显示该页面相对于基准的整体性能差异
   - 字体更大更醒目

---

## 📋 支持的测试类型

### 1. Initialization 测试
支持的指标：
- **FP** (First Paint) - 首次绘制时间
- **FCP** (First Contentful Paint) - 首次内容绘制时间
- **LCP** (Largest Contentful Paint) - 最大内容绘制时间
- **TTFB** (Time to First Byte) - 首字节时间
- **SRT** (Server Response Time) - 服务器响应时间
- **CLS** (Cumulative Layout Shift) - 累积布局偏移

### 2. Runtime 测试
支持的指标：
- **CPU Total** - 总CPU使用率
- **CPU Thread** - 线程CPU使用率
- **Heap** - 堆内存使用量
- **DOM Nodes** - DOM节点数量
- **JS Event Listeners** - 事件监听器数量
- **CPU Script** - 脚本执行CPU使用率
- **CPU Style** - 样式计算CPU使用率
- **CPU Layout** - 布局计算CPU使用率

### 3. MemoryLeak 测试
- 使用Runtime相同的指标

---

## 💡 使用示例

### 表格示例（Initialization）

```
┌─────────────────┬─────────┬─────────┬─────────┬──────────┬─────────┬─────────┬────────────┐
│ 页面名称        │ FP (ms) │ FCP(ms) │ LCP(ms) │ TTFB(ms) │ SRT(ms) │ CLS     │ 平均差值   │
├─────────────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┼────────────┤
│ 📍 页面A (基准) │ 150.5   │ 280.3   │ 450.8   │ 100.2    │ 95.1    │ 0.0012  │ -          │
│                 │         │         │         │          │         │         │            │
├─────────────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┼────────────┤
│ 页面B           │ 165.8   │ 295.7   │ 485.2   │ 108.5    │ 102.3   │ 0.0015  │ +7.5%      │
│                 │ +10.2%  │ +5.5%   │ +7.6%   │ +8.3%    │ +7.6%   │ +25.0%  │            │
├─────────────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┼────────────┤
│ 页面C           │ 142.3   │ 268.9   │ 432.1   │ 96.8     │ 91.2    │ 0.0010  │ -3.8%      │
│                 │ -5.4%   │ -4.1%   │ -4.1%   │ -3.4%    │ -4.1%   │ -16.7%  │            │
└─────────────────┴─────────┴─────────┴─────────┴──────────┴─────────┴─────────┴────────────┘
```

**解读**：
- 页面A是基准页面
- 页面B整体性能下降7.5%（红色显示）
- 页面C整体性能提升3.8%（绿色显示）

---

## 🔧 技术实现

### 文件结构
```
/public/
├── js/
│   └── multi-page-comparison.js    # 多页面比较表组件
└── records.html                     # 引入并使用组件
```

### 核心函数

#### 1. `createInitializationComparisonTable(successfulResults, metrics)`
生成Initialization测试的比较表

**参数**:
- `successfulResults`: 成功的测试结果数组
- `metrics`: 指标配置数组

**返回**: HTML字符串

#### 2. `createRuntimeComparisonTable(successfulResults, metrics)`
生成Runtime测试的比较表

**参数**:
- `successfulResults`: 成功的测试结果数组
- `metrics`: 指标配置数组

**返回**: HTML字符串

### 数据格式

#### Initialization 数据格式
```javascript
successfulResults = [
    {
        description: "页面A",
        data: {
            "fp-cold-iterations": [150, 152, 148],
            "fcp-cold-iterations": [280, 282, 278],
            // ...
        }
    }
];
```

#### Runtime 数据格式
```javascript
successfulResults = [
    {
        description: "页面A",
        data: {
            "cpu-total": 0.45,
            "heap": 123456789,
            // ...
        }
    }
];
```

---

## 📊 表格样式

### CSS类名
- `.stats-table` - 表格基础样式
- `.stats-url-name` - URL名称单元格
- `.stats-diff-positive` - 正向差值（红色，性能下降）
- `.stats-diff-negative` - 负向差值（绿色，性能提升）
- `.stats-diff-neutral` - 中性差值（灰色，变化不大）

### 特殊样式
```css
/* 基准页面行背景 */
background: #f0f9ff;

/* 平均差值列背景 */
background: #fef3c7;

/* 页面名称列固定（支持横向滚动）*/
position: sticky;
left: 0;
z-index: 1;
```

---

## 🎨 显示位置

比较表显示在以下位置：
1. **性能指标汇总对比表**之后
2. **性能指标对比图表**之前

显示顺序：
```
📊 性能指标汇总对比（原有的指标为行、页面为列的表格）
     ↓
📈 多页面均值比较表（新增的页面为行、指标为列的表格）
     ↓
📊 性能指标对比图表（柱状图/折线图）
```

---

## 💻 使用方法

### 查看比较表

1. **访问测试记录页面**
   ```
   http://localhost:3000/records.html
   ```

2. **点击展开图标**（▶）查看测试详情

3. **滚动到图表区域**
   - 首先看到传统的"性能指标汇总对比表"
   - 紧接着是新的"多页面均值比较表"
   - 最后是各指标的详细图表

### 创建多页面测试

要看到比较表的完整效果，需要创建包含多个URL的测试用例：

1. **添加测试用例**时，在URL列表中添加多个页面：
   ```
   页面A: https://example.com/page-a
   页面B: https://example.com/page-b
   页面C: https://example.com/page-c
   ```

2. **运行测试**，等待完成

3. **查看结果**，展开图表即可看到多页面比较表

---

## 📐 计算公式

### 差值百分比
```javascript
diffPercent = ((currentValue - baseValue) / baseValue) * 100
```

### 平均差值
```javascript
avgDiffPercent = sum(diffPercents) / count(metrics)
```

### 示例计算
假设基准页面FP为100ms，对比页面FP为120ms：
```
diffPercent = ((120 - 100) / 100) * 100 = +20.0%
```

---

## ⚠️ 注意事项

### 1. 单页面测试
如果测试只包含一个页面，不会显示差值列和平均差值列。

### 2. 失败的测试
只有成功的测试结果才会被包含在比较表中。失败的URL会在上方单独显示错误信息。

### 3. 数据精度
- 时间类指标保留1位小数（ms）
- CLS保留4位小数
- 百分比保留1位小数

### 4. 颜色阈值
- 变化 > +5%: 红色（性能下降）
- 变化 < -5%: 绿色（性能提升）
- -5% ≤ 变化 ≤ +5%: 灰色（变化不明显）

---

## 🔍 故障排查

### 比较表不显示

**检查项**:
1. 是否成功加载了 `/js/multi-page-comparison.js`
2. 浏览器控制台是否有JavaScript错误
3. 测试是否包含多个页面
4. 测试是否成功完成

**验证脚本加载**:
```javascript
// 在浏览器控制台执行
typeof createInitializationComparisonTable === 'function'  // 应返回true
typeof createRuntimeComparisonTable === 'function'        // 应返回true
```

### 样式显示异常

**解决方案**:
1. 清除浏览器缓存（Ctrl+Shift+R）
2. 检查 CSS 文件是否正确加载
3. 确认 `.stats-diff-*` 类样式存在

---

## 📈 未来改进

### 计划中的功能
1. [ ] 支持自定义基准页面（不限于第一个）
2. [ ] 添加排序功能（按指标排序）
3. [ ] 支持导出比较表为CSV/Excel
4. [ ] 添加可视化图标（箭头、趋势线）
5. [ ] 支持多组测试的横向对比

### 性能优化
1. [ ] 大量页面时的虚拟滚动
2. [ ] 延迟渲染（fold下的内容）
3. [ ] 数据缓存机制

---

## 🎉 功能总结

**优势**:
- ✅ 直观对比多个页面的性能
- ✅ 一目了然的差值百分比
- ✅ 清晰的颜色编码
- ✅ 支持横向滚动（大量页面时）
- ✅ 响应式设计

**适用场景**:
- 🎯 A/B测试对比
- 🎯 不同版本性能对比
- 🎯 多页面性能评估
- 🎯 性能回归检测

---

**创建日期**: 2025-12-02
**版本**: v1.0.0
