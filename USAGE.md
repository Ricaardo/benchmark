# 使用指南

完整的功能使用说明和最佳实践。

## 目录

- [快速开始](#快速开始)
- [测试用例管理](#测试用例管理)
- [分布式执行](#分布式执行)
- [批量测试](#批量测试)
- [测试记录](#测试记录)
- [高级功能](#高级功能)
- [最佳实践](#最佳实践)

## 快速开始

### 1. 启动服务

```bash
npm start
```

访问: http://localhost:3000

### 2. 创建第一个测试用例

1. 点击 "新建用例" 按钮
2. 输入用例名称（如：首页性能测试）
3. 添加测试 URL（如：https://www.bilibili.com）
4. 选择测试类型（推荐：Initialization）
5. 点击 "保存"

### 3. 运行测试

1. 找到刚创建的测试用例
2. 点击 "运行" 按钮
3. 输入测试标记（可选，如：Baseline）
4. 等待测试完成
5. 点击 "查看报告" 查看结果

### 4. 查看报告

测试完成后：
- 点击用例卡片中的 "查看报告" 链接
- 或访问 "测试记录" 页面查看历史记录

## 测试用例管理

### 创建测试用例

#### 基础配置

**必填项:**
- **用例名称**: 描述性名称（如：首页初始化性能测试）
- **测试 URL**: 至少一个有效的 URL
- **测试类型**: 至少选择一种 Runner

**可选项:**
- **描述**: 用例说明
- **标签**: 分类标签（如：首页、视频、直播）
- **重复次数**: 默认 1 次
- **运行模式**: headless（无头）/ headed（有头）
- **CPU 限流**: 1x（无限流）/ 4x / 6x

#### 测试类型说明

**Initialization (初始化测试)**
- **用途**: 测试页面冷启动性能
- **配置**:
  - 迭代次数（Iterations）: 默认 7 次
- **适合场景**: 首屏性能、加载速度

**Runtime (运行时测试)**
- **用途**: 测试页面长时间运行的性能表现
- **配置**:
  - 测试时长（Duration）: 默认 60000ms (1分钟)
  - 采样间隔（Delay）: 默认 10000ms (10秒)
- **适合场景**: 内存稳定性、CPU 占用

**MemoryLeak (内存泄漏测试)**
- **用途**: 检测内存泄漏问题
- **配置**:
  - 迭代次数（Iterations）: 默认 3 次
  - 采样间隔（Interval）: 默认 60000ms (1分钟)
  - 页面操作（On Page Testing）: 可选的自定义脚本
- **适合场景**: 长时间运行、频繁操作的页面

#### URL 管理

**添加 URL:**
1. 点击 "添加 URL" 按钮
2. 输入完整的 URL（必须包含 http:// 或 https://）
3. 输入 URL 描述（可选，如：首页、视频页）

**Per-URL 独立配置:**

每个 URL 可以有独立的高级配置，优先级高于全局配置。

点击 URL 右侧的 "⚙️ 配置" 按钮，可设置：
- Cookie
- 延迟（Delay）
- 自定义 Headers
- 阻止资源加载
- 自定义 CSS

详见: [USAGE_GUIDE.md](USAGE_GUIDE.md)

### 使用预设模板

**加载预设:**
1. 点击 "预设模板" 按钮
2. 选择合适的模板（如：B站首页性能测试）
3. 点击 "加载"
4. 根据需要修改配置
5. 保存

**可用预设:**
- B站首页基础性能测试
- B站视频播放器测试
- B站直播间测试
- 内存泄漏检测模板
- Runtime 性能监控模板
- 等等...

详见: [PRESET_SYSTEM_GUIDE.md](PRESET_SYSTEM_GUIDE.md)

### 导入/导出用例

**导出用例:**
1. 点击 "导出用例" 按钮
2. 自动下载 JSON 文件（`test-cases-YYYY-MM-DD.json`）

**导入用例:**
1. 点击 "导入用例" 按钮
2. 选择之前导出的 JSON 文件
3. 用例自动添加到列表

**用途:**
- 团队间共享测试用例
- 备份测试配置
- 版本控制

### 标签筛选

点击标签可快速筛选相关用例：
- 点击标签: 仅显示包含该标签的用例
- 再次点击: 取消筛选

### 搜索用例

在搜索框中输入关键词，支持：
- 用例名称
- URL
- 描述
- 标签

## 分布式执行

### Worker 节点管理

#### 查看 Worker 状态

在页面顶部的 "Worker 选择器" 中可以看到：
- 在线 Worker 数量
- 每个 Worker 的性能等级（高配/中配/低配）
- Worker 状态（在线/离线）
- CPU 和内存使用率（鼠标悬停查看）

#### Worker 性能等级

- **高配** - 适合性能压测、大规模测试
- **中配** - 适合日常测试、回归测试（默认）
- **低配** - 适合兼容性测试、轻量级测试

### 选择 Worker 执行测试

**方法 1: 手动选择**
1. 在 Worker 下拉框中选择目标 Worker
2. 点击测试用例的 "运行" 按钮
3. 测试将在选中的 Worker 上执行

**方法 2: 自动选择**
1. 不选择 Worker（或选择"本地执行"）
2. 点击 "运行" 按钮
3. 系统自动选择中配 Worker 执行

**自动选择优先级:**
1. 中配 Worker (medium) ← 首选
2. 低配 Worker (low)
3. 高配 Worker (high)
4. 自定义 Worker (custom)
5. 本地执行（无可用 Worker）

详见: [WORKER_SELECTION_STRATEGY.md](WORKER_SELECTION_STRATEGY.md)

### 查看分布式任务状态

**任务卡片显示:**
- 任务名称和 ID
- 执行节点名称
- 任务状态（pending/running/completed/failed）
- 开始时间和结束时间

**实时日志:**
测试执行过程中会实时显示：
```
[系统] 🌐 使用分布式执行，目标节点: worker_xxx
[系统] 🎯 自动选择中配Worker: 中配测试机-1
[Worker] 任务开始执行...
[Worker] 测试完成
```

## 批量测试

### 批量选择测试用例

1. 测试用例卡片左上角会自动出现复选框
2. 勾选需要批量执行的用例
3. 或点击 "全选" 按钮选择所有用例

### 批量分发策略

点击 "批量分发" 按钮后，选择分发策略：

**1. 自动分配 - 优先中配 (推荐)**
- 系统自动选择中配 Worker
- 无需手动指定
- 适合大多数场景

**2. 指定 Worker**
- 手动选择目标 Worker
- 所有用例在同一 Worker 执行
- 适合特定机器测试

**3. 本地执行**
- 所有用例在主服务器本地执行
- 不使用 Worker 节点

### 查看批量分发进度

批量分发时会显示实时进度：
```
已分发 5/10 (成功: 5, 失败: 0)
```

完成后显示汇总：
```
✅ 完成! 成功: 10, 失败: 0
```

### 取消批量选择

- 点击 "取消选择" 按钮
- 或手动取消所有复选框

## 测试记录

### 访问测试记录

点击页面顶部的 "测试记录" 链接，或访问: http://localhost:3000/test-records.html

### 查看记录详情

**记录信息包括:**
- 测试用例名称
- 执行时间
- 测试标记（如：Baseline / V2.0）
- 执行状态（completed/failed）
- 测试配置（Runner 类型、URL 数量等）
- 测试结果（如果有）

**操作:**
- 点击 "查看报告" - 打开 HTML 报告
- 点击 "详情" - 展开完整配置
- 点击 "删除" - 删除该记录

### 筛选和搜索

**按状态筛选:**
- 全部
- 已完成
- 失败

**按时间筛选:**
- 最近 24 小时
- 最近 7 天
- 最近 30 天
- 自定义时间范围

**搜索:**
在搜索框输入关键词，支持：
- 测试用例名称
- 测试标记
- URL

### 统计信息

页面顶部显示：
- 总记录数
- 成功率
- 失败率

### 批量删除

1. 勾选需要删除的记录
2. 点击 "批量删除" 按钮
3. 确认删除

详见: [TEST_RECORDS_GUIDE.md](TEST_RECORDS_GUIDE.md)

## 高级功能

### Cookie 配置

**方法 1: 全局 Cookie**
在 "高级配置" 中设置 Cookie，应用到所有 URL。

**方法 2: Per-URL Cookie**
为特定 URL 设置独立 Cookie，优先级更高。

**Cookie 验证:**
点击 "验证 Cookie" 按钮可以：
- 检查 Cookie 是否有效
- 显示登录用户信息（UID、用户名、VIP 状态）

**自动 Cookie:**
勾选 "使用本地 Cookie" 可以自动使用当前浏览器的 Cookie。

详见: [USAGE_GUIDE.md](USAGE_GUIDE.md)

### 自定义 Headers

在 "高级配置" → "自定义 HTTP Headers" 中添加：

```json
{
  "User-Agent": "Custom UA",
  "Referer": "https://example.com"
}
```

### 资源阻止列表

在 "阻止资源加载" 中添加 URL 模式，阻止特定资源加载：

```
*.css
*.png
https://example.com/ads/*
```

**用途:**
- 加快测试速度
- 排除广告等无关资源
- 模拟网络环境

### 自定义 CSS

在 "自定义 CSS" 中注入样式：

```css
.ad-banner { display: none !important; }
body { font-size: 16px; }
```

**用途:**
- 隐藏特定元素
- 修改页面样式进行测试

### 自定义 Hooks

**页面加载前（Before Navigation）:**
```javascript
// 设置 localStorage
localStorage.setItem('key', 'value');

// 设置 Cookie
document.cookie = 'name=value';
```

**页面加载后（After Page Load）:**
```javascript
// 点击按钮
document.querySelector('.play-btn').click();

// 滚动页面
window.scrollTo(0, 1000);
```

详见: [USAGE_GUIDE.md](USAGE_GUIDE.md)

### Perfcat 集成

**配置 Perfcat:**
1. 访问设置页面
2. 输入 Perfcat API 地址
3. 输入项目 ID
4. 保存配置

**自动上传:**
测试完成后，报告自动上传到 Perfcat，生成可视化图表。

**图表模式:**
报告页面可以切换到图表模式，查看性能趋势。

详见:
- [PERFCAT_INTEGRATION.md](PERFCAT_INTEGRATION.md)
- [PERFCAT_SETUP_GUIDE.md](PERFCAT_SETUP_GUIDE.md)

## 最佳实践

### 测试用例命名

**推荐格式:**
```
[场景] - [页面/功能] - [测试类型]

示例:
- 首页 - 冷启动性能测试
- 视频页 - 播放器初始化
- 直播间 - 内存泄漏检测
```

### 使用测试标记

**测试标记用途:**
- 区分不同版本（Baseline / V2.0 / V3.0）
- 标记测试目的（优化前 / 优化后）
- 标记分支（main / feature-xxx）

**命名建议:**
```
Baseline        # 基准测试
V2.0-候选       # 版本候选
优化后          # 功能优化
主分支          # 代码分支
压测-1000用户   # 压力测试
```

### 测试用例分类

**使用标签组织用例:**
- **按场景**: 首页、视频、直播、搜索
- **按优先级**: P0、P1、P2
- **按环境**: 生产、预发布、测试
- **按类型**: 性能、兼容性、稳定性

### 合理使用 Worker

**高配 Worker:**
- 性能压测
- 大规模并发测试
- 复杂场景模拟

**中配 Worker (推荐日常使用):**
- 日常性能测试
- 回归测试
- 功能验证

**低配 Worker:**
- 兼容性测试
- 低端设备模拟
- 轻量级测试

### 测试频率建议

**每日回归:**
- 使用批量分发
- 运行核心测试用例
- 检查性能退化

**版本发布前:**
- 全量测试
- 多环境验证
- 性能对比

**性能优化:**
- 优化前后对比测试
- 使用相同测试标记
- 记录性能数据

### 数据管理

**定期清理:**
- 删除无用的测试记录
- 归档旧报告
- 导出重要用例

**备份:**
- 定期导出测试用例
- 备份 `data/` 目录
- 版本控制配置文件

### 性能优化建议

**减少测试时间:**
- 使用 headless 模式
- 合理设置重复次数
- 使用资源阻止列表

**提高测试准确性:**
- 多次重复测试取平均值
- 排除外部干扰（关闭其他程序）
- 使用专用测试机器

**分布式最佳实践:**
- Worker 和 Master 在同一局域网
- 避免 Worker 执行其他任务
- 监控 Worker 资源使用

## 常见场景示例

### 场景 1: 首页性能基准测试

```
用例名称: 首页 - 冷启动性能基准
URL: https://www.bilibili.com
测试类型: Initialization (7 次迭代)
标签: 首页, P0, 性能
测试标记: Baseline
运行环境: 中配 Worker
```

### 场景 2: 视频播放器优化验证

**优化前:**
```
用例名称: 视频页 - 播放器初始化
测试标记: 优化前
```

**优化后:**
```
用例名称: 视频页 - 播放器初始化
测试标记: 优化后
```

对比两次测试的报告数据。

### 场景 3: 直播间内存泄漏检测

```
用例名称: 直播间 - 内存泄漏检测
URL: https://live.bilibili.com/123456
测试类型: MemoryLeak
配置:
  - 迭代次数: 5
  - 采样间隔: 60000ms
  - 页面操作: 每分钟模拟用户交互
标签: 直播, 内存, P1
```

### 场景 4: 批量回归测试

1. 创建测试套件（10+ 核心场景）
2. 添加标签 "回归测试"
3. 筛选标签 "回归测试"
4. 全选用例
5. 批量分发 → 自动分配
6. 查看测试记录，检查是否有失败

### 场景 5: 性能压测

```
用例名称: 首页 - 高并发压测
Worker: 高配机器
测试类型: Runtime
配置:
  - 测试时长: 300000ms (5分钟)
  - CPU 限流: 1x (无限流)
重复次数: 3
标签: 压测, P2
```

## 故障排查

### 测试失败

**检查:**
1. 查看任务日志（控制台输出）
2. 检查 URL 是否可访问
3. 检查 Cookie 是否有效
4. 检查网络连接

### Worker 无响应

**解决:**
1. 检查 Worker 是否在线
2. 重启 Worker 进程
3. 检查网络连通性
4. 查看 Worker 日志

### 报告无法打开

**可能原因:**
- 测试未完成
- 报告文件损坏
- 路径错误

**解决:**
1. 等待测试完成
2. 重新运行测试
3. 检查 `data/reports/` 目录

更多问题参见: [TROUBLESHOOTING.md](TROUBLESHOOTING.md)

## 相关文档

- [README.md](README.md) - 项目概述
- [DEPLOYMENT.md](DEPLOYMENT.md) - 部署指南
- [DISTRIBUTED_DEPLOYMENT.md](DISTRIBUTED_DEPLOYMENT.md) - 分布式部署
- [USAGE_GUIDE.md](USAGE_GUIDE.md) - Per-URL 配置详解
- [TEST_RECORDS_GUIDE.md](TEST_RECORDS_GUIDE.md) - 测试记录详解
- [PERFCAT_INTEGRATION.md](PERFCAT_INTEGRATION.md) - Perfcat 集成
- [PRESET_SYSTEM_GUIDE.md](PRESET_SYSTEM_GUIDE.md) - 预设系统
- [WORKER_SELECTION_STRATEGY.md](WORKER_SELECTION_STRATEGY.md) - Worker 选择策略

## 总结

本平台提供了完整的性能测试解决方案：

- ✅ 可视化管理测试用例
- ✅ 支持多种测试类型
- ✅ 分布式执行和批量分发
- ✅ 完整的测试记录和历史
- ✅ 丰富的高级配置选项
- ✅ Perfcat 集成和数据可视化

按照本指南使用，可以高效地进行性能测试和分析。
