# 并行执行功能说明

## 🎯 问题修复

### 修复前
- 选择多个测试用例后点击"运行选中"，任务**串行执行**（一个接一个）
- 使用队列模式：`runningQueue`，等待前一个任务完成才执行下一个
- 无法利用服务器的并发能力

### 修复后
- 选择多个测试用例后点击"⚡ 并行运行"，所有任务**同时提交**到服务器
- 使用 `Promise.allSettled()` 并行发起所有请求
- 服务器端自动管理并发（最多10个任务同时运行）
- 超过并发限制的任务会自动进入队列等待

## 🚀 使用方法

1. **选择测试用例**：勾选要执行的测试用例
2. **点击并行运行**：点击 "⚡ 并行运行 (N)" 按钮
3. **确认执行**：系统会提示将并行执行N个任务
4. **查看进度**：在"输出日志"区域查看提交进度

## 📊 并发控制

### 服务器端并发管理
- **最大并发数**：10个任务同时运行（可在 `server/index.ts:258` 修改）
- **自动排队**：超过并发数的任务自动进入等待状态
- **智能调度**：任务完成后自动启动下一个待执行任务

### 前端行为
```javascript
// 并行提交所有选中的任务
const results = await Promise.allSettled(
    selectedArray.map(id => runCase(id))
);
```

## 🔧 技术细节

### 后端改进 (server/index.ts)

1. **改进报告文件匹配逻辑**
   - 按任务启动时间过滤报告文件
   - 避免并行任务间的文件冲突

2. **添加超时保护**
   - 30分钟超时自动终止
   - 防止任务无限挂起

3. **优先清理配置文件**
   - 在处理报告前先删除配置文件
   - 确保即使后续逻辑出错也能清理

4. **增强日志输出**
   - 🔔 进程关闭事件
   - 🗑️ 配置文件清理状态
   - 📂 报告文件搜索结果

### 前端改进 (public/index.html)

1. **并行执行逻辑**
   ```javascript
   async function runSelectedCases() {
       // 并行提交所有任务
       const results = await Promise.allSettled(
           selectedArray.map(id => runCase(id))
       );
   }
   ```

2. **动态获取并发限制**
   ```javascript
   const tasksResponse = await fetch('/api/tasks');
   const tasksData = await tasksResponse.json();
   serverMaxConcurrent = tasksData.maxConcurrent || 10;
   ```

3. **改进用户提示**
   - 显示并发限制
   - 提示排队信息
   - 显示提交进度

## 📝 示例输出

```
========== 批量并行执行开始 ==========
[系统] 提交 5 个测试用例
[系统] 服务器并发限制: 10 个
[1/5] 提交任务: B站首页 - 基础性能测试
[2/5] 提交任务: B站视频页 - Runtime性能监控
[3/5] 提交任务: B站动态页 - 内存泄漏检测
[4/5] 提交任务: B站直播页 - 综合性能测试
[5/5] 提交任务: B站搜索页 - 性能基准测试
[系统] 批量提交完成，耗时 0.85秒
========== 批量并行执行结束 ==========
```

## ⚙️ 配置参数

### 服务器端配置
```typescript
// server/index.ts:258
const MAX_CONCURRENT_TASKS = 10;  // 修改此值调整并发数
```

### 任务超时配置
```typescript
// server/index.ts:419
const taskTimeout = setTimeout(() => {
    // 超时处理逻辑
}, 30 * 60 * 1000); // 30分钟，可修改
```

## 🐛 故障排查

### 如果任务无法结束
1. 查看服务器日志中的 `🔔 进程关闭事件触发` 日志
2. 检查是否有 `⚠️ 删除配置文件失败` 错误
3. 查看 `📂 找到 X 个有效报告文件` 的数量

### 清理遗留配置文件
```bash
rm -f benchmark.config.task_*.mts
```

### 重置所有任务
访问 `POST /api/reset` 接口强制重置所有任务状态

## 🎉 改进效果

- ✅ 支持真正的并行执行
- ✅ 充分利用服务器资源
- ✅ 更快完成批量测试
- ✅ 自动任务队列管理
- ✅ 详细的执行日志
- ✅ 健壮的错误处理
