# 压测和Benchmark同步执行方案

## 功能说明

实现了压测和Benchmark的并行执行，大大提高了测试效率。当运行一个任务时，压测和Benchmark不再串行执行，而是**同时进行**。

## 实现原理

### 修改前（串行执行）
```
时间 ↓
T0: 开始
T1: 压测完成 (5分钟)
T2: Benchmark运行 (2分钟)
T3: 结束
总耗时: 7分钟
```

### 修改后（并行执行）
```
时间 ↓
T0: 开始
  ├─ 压测开始
  └─ Benchmark开始
T1: 完成（5分钟）
总耗时: max(5分钟, 2分钟) = 5分钟
节省时间: 2分钟
```

## 技术实现

### 核心修改点

**文件**: `server/index.ts`

**修改位置**: `startTask()` 函数中（约第450行）

**关键改动**:
```typescript
// 修改前：阻塞等待压测完成
await handleStressTest(task.rawConfig || task.config, taskId);

// 修改后：后台并行运行
handleStressTest(task.rawConfig || task.config, taskId)
    .catch(error => console.error(`[StressTest] ❌ 后台压测失败: ${(error as Error).message}`));
```

### 工作流程

1. **配置生成** → 创建临时的 `.mts` 配置文件
2. **任务消息** → 输出"启动压测和Benchmark同步执行"的提示
3. **压测启动** → 后台异步启动压测（非阻塞）
4. **Benchmark启动** → 立即启动Benchmark（不等待压测）
5. **并行运行** → 两个任务同时进行
6. **完成处理** → Benchmark完成后进行报告上传等后续处理

## 日志输出示例

```
============================================================
🚀 启动压测和Benchmark同步执行
============================================================

[并行运行中...]

============================================================
🚀 启动压测模拟
============================================================
URL:        https://www.bilibili.com
房间号:     123456
UID:        987654
广播数量:   5
默认QPS:    100
默认时长:   60秒

[压测进行中...]

[同时，Benchmark也在运行...]

============================================================
✅ 任务完成
============================================================
```

## 性能提升

### 典型场景
- 压测时长: 60秒
- Benchmark时长: 120秒
- **提升前**: 60 + 120 = 180秒
- **提升后**: max(60, 120) = 120秒
- **提升幅度**: 33%

### 极端场景
- 压测时长: 300秒 (5分钟)
- Benchmark时长: 180秒 (3分钟)
- **提升前**: 300 + 180 = 480秒
- **提升后**: max(300, 180) = 300秒
- **提升幅度**: 37.5%

## 错误处理

即使压测失败，Benchmark仍然会继续执行：
```
[StressTest] ❌ 后台压测失败: 网络连接错误
[Benchmark] ✅ Benchmark执行成功
```

这确保了即使压测环节出现问题，不会影响性能测试的进行。

## 前端展示

用户可以在输出日志面板看到两个任务的实时进展：

1. **压测进度**: 显示关播、开播、压测启动等步骤
2. **Benchmark进度**: 显示Runtime、LongTask等各项指标的采集进度
3. **完成通知**: 两个任务完成时分别显示完成提示

## 配置要求

无需修改任何配置，此功能对用户完全透明。现有的所有压测和Benchmark配置继续有效。

## 后续优化方向

1. **进度显示**: 可以在UI上显示两个任务的并行进度条
2. **超时管理**: 分别为压测和Benchmark设置不同的超时时间
3. **资源隔离**: 进一步优化并发资源分配
4. **错误隔离**: 更细粒度的错误恢复机制

## 测试验证

要验证此功能：

1. 创建一个包含压测配置的Benchmark用例
2. 运行该用例
3. 观察输出日志，确认"启动压测和Benchmark同步执行"提示出现
4. 验证总运行时间符合并行执行的预期

## 相关代码

- **压测处理**: `handleStressTest()` 函数（约第2115行）
- **任务启动**: `startTask()` 函数（约第411行）
- **配置生成**: `generateConfig()` 函数
- **Webhook通知**: 任务完成后触发
