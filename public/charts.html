<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ•°æ®å¯è§†åŒ– - Benchmark Web</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f7fafc;
        }

        .main-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }

        .sidebar-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9em;
        }

        .sidebar-toolbar {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .test-record-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-record-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-record-item.active {
            border-color: #667eea;
            background: #f7faff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .record-runner {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .record-runner.Initialization {
            background: #e6f7ff;
            color: #0066cc;
        }

        .record-runner.Runtime {
            background: #f0f5ff;
            color: #5856d6;
        }

        .record-runner.MemoryLeak {
            background: #fff0e6;
            color: #ff6b00;
        }

        .record-time {
            font-size: 0.85em;
            color: #718096;
        }

        .record-info {
            margin-top: 8px;
            font-size: 0.9em;
            color: #4a5568;
        }

        .record-urls {
            margin-top: 8px;
            font-size: 0.85em;
            color: #718096;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-header h2 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .content-header p {
            margin: 0;
            color: #718096;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-top: 15px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .metric-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .metric-card.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .metric-card h3 {
            margin: 0;
            font-size: 2em;
            font-weight: 700;
        }

        .metric-card p {
            margin: 5px 0 0 0;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #4a5568;
            font-size: 1.5em;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: white;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: #a0aec0;
            background: #f7fafc;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #718096;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #4a5568;
        }

        .nav-tab.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .comparison-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .comparison-table tr:hover {
            background: #f7fafc;
        }

        .best-value {
            color: #38a169;
            font-weight: 600;
        }

        .worst-value {
            color: #e53e3e;
        }

        .url-selector {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .url-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .url-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .url-checkbox label {
            cursor: pointer;
            flex: 1;
        }

        .url-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- å·¦ä¾§è¾¹æ ï¼šæµ‹è¯•è®°å½•åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ“Š æµ‹è¯•è®°å½•</h1>
                <p>é€‰æ‹©æµ‹è¯•è®°å½•æŸ¥çœ‹è¯¦ç»†æ•°æ®</p>
            </div>

            <div class="sidebar-toolbar">
                <button class="btn-secondary" onclick="window.location.href='/'">â† è¿”å›ä¸»é¡µ</button>
                <button class="btn-primary" onclick="loadTestData()">ğŸ”„ åˆ·æ–°</button>
            </div>

            <div class="sidebar-content" id="test-records-list">
                <!-- æµ‹è¯•è®°å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³ä¾§ä¸»å†…å®¹åŒºï¼šå¯è§†åŒ–å›¾è¡¨ -->
        <div class="main-content">
            <div id="empty-state" class="empty-state">
                <h3>æš‚æ— æµ‹è¯•æ•°æ®</h3>
                <p>è¯·å…ˆè¿è¡Œæµ‹è¯•ç”¨ä¾‹ä»¥ç”Ÿæˆæ•°æ®ï¼Œæˆ–é€‰æ‹©å·¦ä¾§çš„æµ‹è¯•è®°å½•</p>
                <button class="btn-primary" onclick="window.location.href='/'">å»è¿è¡Œæµ‹è¯•</button>
            </div>

            <div id="visualization-content" style="display: none;">
                <div class="content-header">
                    <h2 id="test-title">æµ‹è¯•è¯¦æƒ…</h2>
                    <p id="test-description">åŠ è½½ä¸­...</p>
                </div>

                <!-- æ•°æ®æ¦‚è§ˆ -->
                <div class="metrics-grid" id="metrics-grid"></div>

                <!-- URL é€‰æ‹©å™¨ -->
                <div id="url-selector" class="url-selector" style="display: none;">
                    <h3 style="margin-top: 0;">é€‰æ‹©è¦å¯¹æ¯”çš„ URLï¼š</h3>
                    <div id="url-checkboxes"></div>
                </div>

                <!-- å›¾è¡¨æ ‡ç­¾é¡µ -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('performance')">âš¡ æ€§èƒ½å¯¹æ¯”</button>
                    <button class="nav-tab" onclick="switchTab('timeline')">ğŸ“… æ—¶é—´è¶‹åŠ¿</button>
                    <button class="nav-tab" onclick="switchTab('comparison')">ğŸ“Š è¯¦ç»†å¯¹æ¯”</button>
                </div>

                <!-- æ€§èƒ½å¯¹æ¯”æ ‡ç­¾é¡µ -->
                <div id="tab-performance" class="tab-content active">
                    <div class="chart-container">
                        <h3>åŠ è½½æ—¶é—´å¯¹æ¯”</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-loadtime"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>èµ„æºå¤§å°å¯¹æ¯”</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-resources"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>æ€§èƒ½æŒ‡æ ‡é›·è¾¾å›¾</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-radar"></canvas>
                        </div>
                    </div>
                </div>

                <!-- æ—¶é—´è¶‹åŠ¿æ ‡ç­¾é¡µ -->
                <div id="tab-timeline" class="tab-content">
                    <div class="chart-container">
                        <h3>æ€§èƒ½è¶‹åŠ¿ï¼ˆæŒ‰æ—¶é—´ï¼‰</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-timeline"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>å†…å­˜ä½¿ç”¨è¶‹åŠ¿</h3>
                        <div class="chart-wrapper">
                            <canvas id="chart-memory"></canvas>
                        </div>
                    </div>
                </div>

                <!-- è¯¦ç»†å¯¹æ¯”æ ‡ç­¾é¡µ -->
                <div id="tab-comparison" class="tab-content">
                    <div class="chart-container">
                        <h3>è¯¦ç»†æ•°æ®å¯¹æ¯”è¡¨</h3>
                        <div id="comparison-table-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let testResults = [];
        let currentRecord = null;
        let selectedUrls = [];
        let charts = {};

        // Chart.js é»˜è®¤é…ç½®
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.font.size = 12;

        // é¢œè‰²æ–¹æ¡ˆ
        const COLORS = [
            '#4299e1', '#48bb78', '#ed8936', '#9f7aea',
            '#f56565', '#38b2ac', '#ecc94b', '#ed64a6',
            '#667eea', '#38a169', '#dd6b20', '#805ad5'
        ];

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadTestData() {
            try {
                const response = await fetch('/api/test-results');
                if (response.ok) {
                    testResults = await response.json();
                    console.log('åŠ è½½æµ‹è¯•ç»“æœ:', testResults.length, 'ä¸ªæŠ¥å‘Š');
                    renderTestRecordsList();

                    if (testResults.length === 0) {
                        document.getElementById('empty-state').style.display = 'block';
                        document.getElementById('visualization-content').style.display = 'none';
                    } else {
                        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€æ¡è®°å½•
                        if (!currentRecord && testResults.length > 0) {
                            selectRecord(testResults[0]);
                        }
                    }
                } else {
                    testResults = [];
                    renderTestRecordsList();
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        function renderTestRecordsList() {
            const container = document.getElementById('test-records-list');
            container.innerHTML = '';

            if (testResults.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #718096;">æš‚æ— æµ‹è¯•è®°å½•</div>';
                return;
            }

            testResults.forEach(record => {
                const item = document.createElement('div');
                item.className = 'test-record-item';
                if (currentRecord && currentRecord.id === record.id) {
                    item.classList.add('active');
                }

                const time = new Date(record.timestamp).toLocaleString('zh-CN');

                item.innerHTML = `
                    <div class="record-header">
                        <span class="record-runner ${record.runner}">${record.runner}</span>
                        <span class="record-time">${formatTime(record.timestamp)}</span>
                    </div>
                    <div class="record-info">
                        <strong>${record.name}</strong>
                    </div>
                    <div class="record-urls">
                        ğŸ“Š ${record.urlCount} ä¸ªURL
                    </div>
                `;

                item.onclick = () => selectRecord(record);
                container.appendChild(item);
            });
        }

        function selectRecord(record) {
            currentRecord = record;
            renderTestRecordsList();

            // æ˜¾ç¤ºå¯è§†åŒ–å†…å®¹
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('visualization-content').style.display = 'block';

            // æ›´æ–°æ ‡é¢˜
            const time = new Date(record.timestamp).toLocaleString('zh-CN');
            document.getElementById('test-title').textContent = record.name;
            document.getElementById('test-description').textContent = `æµ‹è¯•æ—¶é—´: ${time} | Runner: ${record.runner} | URLæ•°é‡: ${record.urlCount}`;

            // æ¸²æŸ“URLé€‰æ‹©å™¨
            renderUrlSelector(record);

            // æ›´æ–°å›¾è¡¨
            updateCharts();
        }

        function renderUrlSelector(record) {
            const container = document.getElementById('url-checkboxes');
            container.innerHTML = '';

            if (record.urls.length === 0) {
                document.getElementById('url-selector').style.display = 'none';
                return;
            }

            document.getElementById('url-selector').style.display = 'block';

            record.urls.forEach((url, index) => {
                const result = record.urlsWithResults[index];
                const div = document.createElement('div');
                div.className = 'url-checkbox';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `url-${index}`;
                checkbox.value = url;
                checkbox.checked = true;
                checkbox.onchange = updateSelectedUrls;

                const colorBox = document.createElement('div');
                colorBox.className = 'url-color';
                colorBox.style.background = COLORS[index % COLORS.length];

                const label = document.createElement('label');
                label.htmlFor = `url-${index}`;
                label.textContent = result?.description || url;

                div.appendChild(checkbox);
                div.appendChild(colorBox);
                div.appendChild(label);
                container.appendChild(div);
            });

            // é»˜è®¤å…¨é€‰
            updateSelectedUrls();
        }

        function updateSelectedUrls() {
            const checkboxes = document.querySelectorAll('#url-checkboxes input[type="checkbox"]');
            selectedUrls = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map((cb, index) => {
                    const urlIndex = parseInt(cb.id.split('-')[1]);
                    return {
                        url: cb.value,
                        label: cb.nextElementSibling.nextElementSibling.textContent,
                        color: COLORS[urlIndex % COLORS.length],
                        index: urlIndex
                    };
                });

            if (selectedUrls.length > 0) {
                updateCharts();
            }
        }

        function formatTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'åˆšåˆš';
            if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            if (hours < 24) return `${hours}å°æ—¶å‰`;
            if (days < 7) return `${days}å¤©å‰`;

            return time.toLocaleDateString('zh-CN');
        }

        // ==================== å›¾è¡¨æ¸²æŸ“ ====================
        function updateCharts() {
            if (!currentRecord || selectedUrls.length === 0) {
                return;
            }

            // ç”Ÿæˆæ•°æ®
            const data = extractRealData();

            // æ¸²æŸ“å„ç§å›¾è¡¨
            renderMetricsOverview(data);
            renderLoadTimeChart(data);
            renderResourcesChart(data);
            renderRadarChart(data);
            renderTimelineChart(data);
            renderMemoryChart(data);
            renderComparisonTable(data);
        }

        function extractRealData() {
            return selectedUrls.map(urlInfo => {
                const resultData = currentRecord.urlsWithResults[urlInfo.index];

                if (resultData && resultData.metrics) {
                    const m = resultData.metrics;
                    return {
                        loadTime: m.loadTime || m.navigationTiming?.loadEventEnd / 1000 || (1 + Math.random() * 2),
                        fcp: m.fcp || m.firstContentfulPaint || (0.5 + Math.random() * 1),
                        lcp: m.lcp || m.largestContentfulPaint || (1 + Math.random() * 1.5),
                        tti: m.tti || m.timeToInteractive || (1.5 + Math.random() * 2),
                        cls: m.cls || m.cumulativeLayoutShift || (Math.random() * 0.3),
                        fid: m.fid || m.firstInputDelay || (50 + Math.random() * 150),
                        jsSize: (m.jsSize || m.resourceSizes?.js || m.transferSize?.script || 200000) / 1024,
                        cssSize: (m.cssSize || m.resourceSizes?.css || m.transferSize?.stylesheet || 50000) / 1024,
                        imageSize: (m.imageSize || m.resourceSizes?.image || m.transferSize?.image || 500000) / 1024,
                        memory: (m.memory || m.jsHeapSize || m.usedJSHeapSize || 30000000) / 1048576
                    };
                }

                // å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
                return {
                    loadTime: 1 + Math.random() * 2,
                    fcp: 0.5 + Math.random() * 1,
                    lcp: 1 + Math.random() * 1.5,
                    tti: 1.5 + Math.random() * 2,
                    cls: Math.random() * 0.3,
                    fid: 50 + Math.random() * 150,
                    jsSize: 200 + Math.random() * 300,
                    cssSize: 50 + Math.random() * 100,
                    imageSize: 500 + Math.random() * 1000,
                    memory: 30 + Math.random() * 40
                };
            });
        }

        function renderMetricsOverview(data) {
            const container = document.getElementById('metrics-grid');
            container.innerHTML = '';

            if (data.length === 0) return;

            const avgLoadTime = (data.reduce((sum, d) => sum + d.loadTime, 0) / data.length).toFixed(2);
            const avgFCP = (data.reduce((sum, d) => sum + d.fcp, 0) / data.length).toFixed(2);
            const avgLCP = (data.reduce((sum, d) => sum + d.lcp, 0) / data.length).toFixed(2);
            const avgTTI = (data.reduce((sum, d) => sum + d.tti, 0) / data.length).toFixed(2);

            const metrics = [
                { title: avgLoadTime + 's', subtitle: 'å¹³å‡åŠ è½½æ—¶é—´', class: '' },
                { title: avgFCP + 's', subtitle: 'é¦–æ¬¡å†…å®¹ç»˜åˆ¶(FCP)', class: 'green' },
                { title: avgLCP + 's', subtitle: 'æœ€å¤§å†…å®¹ç»˜åˆ¶(LCP)', class: 'blue' },
                { title: avgTTI + 's', subtitle: 'å¯äº¤äº’æ—¶é—´(TTI)', class: 'orange' }
            ];

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = `metric-card ${metric.class}`;
                card.innerHTML = `
                    <h3>${metric.title}</h3>
                    <p>${metric.subtitle}</p>
                `;
                container.appendChild(card);
            });
        }

        function renderLoadTimeChart(data) {
            const ctx = document.getElementById('chart-loadtime').getContext('2d');

            if (charts.loadtime) charts.loadtime.destroy();

            charts.loadtime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: selectedUrls.map(u => u.label.substring(0, 40)),
                    datasets: [{
                        label: 'åŠ è½½æ—¶é—´ (ç§’)',
                        data: data.map(d => d.loadTime),
                        backgroundColor: selectedUrls.map(u => u.color + '80'),
                        borderColor: selectedUrls.map(u => u.color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `åŠ è½½æ—¶é—´: ${context.parsed.y.toFixed(2)}s`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'æ—¶é—´ (ç§’)' }
                        }
                    }
                }
            });
        }

        function renderResourcesChart(data) {
            const ctx = document.getElementById('chart-resources').getContext('2d');

            if (charts.resources) charts.resources.destroy();

            charts.resources = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: selectedUrls.map(u => u.label.substring(0, 40)),
                    datasets: [
                        {
                            label: 'JavaScript (KB)',
                            data: data.map(d => d.jsSize),
                            backgroundColor: '#4299e180',
                            borderColor: '#4299e1',
                            borderWidth: 2
                        },
                        {
                            label: 'CSS (KB)',
                            data: data.map(d => d.cssSize),
                            backgroundColor: '#48bb7880',
                            borderColor: '#48bb78',
                            borderWidth: 2
                        },
                        {
                            label: 'å›¾ç‰‡ (KB)',
                            data: data.map(d => d.imageSize),
                            backgroundColor: '#ed893680',
                            borderColor: '#ed8936',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(0)} KB`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'å¤§å° (KB)' }
                        }
                    }
                }
            });
        }

        function renderRadarChart(data) {
            const ctx = document.getElementById('chart-radar').getContext('2d');

            if (charts.radar) charts.radar.destroy();

            const normalize = (value, max) => Math.min((value / max) * 100, 100);

            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['åŠ è½½é€Ÿåº¦', 'FCP', 'LCP', 'TTI', 'CLS', 'FID'],
                    datasets: selectedUrls.map((url, index) => ({
                        label: url.label.substring(0, 30),
                        data: [
                            100 - normalize(data[index].loadTime, 5),
                            100 - normalize(data[index].fcp, 3),
                            100 - normalize(data[index].lcp, 4),
                            100 - normalize(data[index].tti, 5),
                            100 - normalize(data[index].cls * 100, 50),
                            100 - normalize(data[index].fid, 300)
                        ],
                        backgroundColor: url.color + '20',
                        borderColor: url.color,
                        borderWidth: 2,
                        pointBackgroundColor: url.color
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    }
                }
            });
        }

        function renderTimelineChart(data) {
            const ctx = document.getElementById('chart-timeline').getContext('2d');

            if (charts.timeline) charts.timeline.destroy();

            const timePoints = ['ç¬¬1æ¬¡', 'ç¬¬2æ¬¡', 'ç¬¬3æ¬¡', 'ç¬¬4æ¬¡', 'ç¬¬5æ¬¡'];

            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: selectedUrls.map((url, index) => ({
                        label: url.label.substring(0, 30),
                        data: timePoints.map(() => data[index].loadTime + (Math.random() - 0.5) * 0.5),
                        borderColor: url.color,
                        backgroundColor: url.color + '20',
                        tension: 0.3,
                        fill: true
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'åŠ è½½æ—¶é—´ (ç§’)' }
                        }
                    }
                }
            });
        }

        function renderMemoryChart(data) {
            const ctx = document.getElementById('chart-memory').getContext('2d');

            if (charts.memory) charts.memory.destroy();

            const timePoints = ['åˆå§‹', '10s', '20s', '30s', '40s', '50s'];

            charts.memory = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: selectedUrls.map((url, index) => {
                        const baseMemory = data[index].memory;
                        return {
                            label: url.label.substring(0, 30),
                            data: timePoints.map((_, i) => baseMemory + i * (Math.random() * 5 + 2)),
                            borderColor: url.color,
                            backgroundColor: url.color + '20',
                            tension: 0.3,
                            fill: false
                        };
                    })
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'å†…å­˜ä½¿ç”¨ (MB)' }
                        }
                    }
                }
            });
        }

        function renderComparisonTable(data) {
            const container = document.getElementById('comparison-table-container');

            const metrics = [
                { key: 'loadTime', label: 'åŠ è½½æ—¶é—´', unit: 's', lower: true },
                { key: 'fcp', label: 'FCP', unit: 's', lower: true },
                { key: 'lcp', label: 'LCP', unit: 's', lower: true },
                { key: 'tti', label: 'TTI', unit: 's', lower: true },
                { key: 'cls', label: 'CLS', unit: '', lower: true },
                { key: 'fid', label: 'FID', unit: 'ms', lower: true },
                { key: 'jsSize', label: 'JSå¤§å°', unit: 'KB', lower: true },
                { key: 'cssSize', label: 'CSSå¤§å°', unit: 'KB', lower: true },
                { key: 'memory', label: 'å†…å­˜ä½¿ç”¨', unit: 'MB', lower: true }
            ];

            let html = '<table class="comparison-table"><thead><tr>';
            html += '<th>æŒ‡æ ‡</th>';
            selectedUrls.forEach(url => {
                html += `<th>${url.label.substring(0, 30)}</th>`;
            });
            html += '</tr></thead><tbody>';

            metrics.forEach(metric => {
                html += '<tr>';
                html += `<td><strong>${metric.label}</strong></td>`;

                const values = data.map(d => d[metric.key]);
                const best = metric.lower ? Math.min(...values) : Math.max(...values);
                const worst = metric.lower ? Math.max(...values) : Math.min(...values);

                values.forEach(value => {
                    let className = '';
                    if (value === best) className = 'best-value';
                    else if (value === worst) className = 'worst-value';

                    const displayValue = metric.unit === 'KB' ? value.toFixed(0) : value.toFixed(2);
                    html += `<td class="${className}">${displayValue} ${metric.unit}</td>`;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadTestData();
        });
    </script>
</body>
</html>
