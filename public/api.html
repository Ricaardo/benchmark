<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ç®¡ç† & æ–‡æ¡£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e57373;
            color: white;
        }

        .btn-secondary {
            background: #90a4ae;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        input[type="text"], input[type="url"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        .api-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .endpoint {
            background: #f0f7ff;
            padding: 15px;
            border-left: 4px solid #667eea;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85em;
            margin-right: 10px;
        }

        .method.post { background: #4caf50; color: white; }
        .method.get { background: #2196f3; color: white; }
        .method.delete { background: #f44336; color: white; }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 4px solid #81c784; }
        .toast.error { border-left: 4px solid #e57373; }
        .toast.warning { border-left: 4px solid #ffa726; }
        .toast.info { border-left: 4px solid #64b5f6; }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <div class="container">
        <div class="header">
            <h1>ğŸ”Œ API ç®¡ç† & æ–‡æ¡£</h1>
            <p>å¤–éƒ¨æ¥å£é›†æˆä¸è‡ªåŠ¨åŒ–</p>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/" style="padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 6px; font-weight: 600; margin: 0 5px; display: inline-block;">ğŸ  æ§åˆ¶å°</a>
            <a href="/config.html" style="padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 6px; font-weight: 600; margin: 0 5px; display: inline-block;">âš™ï¸ é…ç½®ç®¡ç†</a>
        </div>

        <!-- APIå¯†é’¥ç®¡ç† -->
        <div class="card">
            <h2>ğŸ”‘ API å¯†é’¥ç®¡ç†</h2>
            <p style="color: #666; margin-bottom: 15px;">ç”Ÿæˆå’Œç®¡ç†APIå¯†é’¥ï¼Œç”¨äºå¤–éƒ¨ç³»ç»Ÿè°ƒç”¨æ¥å£</p>

            <div id="api-keys-list" style="margin-bottom: 15px;">
                <p style="color: #999;">åŠ è½½ä¸­...</p>
            </div>

            <button class="btn-primary" onclick="generateApiKey()">â• ç”Ÿæˆæ–°å¯†é’¥</button>
        </div>

        <!-- Webhooké…ç½® -->
        <div class="card">
            <h2>ğŸ”” Webhook é…ç½®</h2>
            <p style="color: #666; margin-bottom: 15px;">é…ç½®Webhook URLï¼Œæµ‹è¯•å®Œæˆæ—¶è‡ªåŠ¨å‘é€é€šçŸ¥</p>

            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Webhook URL</label>
            <input type="url" id="webhook-url" placeholder="https://your-server.com/webhook" style="margin-bottom: 10px;">

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="saveWebhook()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button class="btn-secondary" onclick="testWebhook()">ğŸ§ª æµ‹è¯•Webhook</button>
            </div>

            <div style="margin-top: 15px; padding: 12px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 4px; font-size: 0.9em;">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>Webhookå°†åœ¨æµ‹è¯•å¼€å§‹å’Œå®Œæˆæ—¶å‘é€POSTè¯·æ±‚åˆ°æŒ‡å®šURLï¼ŒåŒ…å«æµ‹è¯•çŠ¶æ€å’Œç»“æœä¿¡æ¯ã€‚
            </div>
        </div>

        <!-- APIæ–‡æ¡£ -->
        <div class="card">
            <h2>ğŸ“š API æ¥å£æ–‡æ¡£</h2>
            <p style="color: #666; margin-bottom: 15px;">æ‰€æœ‰APIæ¥å£éƒ½éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å« <code>X-API-Key</code></p>

            <!-- å¯åŠ¨æµ‹è¯• -->
            <div class="endpoint">
                <div style="margin-bottom: 10px;">
                    <span class="method post">POST</span>
                    <code>/api/v1/test/start</code>
                </div>
                <p style="margin-bottom: 10px;"><strong>æè¿°ï¼š</strong>å¯åŠ¨æµ‹è¯•</p>
                <p style="margin-bottom: 10px;"><strong>è¯·æ±‚ä½“ï¼š</strong></p>
                <pre>{
  "runner": "Runtime",
  "config": {  // å¯é€‰ï¼Œä¸æä¾›åˆ™ä½¿ç”¨å½“å‰é…ç½®
    "mode": { "anonymous": true, "headless": true },
    "runners": {
      "Runtime": {
        "enabled": true,
        "durationMs": 60000,
        "delayMs": 5000,
        "testCases": [
          {
            "target": "https://www.bilibili.com",
            "description": "Bç«™é¦–é¡µ"
          }
        ]
      }
    }
  }
}</pre>
                <p style="margin-top: 10px;"><strong>cURL ç¤ºä¾‹ï¼š</strong></p>
                <pre>curl -X POST http://localhost:3000/api/v1/test/start \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"runner":"Runtime"}'</pre>
            </div>

            <!-- è·å–çŠ¶æ€ -->
            <div class="endpoint">
                <div style="margin-bottom: 10px;">
                    <span class="method get">GET</span>
                    <code>/api/v1/test/status</code>
                </div>
                <p style="margin-bottom: 10px;"><strong>æè¿°ï¼š</strong>è·å–å½“å‰æµ‹è¯•çŠ¶æ€</p>
                <p style="margin-bottom: 10px;"><strong>cURL ç¤ºä¾‹ï¼š</strong></p>
                <pre>curl -X GET http://localhost:3000/api/v1/test/status \
  -H "X-API-Key: YOUR_API_KEY"</pre>
            </div>

            <!-- åœæ­¢æµ‹è¯• -->
            <div class="endpoint">
                <div style="margin-bottom: 10px;">
                    <span class="method post">POST</span>
                    <code>/api/v1/test/stop</code>
                </div>
                <p style="margin-bottom: 10px;"><strong>æè¿°ï¼š</strong>åœæ­¢å½“å‰æµ‹è¯•</p>
                <p style="margin-bottom: 10px;"><strong>cURL ç¤ºä¾‹ï¼š</strong></p>
                <pre>curl -X POST http://localhost:3000/api/v1/test/stop \
  -H "X-API-Key: YOUR_API_KEY"</pre>
            </div>

            <!-- è·å–æŠ¥å‘Š -->
            <div class="endpoint">
                <div style="margin-bottom: 10px;">
                    <span class="method get">GET</span>
                    <code>/api/v1/reports</code>
                </div>
                <p style="margin-bottom: 10px;"><strong>æè¿°ï¼š</strong>è·å–æ‰€æœ‰æµ‹è¯•æŠ¥å‘Šåˆ—è¡¨</p>
                <p style="margin-bottom: 10px;"><strong>cURL ç¤ºä¾‹ï¼š</strong></p>
                <pre>curl -X GET http://localhost:3000/api/v1/reports \
  -H "X-API-Key: YOUR_API_KEY"</pre>
            </div>
        </div>

        <!-- Webhookäº‹ä»¶ -->
        <div class="card">
            <h2>ğŸ”” Webhook äº‹ä»¶</h2>
            <p style="color: #666; margin-bottom: 15px;">Webhookå°†å‘é€ä»¥ä¸‹äº‹ä»¶é€šçŸ¥</p>

            <div class="endpoint">
                <p style="margin-bottom: 10px;"><strong>test_started</strong> - æµ‹è¯•å¼€å§‹æ—¶</p>
                <pre>{
  "event": "test_started",
  "timestamp": "2025-11-06T10:30:00.000Z",
  "data": {
    "runner": "Runtime",
    "startTime": "2025-11-06T10:30:00.000Z"
  }
}</pre>
            </div>

            <div class="endpoint">
                <p style="margin-bottom: 10px;"><strong>test_completed</strong> - æµ‹è¯•å®Œæˆæ—¶</p>
                <pre>{
  "event": "test_completed",
  "timestamp": "2025-11-06T10:35:00.000Z",
  "data": {
    "runner": "Runtime",
    "status": "completed",
    "exitCode": 0,
    "output": "... (æœ€å1000å­—ç¬¦)"
  }
}</pre>
            </div>
        </div>

        <!-- CI/CDé›†æˆç¤ºä¾‹ -->
        <div class="card">
            <h2>ğŸ”„ CI/CD é›†æˆç¤ºä¾‹</h2>

            <h3 style="margin: 15px 0 10px 0;">GitHub Actions</h3>
            <pre>name: Performance Test
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Benchmark Test
        run: |
          curl -X POST ${{ secrets.BENCHMARK_URL }}/api/v1/test/start \
            -H "X-API-Key: ${{ secrets.BENCHMARK_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"runner":"Runtime"}'

          # ç­‰å¾…æµ‹è¯•å®Œæˆ
          while true; do
            STATUS=$(curl -s -H "X-API-Key: ${{ secrets.BENCHMARK_API_KEY }}" \
              ${{ secrets.BENCHMARK_URL }}/api/v1/test/status | jq -r '.status')
            if [ "$STATUS" != "running" ]; then break; fi
            sleep 10
          done

          echo "Test completed with status: $STATUS"</pre>

            <h3 style="margin: 15px 0 10px 0;">Jenkins Pipeline</h3>
            <pre>pipeline {
    agent any
    environment {
        API_KEY = credentials('benchmark-api-key')
        BENCHMARK_URL = 'http://benchmark-server:3000'
    }
    stages {
        stage('Performance Test') {
            steps {
                script {
                    sh """
                        curl -X POST ${BENCHMARK_URL}/api/v1/test/start \
                            -H "X-API-Key: ${API_KEY}" \
                            -H "Content-Type: application/json" \
                            -d '{"runner":"Runtime"}'
                    """
                }
            }
        }
    }
}</pre>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.origin}/api`;

        // Toasté€šçŸ¥
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // åŠ è½½APIå¯†é’¥åˆ—è¡¨
        async function loadApiKeys() {
            try {
                const response = await fetch(`${API_BASE}/keys`);
                const data = await response.json();

                const container = document.getElementById('api-keys-list');

                if (data.keys.length === 0) {
                    container.innerHTML = '<p style="color: #999;">æš‚æ— APIå¯†é’¥ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆ</p>';
                    return;
                }

                container.innerHTML = data.keys.map(key => `
                    <div class="api-key-item">
                        <div>
                            <code style="font-weight: 600;">${key.preview}</code>
                            <button class="btn-secondary btn-small" onclick="copyToClipboard('${key.fullKey}')" style="margin-left: 10px;">ğŸ“‹ å¤åˆ¶å®Œæ•´å¯†é’¥</button>
                        </div>
                        <button class="btn-danger btn-small" onclick="deleteApiKey('${key.fullKey}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                `).join('');
            } catch (error) {
                showToast('åŠ è½½APIå¯†é’¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç”Ÿæˆæ–°APIå¯†é’¥
        async function generateApiKey() {
            try {
                const response = await fetch(`${API_BASE}/keys/generate`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('âœ… APIå¯†é’¥å·²ç”Ÿæˆ', 'success');
                    await loadApiKeys();

                    // æ˜¾ç¤ºå®Œæ•´å¯†é’¥
                    alert(`æ–°çš„APIå¯†é’¥ï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼‰ï¼š\n\n${data.apiKey}`);
                } else {
                    showToast('ç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤APIå¯†é’¥
        async function deleteApiKey(key) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿä½¿ç”¨è¯¥å¯†é’¥çš„åº”ç”¨å°†æ— æ³•ç»§ç»­è®¿é—®ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/keys/${key}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('âœ… APIå¯†é’¥å·²åˆ é™¤', 'success');
                    await loadApiKeys();
                } else {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showToast('âŒ å¤åˆ¶å¤±è´¥', 'error');
            });
        }

        // åŠ è½½Webhooké…ç½®
        async function loadWebhookConfig() {
            try {
                const response = await fetch(`${API_BASE}/webhook`);
                const data = await response.json();

                document.getElementById('webhook-url').value = data.webhookUrl || '';
            } catch (error) {
                console.error('åŠ è½½Webhooké…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜Webhooké…ç½®
        async function saveWebhook() {
            const url = document.getElementById('webhook-url').value.trim();

            try {
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();

                if (data.success) {
                    showToast('âœ… Webhooké…ç½®å·²ä¿å­˜', 'success');
                } else {
                    showToast('âŒ ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•Webhook
        async function testWebhook() {
            try {
                const response = await fetch(`${API_BASE}/webhook/test`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('âœ… Webhookæµ‹è¯•è¯·æ±‚å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ‚¨çš„æœåŠ¡å™¨æ—¥å¿—', 'success');
                } else {
                    showToast('âŒ ' + data.error, 'error');
                }
            } catch (error) {
                showToast('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async () => {
            await loadApiKeys();
            await loadWebhookConfig();
        };
    </script>
</body>
</html>
