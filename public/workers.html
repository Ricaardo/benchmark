<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ‚ç‚¹ç®¡ç† - Benchmark Web Server</title>

    <!-- ç»Ÿä¸€è®¾è®¡ç³»ç»Ÿ -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/navigation.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/enhanced-ui.css">
    <link rel="stylesheet" href="/css/common-components.css">
    <link rel="stylesheet" href="/css/button-fixes.css">
</head>
<body>
    <div class="container">
        <!-- å…¨å±€å¯¼èˆªæ  -->
        <nav class="navbar animate-fade-in-down" id="main-navbar">
            <a href="/" class="navbar-brand">
                <span class="navbar-logo">ğŸš€</span>
                <div>
                    <h1 class="navbar-title">Benchmark Web Runner</h1>
                    <p class="navbar-subtitle">ç”¨ä¾‹é©±åŠ¨çš„æ€§èƒ½æµ‹è¯•å¹³å°</p>
                </div>
            </a>

            <button class="navbar-toggle" id="navbar-toggle" onclick="toggleMobileMenu()">
                <span class="navbar-toggle-bar"></span>
                <span class="navbar-toggle-bar"></span>
                <span class="navbar-toggle-bar"></span>
            </button>

            <div class="navbar-menu" id="navbar-menu">
                <a href="/" class="navbar-item">
                    <span>ğŸ“‹</span> ç”¨ä¾‹ç®¡ç†
                </a>
                <a href="/records.html" class="navbar-item">
                    <span>ğŸ“Š</span> æµ‹è¯•è®°å½•
                </a>
                <a href="/workers.html" class="navbar-item active">
                    <span>ğŸ–¥ï¸</span> èŠ‚ç‚¹ç®¡ç†
                </a>
                <a href="/api.html" class="navbar-item">
                    <span>ğŸ”‘</span> APIç®¡ç†
                </a>
            </div>

            <div class="navbar-actions">
                <button class="btn btn-primary btn-sm" onclick="loadWorkers()">
                    <span>ğŸ”„</span> åˆ·æ–°
                </button>
            </div>
        </nav>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">æ€»èŠ‚ç‚¹æ•°</div>
                <div class="stat-value" id="totalWorkers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">åœ¨çº¿èŠ‚ç‚¹</div>
                <div class="stat-value online" id="onlineWorkers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ‰§è¡Œä¸­</div>
                <div class="stat-value busy" id="busyWorkers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¦»çº¿èŠ‚ç‚¹</div>
                <div class="stat-value offline" id="offlineWorkers">-</div>
            </div>
        </div>

        <div class="workers-grid" id="workersGrid"></div>
    </div>

    <!-- ç¼–è¾‘ Worker æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal-overlay" onclick="closeEditModal(event)" style="display: none;">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.125rem;">âœï¸ ç¼–è¾‘èŠ‚ç‚¹é…ç½®</h3>
                <button type="button" class="btn-icon-close" onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.15s ease;" onmouseover="this.style.background='#f3f4f6'; this.style.color='#374151';" onmouseout="this.style.background='none'; this.style.color='#9ca3af';">Ã—</button>
            </div>
            <form id="editForm" onsubmit="saveWorkerEdit(event)">
                <input type="hidden" id="editWorkerId">

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">èŠ‚ç‚¹åç§°</label>
                    <input type="text" id="editWorkerName" class="form-input" readonly style="background: #f3f4f6; cursor: not-allowed; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">æ€§èƒ½ç­‰çº§</label>
                    <select id="editPerformanceTier" class="form-select" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; font-size: 0.95rem;">
                        <option value="">æœªè®¾ç½®</option>
                        <option value="high">ğŸ”¥ é«˜é…</option>
                        <option value="medium">âš¡ ä¸­é…</option>
                        <option value="low">ğŸ’¡ ä½é…</option>
                        <option value="custom">ğŸ”§ è‡ªå®šä¹‰</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">æœºå™¨æè¿°</label>
                    <input type="text" id="editDescription" class="form-input" placeholder="ä¾‹å¦‚: MacBook Pro M1, 32GB RAM" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                </div>

                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">æœ€å¤§å¹¶å‘æ•° <span style="color: #9ca3af; font-weight: 400; font-size: 0.875rem;">(1-32)</span></label>
                    <input type="number" id="editMaxConcurrency" class="form-input" min="1" max="32" placeholder="é»˜è®¤ä¸º CPU æ ¸å¿ƒæ•°" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                    <small style="display: block; margin-top: 6px; color: #6b7280; font-size: 0.875rem;">ç•™ç©ºåˆ™ä½¿ç”¨CPUæ ¸å¿ƒæ•°ä½œä¸ºé»˜è®¤å€¼</small>
                </div>

                <!-- æµè§ˆå™¨å¯åŠ¨å‚æ•°é…ç½® -->
                <div class="form-group" style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <label class="form-label" style="display: block; margin-bottom: 12px; font-weight: 500; color: #374151;">ğŸ”§ æµè§ˆå™¨å¯åŠ¨å‚æ•°</label>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: #f7fafc; border-radius: 6px;">
                            <input type="checkbox" id="editDisableSandbox" checked>
                            <span style="font-weight: 500; color: #374151;">ç¦ç”¨æ²™ç®±æ¨¡å¼</span>
                        </label>
                        <small style="display: block; margin-top: 6px; margin-left: 4px; color: #6b7280; font-size: 0.875rem;">
                            æ·»åŠ  --no-sandbox å‚æ•°ï¼ˆæ¨èåœ¨ Docker/CI ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰
                        </small>
                    </div>

                    <div>
                        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">è‡ªå®šä¹‰å‚æ•°</label>
                        <textarea id="editChromeArgs" class="form-input" placeholder="æ¯è¡Œä¸€ä¸ªå‚æ•°ï¼Œä¾‹å¦‚ï¼š&#10;--disable-gpu&#10;--window-size=1920,1080" rows="3" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; font-family: monospace; font-size: 0.9em;"></textarea>
                        <small style="display: block; margin-top: 6px; color: #6b7280; font-size: 0.875rem;">
                            å¯é€‰ï¼Œç”¨äºé«˜çº§é…ç½®ã€‚æ¯è¡Œä¸€ä¸ª Chrome å¯åŠ¨å‚æ•°
                        </small>
                    </div>
                </div>

                <div class="form-buttons" style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let ws = null;
        let workers = [];

        // åˆå§‹åŒ–
        async function init() {
            await loadWorkers();
            connectWebSocket();
            startAutoRefresh();
        }

        // åŠ è½½ Workers
        async function loadWorkers() {
            try {
                const res = await fetch('/api/workers');
                const data = await res.json();

                workers = data.workers || [];
                const stats = data.stats || {};

                updateStats(stats);
                renderWorkers();
            } catch (error) {
                console.error('Failed to load workers:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(stats) {
            document.getElementById('totalWorkers').textContent = stats.totalWorkers || 0;
            document.getElementById('onlineWorkers').textContent = stats.onlineWorkers || 0;
            document.getElementById('busyWorkers').textContent = stats.busyWorkers || 0;
            document.getElementById('offlineWorkers').textContent = stats.offlineWorkers || 0;
        }

        // æ¸²æŸ“ Workers
        function renderWorkers() {
            const grid = document.getElementById('workersGrid');

            if (workers.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ—  Worker èŠ‚ç‚¹</div>
                        <p style="color: #999; margin-top: 8px; font-size: 14px;">
                            è¯·åœ¨å…¶ä»–ç”µè„‘ä¸Šå¯åŠ¨ Worker å®¢æˆ·ç«¯
                        </p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = workers.map(worker => `
                <div class="card ${worker.status}">
                    <div class="worker-header">
                        <div class="worker-name">
                            ${worker.name}
                            ${worker.performanceTier ? `<span class="badge ${worker.performanceTier}">${getPerformanceTierName(worker.performanceTier)}</span>` : ''}
                        </div>
                        <div class="worker-actions">
                            <button class="btn btn-primary btn-sm" onclick="openEditModal('${worker.id}')" title="ç¼–è¾‘èŠ‚ç‚¹é…ç½®">
                                <span>âœï¸</span>
                                <span>ç¼–è¾‘</span>
                            </button>
                            ${worker.status === 'offline' ? `
                                <button class="btn btn-danger btn-sm" onclick="deleteWorker('${worker.id}', '${worker.name}')" title="åˆ é™¤ç¦»çº¿èŠ‚ç‚¹">
                                    <span>ğŸ—‘ï¸</span>
                                    <span>åˆ é™¤</span>
                                </button>
                            ` : ''}
                            <span class="worker-status ${worker.status}">${getStatusText(worker.status)}</span>
                        </div>
                    </div>

                    <div class="worker-info">
                        <div class="info-item">
                            <span class="icon">${getPlatformIcon(worker.platform)}</span>
                            <span>${getPlatformName(worker.platform)}</span>
                        </div>
                        <div class="info-item">
                            <span class="icon">ğŸ </span>
                            <span>${worker.host}</span>
                        </div>
                        <div class="info-item">
                            <span class="icon">ğŸ§®</span>
                            <span>${worker.cpuCount} æ ¸</span>
                        </div>
                        <div class="info-item">
                            <span class="icon">ğŸ’¾</span>
                            <span>${worker.memory} GB</span>
                        </div>
                    </div>

                    ${worker.status !== 'offline' ? `
                        <div class="worker-metrics">
                            <div class="metric">
                                <div class="metric-label">CPU ä½¿ç”¨ç‡</div>
                                <div class="metric-value">${(worker.cpuUsage || 0).toFixed(1)}%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill ${getProgressClass(worker.cpuUsage || 0)}"
                                         style="width: ${worker.cpuUsage || 0}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">å†…å­˜ä½¿ç”¨ç‡</div>
                                <div class="metric-value">${(worker.memoryUsage || 0).toFixed(1)}%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill ${getProgressClass(worker.memoryUsage || 0)}"
                                         style="width: ${worker.memoryUsage || 0}%"></div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${worker.currentTask ? `
                        <div class="worker-task">
                            <div class="task-label">å½“å‰ä»»åŠ¡</div>
                            <div class="task-name">${worker.currentTask}</div>
                        </div>
                    ` : worker.status !== 'offline' ? `
                        <div class="worker-task">
                            <div class="task-label">ç©ºé—²ä¸­</div>
                        </div>
                    ` : `
                        <div class="worker-task">
                            <div class="task-label">æœ€åå¿ƒè·³</div>
                            <div class="task-name">${formatTime(worker.lastHeartbeat)}</div>
                        </div>
                    `}
                </div>
            `).join('');
        }

        // è¿æ¥ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);

                if (message.type === 'worker-status-update') {
                    updateWorkerStatus(message.data);
                } else if (message.type === 'worker-offline') {
                    updateWorkerStatus(message.data);
                } else if (message.type === 'workers-list') {
                    workers = message.data.workers || [];
                    renderWorkers();
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected, reconnecting...');
                setTimeout(connectWebSocket, 5000);
            };
        }

        // æ›´æ–° Worker çŠ¶æ€
        function updateWorkerStatus(workerData) {
            const index = workers.findIndex(w => w.id === workerData.id);
            if (index >= 0) {
                workers[index] = { ...workers[index], ...workerData };
            } else {
                workers.push(workerData);
            }
            renderWorkers();
            loadWorkers(); // åˆ·æ–°ç»Ÿè®¡
        }

        // è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            setInterval(() => {
                loadWorkers();
            }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // è¾…åŠ©å‡½æ•°
        function getStatusText(status) {
            const map = {
                online: 'åœ¨çº¿',
                busy: 'æ‰§è¡Œä¸­',
                offline: 'ç¦»çº¿'
            };
            return map[status] || status;
        }

        function getPlatformIcon(platform) {
            const map = {
                win32: 'ğŸªŸ',
                darwin: 'ğŸ',
                linux: 'ğŸ§'
            };
            return map[platform] || 'ğŸ–¥ï¸';
        }

        function getPlatformName(platform) {
            const map = {
                win32: 'Windows',
                darwin: 'macOS',
                linux: 'Linux'
            };
            return map[platform] || platform;
        }

        function getProgressClass(value) {
            if (value > 80) return 'danger';
            if (value > 60) return 'warning';
            return '';
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) return `${hours} å°æ—¶å‰`;
            if (minutes > 0) return `${minutes} åˆ†é’Ÿå‰`;
            return `${seconds} ç§’å‰`;
        }

        function getPerformanceTierName(tier) {
            const map = {
                high: 'ğŸ”¥ é«˜é…',
                medium: 'âš¡ ä¸­é…',
                low: 'ğŸ’¡ ä½é…',
                custom: 'ğŸ”§ è‡ªå®šä¹‰'
            };
            return map[tier] || '';
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;

            document.getElementById('editWorkerId').value = worker.id;
            document.getElementById('editWorkerName').value = worker.name;
            document.getElementById('editPerformanceTier').value = worker.performanceTier || '';
            document.getElementById('editDescription').value = worker.description || '';
            document.getElementById('editMaxConcurrency').value = worker.maxConcurrency || '';

            // åŠ è½½æµè§ˆå™¨å‚æ•°é…ç½®
            const chromeArgs = worker.chromeArgs || [];
            const hasSandbox = chromeArgs.includes('--no-sandbox');
            const otherArgs = chromeArgs.filter(arg => arg !== '--no-sandbox' && arg !== '--disable-setuid-sandbox');

            document.getElementById('editDisableSandbox').checked = hasSandbox;
            document.getElementById('editChromeArgs').value = otherArgs.join('\n');

            const modal = document.getElementById('editModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal(event) {
            if (event && event.target !== event.currentTarget && event.type !== 'click') return;
            const modal = document.getElementById('editModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 200);
        }

        // ä¿å­˜ Worker ç¼–è¾‘
        async function saveWorkerEdit(event) {
            event.preventDefault();

            const workerId = document.getElementById('editWorkerId').value;
            const maxConcurrencyValue = document.getElementById('editMaxConcurrency').value;

            // éªŒè¯æœ€å¤§å¹¶å‘æ•°
            if (maxConcurrencyValue && (parseInt(maxConcurrencyValue) < 1 || parseInt(maxConcurrencyValue) > 32)) {
                Toast.error('æœ€å¤§å¹¶å‘æ•°å¿…é¡»åœ¨1åˆ°32ä¹‹é—´');
                return;
            }

            // æ„å»º chromeArgs æ•°ç»„
            const disableSandbox = document.getElementById('editDisableSandbox').checked;
            const customChromeArgs = document.getElementById('editChromeArgs').value.trim();

            const chromeArgs = [];
            if (disableSandbox) {
                chromeArgs.push('--no-sandbox', '--disable-setuid-sandbox');
            }
            if (customChromeArgs) {
                const customArgs = customChromeArgs.split('\n').map(arg => arg.trim()).filter(arg => arg);
                chromeArgs.push(...customArgs);
            }

            const updates = {
                performanceTier: document.getElementById('editPerformanceTier').value || undefined,
                description: document.getElementById('editDescription').value || undefined,
                maxConcurrency: parseInt(maxConcurrencyValue) || undefined,
                chromeArgs: chromeArgs.length > 0 ? chromeArgs : undefined
            };

            try {
                const response = await fetch(`/api/workers/${workerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.message || errorData.error || `HTTP ${response.status}`;
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                // å…³é—­æ¨¡æ€æ¡†
                closeEditModal();

                // é‡æ–°åŠ è½½æ•°æ®
                await loadWorkers();

                Toast.success('èŠ‚ç‚¹é…ç½®æ›´æ–°æˆåŠŸï¼');
            } catch (error) {
                console.error('Error updating worker:', error);
                Toast.error('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ Worker èŠ‚ç‚¹
        async function deleteWorker(workerId, workerName) {
            const confirmed = await Confirm.show({
                title: 'åˆ é™¤ç¦»çº¿èŠ‚ç‚¹',
                message: `ç¡®å®šè¦åˆ é™¤ç¦»çº¿èŠ‚ç‚¹ "${workerName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
                type: 'danger',
                confirmText: 'åˆ é™¤',
                cancelText: 'å–æ¶ˆ',
                dangerousAction: true
            });

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/workers/${workerId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.message || errorData.error || `HTTP ${response.status}`;
                    throw new Error(errorMessage);
                }

                // é‡æ–°åŠ è½½æ•°æ®
                await loadWorkers();

                Toast.success('èŠ‚ç‚¹åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                console.error('Error deleting worker:', error);
                Toast.error('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨
        init();
    </script>

    <!-- å¯¼èˆªæ äº¤äº’è„šæœ¬ -->
    <script>
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const toggle = document.getElementById('navbar-toggle');
            const menu = document.getElementById('navbar-menu');
            if (toggle && menu) {
                toggle.classList.toggle('active');
                menu.classList.toggle('show');
            }
        }

        // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('main-navbar');
            if (navbar) {
                if (window.scrollY > 20) {
                    navbar.classList.add('navbar-scrolled');
                } else {
                    navbar.classList.remove('navbar-scrolled');
                }
            }
        });
    </script>
    <!-- UIå·¥å…·åº“ -->
    <script src="/js/ui-utils.js"></script>
</body>
</html>
