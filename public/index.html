<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Web Runner - ç”¨ä¾‹ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-secondary:hover {
            background: #718096;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç”¨ä¾‹è¡¨æ ¼ */
        .test-cases-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .test-cases-table thead {
            background: #f7fafc;
        }

        .test-cases-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .test-cases-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .test-cases-table tbody tr:hover {
            background: #f7fafc;
        }

        .test-cases-table .actions {
            display: flex;
            gap: 8px;
        }

        /* ç”¨ä¾‹ç±»å‹æ ‡ç­¾ */
        .runner-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .runner-initialization {
            background: #bee3f8;
            color: #2c5282;
        }

        .runner-runtime {
            background: #c6f6d5;
            color: #22543d;
        }

        .runner-memoryleak {
            background: #fed7d7;
            color: #742a2a;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-idle {
            background: #e2e8f0;
            color: #4a5568;
        }

        .status-running {
            background: #fbd38d;
            color: #7c2d12;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background: #9ae6b4;
            color: #22543d;
        }

        .status-error {
            background: #fc8181;
            color: #742a2a;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* URLæ˜¾ç¤º */
        .url-display {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #4a5568;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* è¾“å‡ºé¢æ¿ */
        .output-panel {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .output-panel::-webkit-scrollbar {
            width: 8px;
        }

        .output-panel::-webkit-scrollbar-track {
            background: #2d3748;
        }

        .output-panel::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Toasté€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2d3748;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: #48bb78;
        }

        .toast.error {
            background: #f56565;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        /* é€‰æ‹©æ¡† */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* å¿«æ·æ“ä½œæç¤º */
        .shortcuts-hint {
            font-size: 0.85em;
            color: #718096;
            margin-top: 10px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left, .toolbar-right {
                width: 100%;
                justify-content: space-between;
            }

            .test-cases-table {
                font-size: 0.9em;
            }

            .url-display {
                max-width: 150px;
            }
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #f7fafc;
            padding: 15px 20px;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Benchmark Web Runner</h1>
            <p class="subtitle">ç”¨ä¾‹é©±åŠ¨çš„æ€§èƒ½æµ‹è¯•å¹³å°</p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-cases">0</div>
                <div class="stat-label">æµ‹è¯•ç”¨ä¾‹æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="running-cases">0</div>
                <div class="stat-label">æ­£åœ¨è¿è¡Œ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completed-today">0</div>
                <div class="stat-label">ä»Šæ—¥å®Œæˆ</div>
            </div>
        </div>

        <!-- ç”¨ä¾‹ç®¡ç†é¢æ¿ -->
        <div class="card">
            <h2>ğŸ“‹ æµ‹è¯•ç”¨ä¾‹ç®¡ç†</h2>

            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn-primary" onclick="showAddCaseModal()">â• æ·»åŠ ç”¨ä¾‹</button>
                    <button class="btn-success" onclick="runSelectedCases()" id="run-selected-btn" disabled>â–¶ è¿è¡Œé€‰ä¸­ (<span id="selected-count">0</span>)</button>
                    <button class="btn-danger btn-small" onclick="deleteSelectedCases()" id="delete-selected-btn" disabled>ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                    <button class="btn-secondary btn-small" onclick="loadPresetCases()">âš¡ åŠ è½½é¢„è®¾</button>
                </div>
                <div class="toolbar-right">
                    <button class="btn-secondary btn-small" onclick="exportCases()">ğŸ“¤ å¯¼å‡º</button>
                    <button class="btn-secondary btn-small" onclick="importCases()">ğŸ“¥ å¯¼å…¥</button>
                    <button class="btn-secondary btn-small" onclick="window.location.href='/api.html'">ğŸ”‘ APIç®¡ç†</button>
                </div>
            </div>

            <div id="cases-container">
                <div class="empty-state">
                    <h3>æš‚æ— æµ‹è¯•ç”¨ä¾‹</h3>
                    <p>ç‚¹å‡»"æ·»åŠ ç”¨ä¾‹"åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹</p>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡é˜Ÿåˆ— -->
        <div class="card" id="queue-card" style="display:none;">
            <h2>ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ—</h2>
            <div id="queue-list" style="margin-top: 15px;"></div>
            <div style="margin-top: 15px;">
                <button class="btn-danger btn-small" onclick="clearQueue()">æ¸…ç©ºé˜Ÿåˆ—</button>
            </div>
        </div>

        <!-- è¿è¡ŒçŠ¶æ€ -->
        <div class="card" id="status-card" style="display:none;">
            <h2>
                ğŸ“Š è¿è¡ŒçŠ¶æ€
                <span class="status-badge" id="current-status">idle</span>
            </h2>
            <div>
                <strong>å½“å‰ç”¨ä¾‹ï¼š</strong><span id="current-case-name">-</span>
            </div>
            <div style="margin-top: 10px;">
                <strong>è¿›åº¦ï¼š</strong><span id="progress-text">0/0</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- è¾“å‡ºé¢æ¿ -->
        <div class="card">
            <h2>ğŸ’» è¾“å‡ºæ—¥å¿—</h2>
            <div class="output-panel" id="output">
                ç­‰å¾…æµ‹è¯•è¿è¡Œ...
            </div>
            <div style="margin-top: 15px;">
                <button class="btn-secondary btn-small" onclick="clearOutput()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn-secondary btn-small" onclick="stopTest()">â¹ åœæ­¢æµ‹è¯•</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç”¨ä¾‹æ¨¡æ€æ¡† -->
    <div class="modal" id="case-modal">
        <div class="modal-content">
            <div class="modal-header">â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹</div>

            <div class="form-group">
                <label>ç”¨ä¾‹åç§° *</label>
                <input type="text" id="case-name" placeholder="ä¾‹å¦‚ï¼šBç«™é¦–é¡µåˆå§‹åŒ–æµ‹è¯•">
            </div>

            <div class="form-group">
                <label>æµ‹è¯•ç±»å‹ *ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div style="background: #f7fafc; padding: 15px; border-radius: 6px; border: 1px solid #cbd5e0;">
                    <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="runner-initialization" style="margin-right: 8px;">
                        <strong>Initialization</strong> - åˆå§‹åŒ–æ€§èƒ½æµ‹è¯•
                    </label>
                    <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="runner-runtime" style="margin-right: 8px;">
                        <strong>Runtime</strong> - è¿è¡Œæ—¶æ€§èƒ½æµ‹è¯•
                    </label>
                    <label style="display: block; margin-bottom: 0; cursor: pointer;">
                        <input type="checkbox" id="runner-memoryleak" style="margin-right: 8px;">
                        <strong>MemoryLeak</strong> - å†…å­˜æ³„æ¼æ£€æµ‹
                    </label>
                </div>
                <small style="color: #718096; font-size: 0.85em; margin-top: 8px; display: block;">å¯ä»¥é€‰æ‹©1ä¸ªæˆ–å¤šä¸ªæµ‹è¯•ç±»å‹ï¼Œå®ƒä»¬å°†åœ¨åŒä¸€ç”¨ä¾‹ä¸­é¡ºåºæ‰§è¡Œ</small>
            </div>

            <div class="form-group">
                <label>æµ‹è¯•URL *ï¼ˆæ¯è¡Œä¸€ä¸ªURLï¼Œæ”¯æŒå¤šä¸ªï¼‰</label>
                <textarea id="case-urls" placeholder="https://www.bilibili.com&#10;https://www.bilibili.com/video/BV1xx411c7mD&#10;https://t.bilibili.com" rows="4"></textarea>
                <small style="color: #718096; font-size: 0.85em;">æ¯è¡Œè¾“å…¥ä¸€ä¸ªURLï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªæµ‹è¯•åœ°å€</small>
            </div>

            <div class="form-group">
                <label>è¿è¡Œæ¨¡å¼</label>
                <select id="case-mode">
                    <option value="headless">Headless - æ— å¤´æ¨¡å¼ï¼ˆåå°è¿è¡Œï¼Œæ€§èƒ½æ›´å¥½ï¼‰</option>
                    <option value="headed">Headed - æœ‰å¤´æ¨¡å¼ï¼ˆæ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢ï¼‰</option>
                </select>
            </div>

            <div class="form-group">
                <label>é‡å¤æ¬¡æ•°</label>
                <input type="number" id="case-repeat" value="3" min="1" max="100">
                <small style="color: #718096; font-size: 0.85em; margin-top: 4px; display: block;">æ‰€æœ‰æµ‹è¯•ç±»å‹å…±ç”¨æ­¤å‚æ•°</small>
            </div>

            <div class="form-group">
                <label>Runner é…ç½®</label>
                <div style="background: #f7fafc; padding: 15px; border-radius: 6px; border: 1px solid #cbd5e0;">

                    <!-- Runtime é…ç½® -->
                    <div id="runtime-config" style="display: none;">
                        <p style="margin-bottom: 10px; font-weight: 600; color: #4a5568;">â±ï¸ Runtime è¿è¡Œæ—¶é…ç½®</p>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">æŒç»­æ—¶é—´ (æ¯«ç§’)</label>
                            <input type="number" id="runtime-duration" value="60000" min="1000" step="1000" style="width: 100%; padding: 8px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤60000ms (60ç§’)</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">å»¶è¿Ÿæ—¶é—´ (æ¯«ç§’)</label>
                            <input type="number" id="runtime-delay" value="10000" min="0" step="1000" style="width: 100%; padding: 8px;">
                            <small style="color: #718096; font-size: 0.85em;">é¡µé¢åŠ è½½åç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤10000ms (10ç§’)</small>
                        </div>
                    </div>

                    <!-- MemoryLeak é…ç½® -->
                    <div id="memoryleak-config" style="display: none;">
                        <p style="margin-bottom: 10px; font-weight: 600; color: #4a5568;">ğŸ§  MemoryLeak å†…å­˜æ³„æ¼é…ç½®</p>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">æ£€æµ‹é—´éš” (æ¯«ç§’)</label>
                            <input type="number" id="memoryleak-interval" value="60000" min="1000" step="1000" style="width: 100%; padding: 8px;">
                            <small style="color: #718096; font-size: 0.85em;">æ¯æ¬¡æ£€æµ‹ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤60000ms (60ç§’)</small>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">è¿­ä»£æ¬¡æ•°</label>
                            <input type="number" id="memoryleak-iterations" value="3" min="1" max="20" style="width: 100%; padding: 8px;">
                            <small style="color: #718096; font-size: 0.85em;">æ£€æµ‹æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">é¡µé¢æ“ä½œä»£ç  (onPageTesting)</label>
                            <textarea id="memoryleak-onpagetesting" placeholder="// åœ¨è¿™é‡Œå†™ä½ æ€€ç–‘ä¼šè§¦å‘å†…å­˜æ³„éœ²çš„é¡µé¢æ“ä½œ&#10;// ä¾‹å¦‚ï¼šawait page.click('.play-button');&#10;// ç•™ç©ºåˆ™é™ç½®é¡µé¢" rows="4" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                            <small style="color: #718096; font-size: 0.85em;">åœ¨æ¯æ¬¡è¿­ä»£ä¸­æ‰§è¡Œçš„é¡µé¢æ“ä½œä»£ç ï¼Œç•™ç©ºè¡¨ç¤ºé™ç½®é¡µé¢</small>
                        </div>
                    </div>

                    <p id="no-runner-config" style="color: #9ca3af; margin: 0;">é€‰æ‹© Runtime æˆ– MemoryLeak åæ˜¾ç¤ºé…ç½®</p>
                </div>
            </div>

            <div class="form-group">
                <label>TestCase é«˜çº§é…ç½® (åº”ç”¨åˆ°æ‰€æœ‰ URLs)</label>
                <div style="background: #f7fafc; padding: 15px; border-radius: 6px; border: 1px solid #cbd5e0;">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">å»¶è¿Ÿæ—¶é—´ (delayMs)</label>
                        <input type="number" id="testcase-delay" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="0" step="1000" style="width: 100%; padding: 8px;">
                        <small style="color: #718096; font-size: 0.85em;">TestCaseçº§åˆ«çš„å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</small>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Cookie (JSON æˆ–å­—ç¬¦ä¸²)</label>

                        <!-- Cookieé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="cookie-preset" onchange="applyCookiePreset()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©Cookieé¢„è®¾...</option>
                                <option value="bilibili_login">Bç«™ç™»å½•æ€</option>
                                <option value="youtube_login">YouTubeç™»å½•æ€</option>
                                <option value="custom_simple">ç®€å•Cookie</option>
                            </select>
                            <button type="button" onclick="clearConfig('testcase-cookie')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="testcase-cookie" placeholder='{"name": "value"} æˆ– "name=value"' rows="2" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small id="cookie-instruction" style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px;">è®¾ç½®é¡µé¢çš„ Cookie</small>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">é¢å¤– HTTP å¤´ (extraHTTPHeaders)</label>

                        <!-- HTTP Headersé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="headers-preset" onchange="applyHeadersPreset()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©User-Agenté¢„è®¾...</option>
                                <option value="mobile_chrome">ğŸ“± ç§»åŠ¨ç«¯Chrome</option>
                                <option value="mobile_safari">ğŸ“± ç§»åŠ¨ç«¯Safari (iPhone)</option>
                                <option value="desktop_chrome">ğŸ–¥ï¸ æ¡Œé¢ç«¯Chrome (Win)</option>
                                <option value="desktop_mac">ğŸ–¥ï¸ æ¡Œé¢ç«¯Safari (Mac)</option>
                                <option value="with_auth">ğŸ”‘ Bearer Tokenè®¤è¯</option>
                                <option value="api_key">ğŸ”‘ API Keyè®¤è¯</option>
                            </select>
                            <button type="button" onclick="clearConfig('testcase-headers')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="testcase-headers" placeholder='{"User-Agent": "...", "Authorization": "..."}' rows="2" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small id="headers-instruction" style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px;">JSONæ ¼å¼çš„é¢å¤–HTTPè¯·æ±‚å¤´</small>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">é˜»æ­¢åˆ—è¡¨ (blockList)</label>

                        <!-- BlockListé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="blocklist-preset" onchange="applyBlocklistPreset()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©é˜»æ­¢åˆ—è¡¨é¢„è®¾...</option>
                                <option value="block_images">ğŸ–¼ï¸ é˜»æ­¢å›¾ç‰‡</option>
                                <option value="block_videos">ğŸ¬ é˜»æ­¢è§†é¢‘æ–‡ä»¶</option>
                                <option value="block_ads">ğŸš« é˜»æ­¢å¹¿å‘Š</option>
                                <option value="block_analytics">ğŸ“Š é˜»æ­¢ç»Ÿè®¡åˆ†æ</option>
                                <option value="block_fonts">ğŸ”¤ é˜»æ­¢å­—ä½“</option>
                                <option value="performance_mode">âš¡ æ€§èƒ½æ¨¡å¼ï¼ˆæ¨èï¼‰</option>
                                <option value="bilibili_ads">ğŸ…±ï¸ Bç«™å¹¿å‘Š</option>
                            </select>
                            <button type="button" onclick="clearConfig('testcase-blocklist')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="testcase-blocklist" placeholder='["*.jpg", "*.png", "https://analytics.example.com/**"]' rows="2" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">JSONæ•°ç»„æ ¼å¼ï¼Œæ”¯æŒglobæ¨¡å¼ï¼Œé˜»æ­¢åŒ¹é…çš„èµ„æºåŠ è½½ | ğŸ’¡ å¯æå‡æ€§èƒ½</small>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">è‡ªå®šä¹‰ CSS (customCss)</label>

                        <!-- CSSé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="css-preset" onchange="applyCssPreset()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©CSSé¢„è®¾...</option>
                                <option value="hide_ads">ğŸš« éšè—å¹¿å‘Šå…ƒç´ </option>
                                <option value="hide_headers">â¬†ï¸ éšè—å¤´éƒ¨å¯¼èˆª</option>
                                <option value="hide_footers">â¬‡ï¸ éšè—é¡µè„š</option>
                                <option value="focus_video">ğŸ¯ è§†é¢‘èšç„¦æ¨¡å¼</option>
                                <option value="dark_mode">ğŸŒ™ æš—é»‘æ¨¡å¼</option>
                                <option value="performance_boost">âš¡ æ€§èƒ½æå‡</option>
                                <option value="bilibili_clean">ğŸ…±ï¸ Bç«™å‡€åŒ–</option>
                            </select>
                            <button type="button" onclick="clearConfig('testcase-css')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="testcase-css" placeholder="body { background: red; }" rows="2" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">æ³¨å…¥åˆ°é¡µé¢çš„è‡ªå®šä¹‰CSSæ ·å¼</small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">è®¾å¤‡é€‰é¡¹ (deviceOptions)</label>

                        <!-- Deviceé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="device-preset" onchange="applyDevicePreset()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©è®¾å¤‡é¢„è®¾...</option>
                                <optgroup label="ğŸ–¥ï¸ æ¡Œé¢è®¾å¤‡">
                                    <option value="desktop_fullhd">Full HD (1920x1080 å…¨å±)</option>
                                    <option value="desktop_normal">æ ‡å‡†æ¡Œé¢ (1920x1080 çª—å£)</option>
                                    <option value="desktop_2k">2K (2560x1440)</option>
                                    <option value="desktop_4k">4K (3840x2160)</option>
                                    <option value="desktop_small">å°å±ç¬”è®°æœ¬ (1366x768)</option>
                                </optgroup>
                                <optgroup label="ğŸ“± ç§»åŠ¨è®¾å¤‡">
                                    <option value="mobile_android">Android æ ‡å‡†</option>
                                    <option value="mobile_iphone">iPhone æ ‡å‡†</option>
                                    <option value="mobile_iphone_pro">iPhone Pro</option>
                                    <option value="mobile_iphone_pro_max">iPhone Pro Max</option>
                                    <option value="mobile_ipad">iPad</option>
                                    <option value="mobile_galaxy_s21">Galaxy S21</option>
                                </optgroup>
                            </select>
                            <button type="button" onclick="clearDeviceConfig()" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <select id="testcase-device-type" style="width: 100%; padding: 8px; margin-bottom: 8px;">
                            <option value="">ä¸è®¾ç½®ï¼ˆä½¿ç”¨é»˜è®¤ï¼‰</option>
                            <option value="Desktop">Desktop - æ¡Œé¢è®¾å¤‡</option>
                            <option value="Mobile">Mobile - ç§»åŠ¨è®¾å¤‡</option>
                        </select>
                        <div id="device-desktop-options" style="display: none; margin-top: 8px;">
                            <label style="cursor: pointer;">
                                <input type="checkbox" id="device-fullscreen"> å…¨å±æ¨¡å¼ (fullscreen)
                            </label>
                        </div>
                        <div id="device-mobile-options" style="display: none; margin-top: 8px;">
                            <select id="device-mobile-preset" style="width: 100%; padding: 8px;">
                                <option value="android">Android</option>
                                <option value="iphone">iPhone</option>
                            </select>
                        </div>
                        <small id="device-instruction" style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px;">æ¨¡æ‹Ÿä¸åŒè®¾å¤‡ç±»å‹</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ç”Ÿå‘½å‘¨æœŸé’©å­ (Lifecycle Hooks)</label>
                <div style="background: #f7fafc; padding: 15px; border-radius: 6px; border: 1px solid #cbd5e0;">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">ğŸ”§ beforePageLoad</label>

                        <!-- beforePageLoadé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="hook-beforepageload-preset" onchange="applyHookPreset('beforePageLoad', 'hook-beforepageload')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                <option value="set_viewport_1080p">ğŸ–¥ï¸ è®¾ç½®è§†å£ 1080P</option>
                                <option value="set_viewport_720p">ğŸ–¥ï¸ è®¾ç½®è§†å£ 720P</option>
                                <option value="set_viewport_mobile">ğŸ“± è®¾ç½®ç§»åŠ¨ç«¯è§†å£</option>
                                <option value="enable_console_log">ğŸ“‹ å¯ç”¨æ§åˆ¶å°æ—¥å¿—</option>
                                <option value="block_notifications">ğŸ”• é˜»æ­¢é€šçŸ¥æƒé™</option>
                                <option value="set_geolocation">ğŸŒ è®¾ç½®åœ°ç†ä½ç½®</option>
                                <option value="inject_script">ğŸ’‰ æ³¨å…¥å…¨å±€è„šæœ¬</option>
                                <option value="disable_animations">âš¡ ç¦ç”¨CSSåŠ¨ç”»</option>
                            </select>
                            <button type="button" onclick="clearHookCode('hook-beforepageload')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="hook-beforepageload" placeholder="// é¡µé¢åŠ è½½å‰æ‰§è¡Œ&#10;// ä¾‹å¦‚ï¼šawait page.setViewportSize({ width: 1920, height: 1080 });" rows="3" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">åœ¨é¡µé¢åŠ è½½ä¹‹å‰æ‰§è¡Œ | ç”¨äºè®¾ç½®ç¯å¢ƒ</small>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">âœ… onPageLoaded</label>

                        <!-- onPageLoadedé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="hook-onpageloaded-preset" onchange="applyHookPreset('onPageLoaded', 'hook-onpageloaded')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                <option value="wait_for_video">ğŸ“¹ ç­‰å¾…è§†é¢‘åŠ è½½</option>
                                <option value="wait_for_content">ğŸ“„ ç­‰å¾…å†…å®¹åŠ è½½</option>
                                <option value="wait_network_idle">ğŸŒ ç­‰å¾…ç½‘ç»œç©ºé—²</option>
                                <option value="check_no_errors">ğŸ› æ£€æŸ¥é¡µé¢é”™è¯¯</option>
                                <option value="scroll_to_load">ğŸ“œ æ»šåŠ¨è§¦å‘æ‡’åŠ è½½</option>
                                <option value="remove_overlays">âŒ ç§»é™¤å¼¹çª—é®ç½©</option>
                                <option value="bilibili_wait_player">ğŸ…±ï¸ Bç«™ç­‰å¾…æ’­æ”¾å™¨</option>
                            </select>
                            <button type="button" onclick="clearHookCode('hook-onpageloaded')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="hook-onpageloaded" placeholder="// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ&#10;// ä¾‹å¦‚ï¼šawait page.waitForSelector('.content');" rows="3" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ | ç”¨äºéªŒè¯å’Œç­‰å¾…</small>
                    </div>

                    <div id="hook-onpagetesting-container" style="margin-bottom: 10px; display: none;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">ğŸ”„ onPageTesting</label>

                        <!-- é¢„è®¾æ“ä½œé€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 10px; padding: 10px; background: #edf2f7; border-radius: 6px; border: 1px solid #cbd5e0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label style="margin: 0; font-weight: 500; font-size: 0.9em;">âœ¨ å¿«é€Ÿé¢„è®¾ï¼š</label>
                                <select id="preset-category" onchange="updatePresetOperations()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;">
                                    <option value="">-- é€‰æ‹©åˆ†ç±» --</option>
                                    <option value="bilibili">Bç«™æ’­æ”¾å™¨</option>
                                    <option value="bilibiliLive">Bç«™ç›´æ’­</option>
                                    <option value="generic">é€šç”¨è§†é¢‘</option>
                                    <option value="interaction">é¡µé¢äº¤äº’</option>
                                    <option value="performance">æ€§èƒ½æµ‹è¯•</option>
                                </select>
                                <select id="preset-operation" onchange="updatePresetParams()" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;" disabled>
                                    <option value="">-- é€‰æ‹©æ“ä½œ --</option>
                                </select>
                            </div>

                            <!-- å‚æ•°é…ç½®åŒºåŸŸ -->
                            <div id="preset-params" style="display: none; margin-bottom: 8px;"></div>

                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="insertPresetCode()" class="btn-small" style="padding: 6px 12px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ’å…¥ä»£ç </button>
                                <button type="button" onclick="previewPresetCode()" class="btn-small" style="padding: 6px 12px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">é¢„è§ˆä»£ç </button>
                                <button type="button" onclick="clearHookCode('hook-onpagetesting')" class="btn-small" style="padding: 6px 12px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                            </div>
                        </div>

                        <textarea id="hook-onpagetesting" placeholder="// Runtime/MemoryLeak æµ‹è¯•æœŸé—´æ‰§è¡Œ&#10;// ä¾‹å¦‚ï¼šawait page.click('.button');&#10;// æˆ–ä½¿ç”¨ä¸Šæ–¹é¢„è®¾å¿«é€Ÿæ’å…¥å¸¸ç”¨æ“ä½œ" rows="6" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">ä»…åœ¨ Runtime æˆ– MemoryLeak æµ‹è¯•æœŸé—´æ‰§è¡Œ | ğŸ’¡ æ”¯æŒå¤šä¸ªæ“ä½œç»„åˆ</small>
                    </div>

                    <div id="hook-onpagecollecting-container" style="margin-bottom: 10px; display: none;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">ğŸ“Š onPageCollecting</label>

                        <!-- onPageCollectingé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="hook-onpagecollecting-preset" onchange="applyHookPreset('onPageCollecting', 'hook-onpagecollecting')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                <option value="force_gc">ğŸ—‘ï¸ å¼ºåˆ¶åƒåœ¾å›æ”¶</option>
                                <option value="pause_video">â¸ï¸ æš‚åœè§†é¢‘</option>
                                <option value="clear_cache">ğŸ§¹ æ¸…ç†é¡µé¢ç¼“å­˜</option>
                                <option value="stop_animations">â¹ï¸ åœæ­¢æ‰€æœ‰åŠ¨ç”»</option>
                                <option value="collect_metrics">ğŸ“Š æ”¶é›†æ€§èƒ½æŒ‡æ ‡</option>
                            </select>
                            <button type="button" onclick="clearHookCode('hook-onpagecollecting')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="hook-onpagecollecting" placeholder="// MemoryLeak æ”¶é›†æ•°æ®æ—¶æ‰§è¡Œ&#10;// ä¾‹å¦‚ï¼šawait page.evaluate(() => window.gc());" rows="3" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">ä»…åœ¨ MemoryLeak æ”¶é›†æ•°æ®æ—¶æ‰§è¡Œ | å»ºè®®ä½¿ç”¨GCé¢„è®¾</small>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">ğŸ onPageUnload</label>

                        <!-- onPageUnloadé¢„è®¾é€‰æ‹©å™¨ -->
                        <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                            <select id="hook-onpageunload-preset" onchange="applyHookPreset('onPageUnload', 'hook-onpageunload')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                <option value="save_screenshot">ğŸ“¸ ä¿å­˜æˆªå›¾</option>
                                <option value="log_final_state">ğŸ“ è®°å½•æœ€ç»ˆçŠ¶æ€</option>
                                <option value="collect_errors">â— æ”¶é›†é”™è¯¯æ—¥å¿—</option>
                                <option value="cleanup_listeners">ğŸ§¹ æ¸…ç†äº‹ä»¶ç›‘å¬</option>
                                <option value="close_connections">ğŸ”Œ å…³é—­è¿æ¥</option>
                                <option value="export_data">ğŸ“¤ å¯¼å‡ºæ•°æ®</option>
                            </select>
                            <button type="button" onclick="clearHookCode('hook-onpageunload')" class="btn-small" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                        </div>

                        <textarea id="hook-onpageunload" placeholder="// é¡µé¢å¸è½½å‰æ‰§è¡Œ&#10;// ä¾‹å¦‚ï¼šawait page.evaluate(() => console.log('cleanup'));" rows="3" style="width: 100%; padding: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">åœ¨é¡µé¢å¸è½½å‰æ‰§è¡Œ | ç”¨äºæ¸…ç†å’Œä¿å­˜</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="case-description" placeholder="æè¿°è¯¥æµ‹è¯•ç”¨ä¾‹çš„ç›®çš„å’Œé¢„æœŸç»“æœ"></textarea>
            </div>

            <div class="form-group">
                <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="case-tags" placeholder="ä¾‹å¦‚ï¼šbilibili, é¦–é¡µ, å†’çƒŸæµ‹è¯•">
            </div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveCase()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥é¢„è®¾åº“ -->
    <script src="operation-presets.js"></script>
    <script src="config-presets.js"></script>
    <script src="hook-presets.js"></script>

    <script>
        // æ•°æ®å­˜å‚¨
        let testCases = JSON.parse(localStorage.getItem('testCases') || '[]');
        let selectedCases = new Set();
        let currentRunning = null; // ä¿ç•™ç”¨äºå‘åå…¼å®¹
        let runningQueue = [];
        let completedToday = 0;

        // æ–°å¢ï¼šåç«¯ä»»åŠ¡ç®¡ç†
        let backendTasks = new Map(); // taskId -> taskå¯¹è±¡
        const MAX_CONCURRENT = 3;

        // ==================== é¢„è®¾ç³»ç»Ÿ ====================
        let currentPresetParams = {}; // å½“å‰é¢„è®¾çš„å‚æ•°å€¼

        // æ›´æ–°é¢„è®¾æ“ä½œåˆ—è¡¨
        function updatePresetOperations() {
            const category = document.getElementById('preset-category').value;
            const operationSelect = document.getElementById('preset-operation');
            const paramsDiv = document.getElementById('preset-params');

            // æ¸…ç©ºå¹¶é‡ç½®
            operationSelect.innerHTML = '<option value="">-- é€‰æ‹©æ“ä½œ --</option>';
            paramsDiv.style.display = 'none';
            paramsDiv.innerHTML = '';
            currentPresetParams = {};

            if (!category || !OperationPresets[category]) {
                operationSelect.disabled = true;
                return;
            }

            operationSelect.disabled = false;
            const operations = OperationPresets[category].operations;

            Object.keys(operations).forEach(key => {
                const op = operations[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${op.name} - ${op.description}`;
                operationSelect.appendChild(option);
            });
        }

        // æ›´æ–°é¢„è®¾å‚æ•°é…ç½®UI
        function updatePresetParams() {
            const category = document.getElementById('preset-category').value;
            const operation = document.getElementById('preset-operation').value;
            const paramsDiv = document.getElementById('preset-params');

            paramsDiv.style.display = 'none';
            paramsDiv.innerHTML = '';
            currentPresetParams = {};

            if (!category || !operation) return;

            const preset = OperationPresets[category].operations[operation];
            if (!preset.params || preset.params.length === 0) return;

            paramsDiv.style.display = 'block';

            preset.params.forEach(param => {
                const paramGroup = document.createElement('div');
                paramGroup.style.marginBottom = '8px';

                const label = document.createElement('label');
                label.textContent = param.label + ':';
                label.style.display = 'block';
                label.style.marginBottom = '4px';
                label.style.fontSize = '0.85em';
                label.style.fontWeight = '500';

                let input;
                if (param.type === 'select') {
                    input = document.createElement('select');
                    input.style.width = '100%';
                    input.style.padding = '6px';
                    input.style.border = '1px solid #cbd5e0';
                    input.style.borderRadius = '4px';
                    input.style.fontSize = '0.85em';

                    param.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.label;
                        if (opt.value === param.default) {
                            option.selected = true;
                        }
                        input.appendChild(option);
                    });
                } else if (param.type === 'number') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = param.default || 0;
                    if (param.min !== undefined) input.min = param.min;
                    if (param.max !== undefined) input.max = param.max;
                    input.style.width = '100%';
                    input.style.padding = '6px';
                    input.style.border = '1px solid #cbd5e0';
                    input.style.borderRadius = '4px';
                    input.style.fontSize = '0.85em';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = param.default || '';
                    input.style.width = '100%';
                    input.style.padding = '6px';
                    input.style.border = '1px solid #cbd5e0';
                    input.style.borderRadius = '4px';
                    input.style.fontSize = '0.85em';
                }

                input.dataset.paramName = param.name;
                paramGroup.appendChild(label);
                paramGroup.appendChild(input);
                paramsDiv.appendChild(paramGroup);

                // åˆå§‹åŒ–å‚æ•°å€¼
                currentPresetParams[param.name] = input.value;

                // ç›‘å¬å‚æ•°å˜åŒ–
                input.addEventListener('change', () => {
                    currentPresetParams[param.name] = input.value;
                });
                input.addEventListener('input', () => {
                    currentPresetParams[param.name] = input.value;
                });
            });
        }

        // ç”Ÿæˆé¢„è®¾ä»£ç 
        function generatePresetCode() {
            const category = document.getElementById('preset-category').value;
            const operation = document.getElementById('preset-operation').value;

            if (!category || !operation) {
                showToast('è¯·å…ˆé€‰æ‹©é¢„è®¾åˆ†ç±»å’Œæ“ä½œ', 'error');
                return null;
            }

            const preset = OperationPresets[category].operations[operation];
            if (!preset) {
                showToast('é¢„è®¾ä¸å­˜åœ¨', 'error');
                return null;
            }

            // æ„å»ºå‚æ•°å¯¹è±¡
            const params = {};
            Object.keys(currentPresetParams).forEach(key => {
                const value = currentPresetParams[key];
                // å°è¯•è½¬æ¢æ•°å­—ç±»å‹
                if (!isNaN(value) && value !== '') {
                    params[key] = Number(value);
                } else {
                    params[key] = value;
                }
            });

            return preset.code(params);
        }

        // æ’å…¥é¢„è®¾ä»£ç 
        function insertPresetCode() {
            const code = generatePresetCode();
            if (!code) return;

            const textarea = document.getElementById('hook-onpagetesting');
            const currentCode = textarea.value.trim();

            if (currentCode) {
                // å¦‚æœå·²æœ‰ä»£ç ï¼Œè¿½åŠ åˆ°æœ«å°¾
                textarea.value = currentCode + '\n\n' + code;
            } else {
                textarea.value = code;
            }

            showToast('é¢„è®¾ä»£ç å·²æ’å…¥', 'success');
        }

        // é¢„è§ˆé¢„è®¾ä»£ç 
        function previewPresetCode() {
            const code = generatePresetCode();
            if (!code) return;

            // ä½¿ç”¨alertæ˜¾ç¤ºï¼ˆç®€å•å®ç°ï¼Œå¯ä»¥åç»­æ”¹ä¸ºæ›´ç¾è§‚çš„æ¨¡æ€æ¡†ï¼‰
            alert('ç”Ÿæˆçš„ä»£ç é¢„è§ˆï¼š\n\n' + code);
        }

        // æ¸…ç©ºhookä»£ç 
        function clearHookCode(hookId) {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä»£ç å—ï¼Ÿ')) return;
            document.getElementById(hookId).value = '';
            showToast('ä»£ç å·²æ¸…ç©º', 'success');
        }

        // ==================== é…ç½®é¢„è®¾ç³»ç»Ÿ ====================

        // åº”ç”¨Cookieé¢„è®¾
        function applyCookiePreset() {
            const presetKey = document.getElementById('cookie-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.cookies.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-cookie');
            textarea.value = JSON.stringify(preset.value, null, 2);

            if (preset.instruction) {
                document.getElementById('cookie-instruction').textContent = 'ğŸ’¡ ' + preset.instruction;
                document.getElementById('cookie-instruction').style.color = '#e67e22';
            }

            showToast(`å·²åº”ç”¨Cookieé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨HTTP Headersé¢„è®¾
        function applyHeadersPreset() {
            const presetKey = document.getElementById('headers-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.headers.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-headers');
            textarea.value = JSON.stringify(preset.value, null, 2);

            if (preset.instruction) {
                document.getElementById('headers-instruction').textContent = 'ğŸ’¡ ' + preset.instruction;
                document.getElementById('headers-instruction').style.color = '#e67e22';
            }

            showToast(`å·²åº”ç”¨Headersé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨BlockListé¢„è®¾
        function applyBlocklistPreset() {
            const presetKey = document.getElementById('blocklist-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.blocklist.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-blocklist');
            textarea.value = JSON.stringify(preset.value, null, 2);

            showToast(`å·²åº”ç”¨BlockListé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨CSSé¢„è®¾
        function applyCssPreset() {
            const presetKey = document.getElementById('css-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.customCss.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-css');
            textarea.value = preset.value;

            showToast(`å·²åº”ç”¨CSSé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨Deviceé¢„è®¾
        function applyDevicePreset() {
            const presetKey = document.getElementById('device-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.devices.presets[presetKey];
            if (!preset) return;

            const deviceType = preset.type;
            const deviceTypeSelect = document.getElementById('testcase-device-type');
            deviceTypeSelect.value = deviceType;

            // è§¦å‘è®¾å¤‡ç±»å‹å˜åŒ–äº‹ä»¶
            updateDeviceOptionsDisplay();

            // è®¾ç½®å…·ä½“é€‰é¡¹
            if (deviceType === 'Desktop') {
                const fullscreenOption = preset.value[1]?.fullscreen;
                document.getElementById('device-fullscreen').checked = fullscreenOption || false;
            } else if (deviceType === 'Mobile') {
                const mobilePresetName = preset.value[1]?.preset || 'iphone';
                document.getElementById('device-mobile-preset').value = mobilePresetName;
            }

            const instruction = document.getElementById('device-instruction');
            instruction.textContent = `å·²åº”ç”¨: ${preset.displayText}`;
            instruction.style.color = '#27ae60';

            showToast(`å·²åº”ç”¨è®¾å¤‡é¢„è®¾: ${preset.name}`, 'success');
        }

        // æ¸…ç©ºè®¾å¤‡é…ç½®
        function clearDeviceConfig() {
            document.getElementById('device-preset').value = '';
            document.getElementById('testcase-device-type').value = '';
            document.getElementById('device-fullscreen').checked = false;
            document.getElementById('device-mobile-preset').value = 'android';
            updateDeviceOptionsDisplay();

            const instruction = document.getElementById('device-instruction');
            instruction.textContent = 'æ¨¡æ‹Ÿä¸åŒè®¾å¤‡ç±»å‹';
            instruction.style.color = '#718096';

            showToast('è®¾å¤‡é…ç½®å·²æ¸…ç©º', 'success');
        }

        // é€šç”¨æ¸…ç©ºé…ç½®
        function clearConfig(elementId) {
            document.getElementById(elementId).value = '';

            // é‡ç½®instructionæ ·å¼
            const instructionId = elementId.replace('testcase-', '') + '-instruction';
            const instructionEl = document.getElementById(instructionId);
            if (instructionEl) {
                instructionEl.style.color = '#718096';
            }

            // é‡ç½®å¯¹åº”çš„é¢„è®¾é€‰æ‹©å™¨
            const presetSelectId = elementId.replace('testcase-', '') + '-preset';
            const presetSelect = document.getElementById(presetSelectId);
            if (presetSelect) {
                presetSelect.value = '';
            }

            showToast('é…ç½®å·²æ¸…ç©º', 'success');
        }

        // ==================== é’©å­å‡½æ•°é¢„è®¾ç³»ç»Ÿ ====================

        // åº”ç”¨é’©å­å‡½æ•°é¢„è®¾
        function applyHookPreset(hookName, textareaId) {
            const presetSelectId = textareaId + '-preset';
            const presetSelect = document.getElementById(presetSelectId);
            const presetKey = presetSelect.value;

            if (!presetKey) return;

            const hookPresets = HookPresets[hookName];
            if (!hookPresets || !hookPresets.presets[presetKey]) {
                showToast('é¢„è®¾ä¸å­˜åœ¨', 'error');
                return;
            }

            const preset = hookPresets.presets[presetKey];
            const textarea = document.getElementById(textareaId);
            const currentCode = textarea.value.trim();

            if (currentCode) {
                // å¦‚æœå·²æœ‰ä»£ç ï¼Œè¯¢é—®æ˜¯æ›¿æ¢è¿˜æ˜¯è¿½åŠ 
                if (confirm(`å½“å‰å·²æœ‰ä»£ç ï¼Œæ˜¯å¦è¿½åŠ æ–°é¢„è®¾ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"è¿½åŠ ï¼Œç‚¹å‡»"å–æ¶ˆ"æ›¿æ¢`)) {
                    textarea.value = currentCode + '\n\n' + preset.code;
                    showToast(`å·²è¿½åŠ é¢„è®¾: ${preset.name}`, 'success');
                } else {
                    textarea.value = preset.code;
                    showToast(`å·²æ›¿æ¢ä¸ºé¢„è®¾: ${preset.name}`, 'success');
                }
            } else {
                textarea.value = preset.code;
                showToast(`å·²åº”ç”¨é¢„è®¾: ${preset.name}`, 'success');
            }

            // é‡ç½®ä¸‹æ‹‰æ¡†
            presetSelect.value = '';
        }

        // WebSocketè¿æ¥
        let ws = null;
        let reconnectTimer = null;

        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                appendOutput('[ç³»ç»Ÿ] WebSocketè¿æ¥æˆåŠŸ');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                appendOutput('[ç³»ç»Ÿ] WebSocketè¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
                reconnectTimer = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'status':
                    updateStatus(data.data.status, data.data.currentRunner);
                    break;
                case 'output':
                    appendOutput(data.data);
                    break;
                case 'progress':
                    updateProgress(data.current, data.total);
                    break;
                case 'tasks':
                    // æ–°å¢ï¼šå¤„ç†ä»»åŠ¡åˆ—è¡¨æ›´æ–°
                    updateTasksList(data.data);
                    break;
                case 'task_update':
                    // æ–°å¢ï¼šå¤„ç†å•ä¸ªä»»åŠ¡æ›´æ–°
                    updateSingleTask(data.data);
                    break;
            }
        }

        // æ–°å¢ï¼šæ›´æ–°ä»»åŠ¡åˆ—è¡¨
        function updateTasksList(tasks) {
            backendTasks.clear();
            tasks.forEach(task => {
                backendTasks.set(task.id, task);
            });
            updateStats();
            updateQueueDisplay();
        }

        // æ–°å¢ï¼šæ›´æ–°å•ä¸ªä»»åŠ¡
        function updateSingleTask(task) {
            backendTasks.set(task.id, task);

            // å¦‚æœæœ‰è¾“å‡ºï¼Œè¿½åŠ åˆ°è¾“å‡ºåŒºåŸŸ
            if (task.output) {
                const outputArea = document.getElementById('output-area');
                if (outputArea) {
                    outputArea.value = task.output;
                    outputArea.scrollTop = outputArea.scrollHeight;
                }
            }

            updateStats();
            updateQueueDisplay();
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            connectWebSocket();
            renderCases();
            updateStats();
            loadCompletedToday();

            // æ·»åŠ é«˜çº§é…ç½®äº‹ä»¶ç›‘å¬
            document.getElementById('runner-runtime').addEventListener('change', updateAdvancedConfigDisplay);
            document.getElementById('runner-memoryleak').addEventListener('change', updateAdvancedConfigDisplay);
            document.getElementById('testcase-device-type').addEventListener('change', updateDeviceOptionsDisplay);
        };

        // æ¸²æŸ“ç”¨ä¾‹åˆ—è¡¨
        function renderCases() {
            const container = document.getElementById('cases-container');

            if (testCases.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— æµ‹è¯•ç”¨ä¾‹</h3>
                        <p>ç‚¹å‡»"æ·»åŠ ç”¨ä¾‹"åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹</p>
                    </div>
                `;
                return;
            }

            const table = `
                <table class="test-cases-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleSelectAll(this.checked)"></th>
                            <th>ç”¨ä¾‹åç§°</th>
                            <th>æµ‹è¯•ç±»å‹</th>
                            <th>URLæ•°é‡</th>
                            <th>æ¨¡å¼</th>
                            <th>é‡å¤æ¬¡æ•°</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${testCases.map(testCase => {
                            const urls = testCase.urls || (testCase.url ? [testCase.url] : []);
                            const mode = testCase.mode || 'headless';
                            const urlsTitle = urls.join('\\n');

                            // å¤„ç†runner - å…¼å®¹æ–°æ—§æ ¼å¼
                            let runners = [];
                            if (testCase.runners) {
                                // æ–°æ ¼å¼ï¼šrunnerså¯¹è±¡
                                if (testCase.runners.Initialization?.enabled) runners.push('Init');
                                if (testCase.runners.Runtime?.enabled) runners.push('Runtime');
                                if (testCase.runners.MemoryLeak?.enabled) runners.push('Memory');
                            } else if (testCase.runner) {
                                // æ—§æ ¼å¼ï¼šå•ä¸ªrunnerå­—ç¬¦ä¸²
                                runners.push(testCase.runner === 'Initialization' ? 'Init' :
                                           testCase.runner === 'MemoryLeak' ? 'Memory' : testCase.runner);
                            }

                            const runnerTags = runners.map(r =>
                                '<span class="runner-tag runner-' + r.toLowerCase() + '" style="margin-right: 4px;">' + r + '</span>'
                            ).join('');

                            return `
                            <tr>
                                <td><input type="checkbox" onchange="toggleCaseSelection(${testCase.id}, this.checked)" ${selectedCases.has(testCase.id) ? 'checked' : ''}></td>
                                <td><strong>${escapeHtml(testCase.name)}</strong></td>
                                <td>${runnerTags || '<span style="color: #999;">æœªé…ç½®</span>'}</td>
                                <td><span title="${escapeHtml(urlsTitle)}" style="cursor: help;">${urls.length} ä¸ªURL</span></td>
                                <td><span style="font-size: 0.85em; color: #4a5568;">${mode === 'headless' ? 'ğŸš€ æ— å¤´' : 'ğŸ‘ï¸ æœ‰å¤´'}</span></td>
                                <td>${testCase.repeatCount || 3}</td>
                                <td><span class="status-badge status-${testCase.status || 'idle'}">${getStatusText(testCase.status || 'idle')}</span></td>
                                <td>
                                    <div class="actions">
                                        <button class="btn-success btn-small" onclick="runCase(${testCase.id})">â–¶ è¿è¡Œ</button>
                                        <button class="btn-secondary btn-small" onclick="editCase(${testCase.id})">âœï¸ ç¼–è¾‘</button>
                                        <button class="btn-danger btn-small" onclick="deleteCase(${testCase.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('total-cases').textContent = testCases.length;

            // ç»Ÿè®¡åç«¯è¿è¡Œä¸­çš„ä»»åŠ¡æ•°
            const runningCount = Array.from(backendTasks.values()).filter(t => t.status === 'running').length;
            document.getElementById('running-cases').textContent = runningCount;

            document.getElementById('completed-today').textContent = completedToday;
        }

        // é€‰æ‹©/å–æ¶ˆé€‰æ‹©ç”¨ä¾‹
        function toggleCaseSelection(id, checked) {
            if (checked) {
                selectedCases.add(id);
            } else {
                selectedCases.delete(id);
            }
            updateSelectionUI();
        }

        function toggleSelectAll(checked) {
            selectedCases.clear();
            if (checked) {
                testCases.forEach(tc => selectedCases.add(tc.id));
            }
            renderCases();
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.getElementById('selected-count').textContent = selectedCases.size;
            document.getElementById('run-selected-btn').disabled = selectedCases.size === 0;
            document.getElementById('delete-selected-btn').disabled = selectedCases.size === 0;
        }

        // æ‰¹é‡åˆ é™¤ç”¨ä¾‹
        function deleteSelectedCases() {
            if (selectedCases.size === 0) return;

            const count = selectedCases.size;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªç”¨ä¾‹å—ï¼Ÿ`)) return;

            // åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„ç”¨ä¾‹
            testCases = testCases.filter(tc => !selectedCases.has(tc.id));
            selectedCases.clear();

            saveToStorage();
            renderCases();
            updateSelectionUI();
            showToast(`æˆåŠŸåˆ é™¤ ${count} ä¸ªç”¨ä¾‹`, 'success');
        }

        // æ›´æ–°é«˜çº§é…ç½®æ˜¾ç¤º
        function updateAdvancedConfigDisplay() {
            const runtimeChecked = document.getElementById('runner-runtime').checked;
            const memoryLeakChecked = document.getElementById('runner-memoryleak').checked;

            const runtimeConfig = document.getElementById('runtime-config');
            const memoryLeakConfig = document.getElementById('memoryleak-config');
            const noConfig = document.getElementById('no-runner-config');

            runtimeConfig.style.display = runtimeChecked ? 'block' : 'none';
            memoryLeakConfig.style.display = memoryLeakChecked ? 'block' : 'none';
            noConfig.style.display = (!runtimeChecked && !memoryLeakChecked) ? 'block' : 'none';

            // æ ¹æ®é€‰æ‹©çš„runneræ˜¾ç¤º/éšè—ç”Ÿå‘½å‘¨æœŸé’©å­
            const onPageTestingContainer = document.getElementById('hook-onpagetesting-container');
            const onPageCollectingContainer = document.getElementById('hook-onpagecollecting-container');

            // onPageTesting åªåœ¨ Runtime æˆ– MemoryLeak æ—¶æ˜¾ç¤º
            onPageTestingContainer.style.display = (runtimeChecked || memoryLeakChecked) ? 'block' : 'none';

            // onPageCollecting åªåœ¨ MemoryLeak æ—¶æ˜¾ç¤º
            onPageCollectingContainer.style.display = memoryLeakChecked ? 'block' : 'none';
        }

        // æ›´æ–°è®¾å¤‡é€‰é¡¹æ˜¾ç¤º
        function updateDeviceOptionsDisplay() {
            const deviceType = document.getElementById('testcase-device-type').value;
            const desktopOptions = document.getElementById('device-desktop-options');
            const mobileOptions = document.getElementById('device-mobile-options');

            desktopOptions.style.display = deviceType === 'Desktop' ? 'block' : 'none';
            mobileOptions.style.display = deviceType === 'Mobile' ? 'block' : 'none';
        }

        // æ˜¾ç¤ºæ·»åŠ ç”¨ä¾‹æ¨¡æ€æ¡†
        function showAddCaseModal() {
            document.getElementById('case-modal').classList.add('active');
            document.querySelector('.modal-header').textContent = 'â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹';

            // æ¸…ç©ºè¡¨å• - åŸºç¡€å­—æ®µ
            document.getElementById('case-name').value = '';
            document.getElementById('runner-initialization').checked = false;
            document.getElementById('runner-runtime').checked = false;
            document.getElementById('runner-memoryleak').checked = false;
            document.getElementById('case-urls').value = '';
            document.getElementById('case-mode').value = 'headless';
            document.getElementById('case-repeat').value = '3';
            document.getElementById('case-description').value = '';
            document.getElementById('case-tags').value = '';

            // æ¸…ç©º Runner é…ç½®
            document.getElementById('runtime-duration').value = '60000';
            document.getElementById('runtime-delay').value = '10000';
            document.getElementById('memoryleak-interval').value = '60000';
            document.getElementById('memoryleak-iterations').value = '3';
            document.getElementById('memoryleak-onpagetesting').value = '';

            // æ¸…ç©º TestCase é«˜çº§é…ç½®
            document.getElementById('testcase-delay').value = '';
            document.getElementById('testcase-cookie').value = '';
            document.getElementById('testcase-headers').value = '';
            document.getElementById('testcase-blocklist').value = '';
            document.getElementById('testcase-css').value = '';
            document.getElementById('testcase-device-type').value = '';
            document.getElementById('device-fullscreen').checked = false;
            document.getElementById('device-mobile-preset').value = 'android';

            // æ¸…ç©ºç”Ÿå‘½å‘¨æœŸé’©å­
            document.getElementById('hook-beforepageload').value = '';
            document.getElementById('hook-onpageloaded').value = '';
            document.getElementById('hook-onpagetesting').value = '';
            document.getElementById('hook-onpagecollecting').value = '';
            document.getElementById('hook-onpageunload').value = '';

            // æ›´æ–°æ˜¾ç¤º
            updateAdvancedConfigDisplay();
            updateDeviceOptionsDisplay();

            // ç§»é™¤ç¼–è¾‘æ¨¡å¼æ ‡è®°
            delete document.getElementById('case-modal').dataset.editId;
        }

        // ç¼–è¾‘ç”¨ä¾‹
        function editCase(id) {
            const testCase = testCases.find(tc => tc.id === id);
            if (!testCase) return;

            document.getElementById('case-modal').classList.add('active');
            document.querySelector('.modal-header').textContent = 'âœï¸ ç¼–è¾‘æµ‹è¯•ç”¨ä¾‹';

            document.getElementById('case-name').value = testCase.name;

            // å¤„ç†runners - å…¼å®¹æ–°æ—§æ ¼å¼
            if (testCase.runners) {
                // æ–°æ ¼å¼ï¼šrunnerså¯¹è±¡
                document.getElementById('runner-initialization').checked = testCase.runners.Initialization?.enabled || false;
                document.getElementById('runner-runtime').checked = testCase.runners.Runtime?.enabled || false;
                document.getElementById('runner-memoryleak').checked = testCase.runners.MemoryLeak?.enabled || false;
            } else if (testCase.runner) {
                // æ—§æ ¼å¼ï¼šå•ä¸ªrunnerå­—ç¬¦ä¸²
                document.getElementById('runner-initialization').checked = testCase.runner === 'Initialization';
                document.getElementById('runner-runtime').checked = testCase.runner === 'Runtime';
                document.getElementById('runner-memoryleak').checked = testCase.runner === 'MemoryLeak';
            }

            // å¤„ç†URLs - å…¼å®¹æ—§æ ¼å¼ï¼ˆurlï¼‰å’Œæ–°æ ¼å¼ï¼ˆurlsæ•°ç»„ï¼‰
            const urls = testCase.urls || (testCase.url ? [testCase.url] : []);
            document.getElementById('case-urls').value = urls.join('\n');

            document.getElementById('case-mode').value = testCase.mode || 'headless';
            document.getElementById('case-repeat').value = testCase.repeatCount || 3;

            // å¡«å…… Runner é…ç½®å­—æ®µ
            if (testCase.runners?.Runtime) {
                document.getElementById('runtime-duration').value = testCase.runners.Runtime.durationMs || 60000;
                document.getElementById('runtime-delay').value = testCase.runners.Runtime.delayMs || 10000;
            } else {
                document.getElementById('runtime-duration').value = 60000;
                document.getElementById('runtime-delay').value = 10000;
            }

            if (testCase.runners?.MemoryLeak) {
                document.getElementById('memoryleak-interval').value = testCase.runners.MemoryLeak.intervalMs || 60000;
                document.getElementById('memoryleak-iterations').value = testCase.runners.MemoryLeak.iterations || 3;
                document.getElementById('memoryleak-onpagetesting').value = testCase.runners.MemoryLeak.onPageTesting || '';
            } else {
                document.getElementById('memoryleak-interval').value = 60000;
                document.getElementById('memoryleak-iterations').value = 3;
                document.getElementById('memoryleak-onpagetesting').value = '';
            }

            // å¡«å…… TestCase é«˜çº§é…ç½®å­—æ®µ
            const advConfig = testCase.advancedConfig || {};
            document.getElementById('testcase-delay').value = advConfig.delayMs || '';
            document.getElementById('testcase-cookie').value = advConfig.cookie ? (typeof advConfig.cookie === 'string' ? advConfig.cookie : JSON.stringify(advConfig.cookie, null, 2)) : '';
            document.getElementById('testcase-headers').value = advConfig.extraHTTPHeaders ? JSON.stringify(advConfig.extraHTTPHeaders, null, 2) : '';
            document.getElementById('testcase-blocklist').value = advConfig.blockList ? JSON.stringify(advConfig.blockList, null, 2) : '';
            document.getElementById('testcase-css').value = advConfig.customCss || '';

            // æ¢å¤ deviceOptions
            if (advConfig.deviceOptions && Array.isArray(advConfig.deviceOptions)) {
                document.getElementById('testcase-device-type').value = advConfig.deviceOptions[0];
                if (advConfig.deviceOptions[0] === 'Desktop' && advConfig.deviceOptions[1]) {
                    document.getElementById('device-fullscreen').checked = advConfig.deviceOptions[1].fullscreen || false;
                } else if (advConfig.deviceOptions[0] === 'Mobile' && advConfig.deviceOptions[1]) {
                    document.getElementById('device-mobile-preset').value = advConfig.deviceOptions[1].preset || 'android';
                }
            } else {
                document.getElementById('testcase-device-type').value = '';
                document.getElementById('device-fullscreen').checked = false;
                document.getElementById('device-mobile-preset').value = 'android';
            }

            // å¡«å……ç”Ÿå‘½å‘¨æœŸé’©å­
            const hooks = advConfig.hooks || {};
            document.getElementById('hook-beforepageload').value = hooks.beforePageLoad || '';
            document.getElementById('hook-onpageloaded').value = hooks.onPageLoaded || '';
            document.getElementById('hook-onpagetesting').value = hooks.onPageTesting || '';
            document.getElementById('hook-onpagecollecting').value = hooks.onPageCollecting || '';
            document.getElementById('hook-onpageunload').value = hooks.onPageUnload || '';

            document.getElementById('case-description').value = testCase.description || '';
            document.getElementById('case-tags').value = (testCase.tags || []).join(', ');

            // æ›´æ–°æ˜¾ç¤º
            updateAdvancedConfigDisplay();
            updateDeviceOptionsDisplay();

            // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
            document.getElementById('case-modal').dataset.editId = id;
        }

        // ä¿å­˜ç”¨ä¾‹
        function saveCase() {
            const name = document.getElementById('case-name').value.trim();
            const initChecked = document.getElementById('runner-initialization').checked;
            const runtimeChecked = document.getElementById('runner-runtime').checked;
            const memoryChecked = document.getElementById('runner-memoryleak').checked;
            const urlsText = document.getElementById('case-urls').value.trim();
            const mode = document.getElementById('case-mode').value;
            const repeatCount = parseInt(document.getElementById('case-repeat').value);
            const description = document.getElementById('case-description').value.trim();
            const tags = document.getElementById('case-tags').value.split(',').map(t => t.trim()).filter(t => t);

            if (!name) {
                showToast('è¯·è¾“å…¥ç”¨ä¾‹åç§°', 'error');
                return;
            }

            // æ£€æŸ¥è‡³å°‘é€‰æ‹©ä¸€ä¸ªrunner
            if (!initChecked && !runtimeChecked && !memoryChecked) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç±»å‹', 'error');
                return;
            }

            // è§£æå¤šä¸ªURL
            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                showToast('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªURL', 'error');
                return;
            }

            // éªŒè¯æ‰€æœ‰URLæ ¼å¼
            const invalidUrls = urls.filter(url => !isValidURL(url));
            if (invalidUrls.length > 0) {
                showToast(`ä»¥ä¸‹URLæ ¼å¼æ— æ•ˆï¼š\n${invalidUrls.join('\n')}`, 'error');
                return;
            }

            // è¯»å–é«˜çº§é…ç½®å€¼
            const runtimeDuration = parseInt(document.getElementById('runtime-duration').value) || 60000;
            const runtimeDelay = parseInt(document.getElementById('runtime-delay').value) || 10000;
            const memoryInterval = parseInt(document.getElementById('memoryleak-interval').value) || 60000;
            const memoryIterations = parseInt(document.getElementById('memoryleak-iterations').value) || 3;
            const memoryOnPageTesting = document.getElementById('memoryleak-onpagetesting').value.trim();

            // æ„å»ºrunnersé…ç½®å¯¹è±¡
            const runners = {
                Initialization: {
                    enabled: initChecked,
                    repeatCount: repeatCount
                },
                Runtime: {
                    enabled: runtimeChecked,
                    repeatCount: repeatCount,
                    durationMs: runtimeDuration,
                    delayMs: runtimeDelay
                },
                MemoryLeak: {
                    enabled: memoryChecked,
                    repeatCount: repeatCount,
                    intervalMs: memoryInterval,
                    iterations: memoryIterations,
                    onPageTesting: memoryOnPageTesting
                }
            };

            // æ”¶é›† TestCase é«˜çº§é…ç½®
            const advancedConfig = {};

            // delayMs
            const tcDelayMs = document.getElementById('testcase-delay').value.trim();
            if (tcDelayMs) {
                advancedConfig.delayMs = parseInt(tcDelayMs);
            }

            // cookie
            const cookieValue = document.getElementById('testcase-cookie').value.trim();
            if (cookieValue) {
                try {
                    advancedConfig.cookie = JSON.parse(cookieValue);
                } catch {
                    advancedConfig.cookie = cookieValue; // ä½œä¸ºå­—ç¬¦ä¸²
                }
            }

            // extraHTTPHeaders
            const headersValue = document.getElementById('testcase-headers').value.trim();
            if (headersValue) {
                try {
                    advancedConfig.extraHTTPHeaders = JSON.parse(headersValue);
                } catch (e) {
                    console.error('Invalid JSON for extraHTTPHeaders:', e);
                }
            }

            // blockList
            const blockListValue = document.getElementById('testcase-blocklist').value.trim();
            if (blockListValue) {
                try {
                    advancedConfig.blockList = JSON.parse(blockListValue);
                } catch (e) {
                    console.error('Invalid JSON for blockList:', e);
                }
            }

            // customCss
            const cssValue = document.getElementById('testcase-css').value.trim();
            if (cssValue) {
                advancedConfig.customCss = cssValue;
            }

            // deviceOptions
            const deviceType = document.getElementById('testcase-device-type').value;
            if (deviceType) {
                if (deviceType === 'Desktop') {
                    const fullscreen = document.getElementById('device-fullscreen').checked;
                    advancedConfig.deviceOptions = ['Desktop', { fullscreen }];
                } else if (deviceType === 'Mobile') {
                    const preset = document.getElementById('device-mobile-preset').value;
                    advancedConfig.deviceOptions = ['Mobile', { preset }];
                }
            }

            // ç”Ÿå‘½å‘¨æœŸé’©å­
            const hooks = {};
            const beforePageLoad = document.getElementById('hook-beforepageload').value.trim();
            if (beforePageLoad) hooks.beforePageLoad = beforePageLoad;

            const onPageLoaded = document.getElementById('hook-onpageloaded').value.trim();
            if (onPageLoaded) hooks.onPageLoaded = onPageLoaded;

            const onPageTesting = document.getElementById('hook-onpagetesting').value.trim();
            if (onPageTesting) hooks.onPageTesting = onPageTesting;

            const onPageCollecting = document.getElementById('hook-onpagecollecting').value.trim();
            if (onPageCollecting) hooks.onPageCollecting = onPageCollecting;

            const onPageUnload = document.getElementById('hook-onpageunload').value.trim();
            if (onPageUnload) hooks.onPageUnload = onPageUnload;

            if (Object.keys(hooks).length > 0) {
                advancedConfig.hooks = hooks;
            }

            const editId = document.getElementById('case-modal').dataset.editId;

            if (editId) {
                // ç¼–è¾‘æ¨¡å¼
                const testCase = testCases.find(tc => tc.id === parseInt(editId));
                if (testCase) {
                    testCase.name = name;
                    testCase.runners = runners;
                    testCase.urls = urls;
                    testCase.mode = mode;
                    testCase.repeatCount = repeatCount;
                    testCase.description = description;
                    testCase.tags = tags;
                    testCase.advancedConfig = advancedConfig;
                    // ç§»é™¤æ—§çš„å­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    delete testCase.url;
                    delete testCase.runner;
                    showToast('ç”¨ä¾‹æ›´æ–°æˆåŠŸ', 'success');
                }
            } else {
                // æ–°å¢æ¨¡å¼
                const newCase = {
                    id: Date.now(),
                    name,
                    runners,
                    urls,
                    mode,
                    repeatCount,
                    description,
                    tags,
                    advancedConfig,
                    status: 'idle',
                    createdAt: new Date().toISOString()
                };
                testCases.push(newCase);
                showToast('ç”¨ä¾‹æ·»åŠ æˆåŠŸ', 'success');
            }

            saveToStorage();
            renderCases();
            closeModal();
        }

        // åˆ é™¤ç”¨ä¾‹
        function deleteCase(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹å—ï¼Ÿ')) return;

            testCases = testCases.filter(tc => tc.id !== id);
            selectedCases.delete(id);
            saveToStorage();
            renderCases();
            showToast('ç”¨ä¾‹å·²åˆ é™¤', 'success');
        }

        // è¿è¡Œå•ä¸ªç”¨ä¾‹
        async function runCase(id) {
            const testCase = testCases.find(tc => tc.id === id);
            if (!testCase) return;

            // ç§»é™¤å•ä»»åŠ¡é™åˆ¶ï¼Œå…è®¸å¹¶å‘æ‰§è¡Œ
            const runningCount = Array.from(backendTasks.values()).filter(t => t.status === 'running').length;
            if (runningCount >= MAX_CONCURRENT) {
                showToast(`å½“å‰å·²æœ‰ ${runningCount} ä¸ªä»»åŠ¡åœ¨è¿è¡Œï¼Œå°†è¿›å…¥é˜Ÿåˆ—ç­‰å¾…`, 'info');
            }

            testCase.status = 'pending';
            renderCases();

            document.getElementById('status-card').style.display = 'block';
            document.getElementById('current-case-name').textContent = testCase.name;
            document.getElementById('current-status').textContent = 'è¿è¡Œä¸­';
            document.getElementById('current-status').className = 'status-badge status-running';

            try {
                // è·å–URLs - å…¼å®¹æ—§æ ¼å¼
                const urls = testCase.urls || (testCase.url ? [testCase.url] : []);
                const mode = testCase.mode || 'headless';

                if (urls.length === 0) {
                    throw new Error('æµ‹è¯•ç”¨ä¾‹æ²¡æœ‰é…ç½®URL');
                }

                // æ„å»º testCases æ•°ç»„ - å°† URLs è½¬æ¢ä¸º testCases å¹¶åº”ç”¨é«˜çº§é…ç½®
                const advConfig = testCase.advancedConfig || {};
                const testCasesArray = urls.map(url => {
                    const tc = {
                        target: url,
                        description: `${testCase.name} - ${url}`
                    };

                    // åº”ç”¨é«˜çº§é…ç½®
                    if (advConfig.delayMs !== undefined) tc.delayMs = advConfig.delayMs;
                    if (advConfig.cookie) tc.cookie = advConfig.cookie;
                    if (advConfig.extraHTTPHeaders) tc.extraHTTPHeaders = advConfig.extraHTTPHeaders;
                    if (advConfig.blockList) tc.blockList = advConfig.blockList;
                    if (advConfig.customCss) tc.customCss = advConfig.customCss;
                    if (advConfig.deviceOptions) tc.deviceOptions = advConfig.deviceOptions;
                    if (advConfig.hooks) tc.hooks = advConfig.hooks;

                    return tc;
                });

                // æ„å»ºrunnersé…ç½® - å…¼å®¹æ–°æ—§æ ¼å¼
                let runnersConfig = {};
                let enabledRunners = [];

                if (testCase.runners) {
                    // æ–°æ ¼å¼ï¼šå¤šrunneræ”¯æŒ
                    if (testCase.runners.Initialization?.enabled) {
                        runnersConfig.Initialization = {
                            enabled: true,
                            testCases: testCasesArray,
                            iterations: testCase.runners.Initialization.iterations || 7
                        };
                        enabledRunners.push('Initialization');
                    }

                    if (testCase.runners.Runtime?.enabled) {
                        runnersConfig.Runtime = {
                            enabled: true,
                            testCases: testCasesArray,
                            durationMs: testCase.runners.Runtime.durationMs || 60000,
                            delayMs: testCase.runners.Runtime.delayMs || 10000
                        };
                        enabledRunners.push('Runtime');
                    }

                    if (testCase.runners.MemoryLeak?.enabled) {
                        // ä¸º MemoryLeak å¤„ç† onPageTestingï¼ˆå‘åå…¼å®¹ï¼‰
                        const memoryTestCases = testCasesArray.map(tc => {
                            const mtc = { ...tc };
                            if (testCase.runners.MemoryLeak.onPageTesting) {
                                mtc.onPageTesting = testCase.runners.MemoryLeak.onPageTesting;
                            }
                            return mtc;
                        });

                        runnersConfig.MemoryLeak = {
                            enabled: true,
                            testCases: memoryTestCases,
                            intervalMs: testCase.runners.MemoryLeak.intervalMs || 60000,
                            iterations: testCase.runners.MemoryLeak.iterations || 3
                        };
                        enabledRunners.push('MemoryLeak');
                    }
                } else if (testCase.runner) {
                    // æ—§æ ¼å¼ï¼šå•ä¸ªrunner
                    runnersConfig[testCase.runner] = {
                        enabled: true,
                        testCases: testCasesArray
                    };
                    enabledRunners.push(testCase.runner);
                }

                if (Object.keys(runnersConfig).length === 0) {
                    throw new Error('æµ‹è¯•ç”¨ä¾‹æ²¡æœ‰å¯ç”¨ä»»ä½•æµ‹è¯•ç±»å‹');
                }

                // å‘é€è¯·æ±‚åˆ°åç«¯ä»»åŠ¡API
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: testCase.name, // æ·»åŠ ä»»åŠ¡åç§°
                        config: {
                            mode: {
                                anonymous: true,
                                headless: mode === 'headless'
                            },
                            runners: runnersConfig
                        }
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || result.error || 'å¯åŠ¨æµ‹è¯•å¤±è´¥');
                }

                showToast(`ä»»åŠ¡å·²åˆ›å»º: ${testCase.name}`, 'success');
                appendOutput(`[ç³»ç»Ÿ] æµ‹è¯•ç”¨ä¾‹ "${testCase.name}" å·²æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—`);
                appendOutput(`[ç³»ç»Ÿ] ä»»åŠ¡ID: ${result.taskId}`);
                appendOutput(`[ç³»ç»Ÿ] è¿è¡Œæ¨¡å¼: ${mode === 'headless' ? 'æ— å¤´æ¨¡å¼' : 'æœ‰å¤´æ¨¡å¼'}`);
                appendOutput(`[ç³»ç»Ÿ] æµ‹è¯•ç±»å‹: ${enabledRunners.join(' + ')}`);
                appendOutput(`[ç³»ç»Ÿ] æµ‹è¯• ${urls.length} ä¸ªURL, é‡å¤ ${testCase.repeatCount || 1} æ¬¡`);
            } catch (error) {
                testCase.status = 'error';
                renderCases();
                showToast('è¿è¡Œå¤±è´¥: ' + error.message, 'error');
                appendOutput(`[é”™è¯¯] ${error.message}`);
            }
        }

        // æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤º - æ˜¾ç¤ºåç«¯ä»»åŠ¡çŠ¶æ€
        function updateQueueDisplay() {
            const queueCard = document.getElementById('queue-card');
            const queueList = document.getElementById('queue-list');

            const tasks = Array.from(backendTasks.values());

            if (tasks.length === 0) {
                queueCard.style.display = 'none';
                return;
            }

            queueCard.style.display = 'block';

            // æŒ‰çŠ¶æ€æ’åºï¼šrunning -> pending -> completed -> error
            const sortedTasks = tasks.sort((a, b) => {
                const statusOrder = { running: 0, pending: 1, completed: 2, error: 3 };
                return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
            });

            const queueHTML = sortedTasks.map(task => {
                const statusIcons = {
                    running: 'ğŸ”„',
                    pending: 'â³',
                    completed: 'âœ…',
                    error: 'âŒ'
                };
                const statusTexts = {
                    running: 'æ­£åœ¨è¿è¡Œ',
                    pending: 'ç­‰å¾…ä¸­',
                    completed: 'å·²å®Œæˆ',
                    error: 'å¤±è´¥'
                };
                const bgColors = {
                    running: '#fef3c7',
                    pending: '#f3f4f6',
                    completed: '#d1fae5',
                    error: '#fee2e2'
                };

                const icon = statusIcons[task.status] || 'â“';
                const statusText = statusTexts[task.status] || 'æœªçŸ¥';
                const bgColor = bgColors[task.status] || '#f3f4f6';

                return `
                    <div style="padding: 10px; margin-bottom: 8px; background: ${bgColor}; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${escapeHtml(task.name)}</strong>
                            <span style="margin-left: 10px; color: #6b7280; font-size: 0.9em;">${icon} ${statusText}</span>
                            <span style="margin-left: 10px; color: #9ca3af; font-size: 0.85em;">${task.runner}</span>
                        </div>
                        <div>
                            ${task.status === 'running' ? `
                                <button class="btn-danger btn-small" onclick="stopTask('${task.id}')" style="margin-left: 5px;" title="ä¼˜é›…åœæ­¢ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰">åœæ­¢</button>
                                <button class="btn-danger btn-small" onclick="stopTask('${task.id}', true)" style="margin-left: 5px; background: #991b1b;" title="ç«‹å³å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹">å¼ºåˆ¶åœæ­¢</button>
                            ` : ''}
                            ${task.status === 'pending' ? `<button class="btn-danger btn-small" onclick="deleteTask('${task.id}')" style="margin-left: 5px;">å–æ¶ˆ</button>` : ''}
                            ${(task.status === 'completed' || task.status === 'error') ? `<button class="btn-secondary btn-small" onclick="deleteTask('${task.id}')" style="margin-left: 5px;">ç§»é™¤</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            queueList.innerHTML = queueHTML || '<p style="color: #9ca3af;">é˜Ÿåˆ—ä¸ºç©º</p>';
        }

        // æ–°å¢ï¼šåœæ­¢ä»»åŠ¡
        async function stopTask(taskId, force = false) {
            const task = backendTasks.get(taskId);
            if (!task) {
                showToast('ä»»åŠ¡ä¸å­˜åœ¨', 'error');
                return;
            }

            // å¦‚æœæ˜¯å¼ºåˆ¶åœæ­¢ï¼Œå…ˆç¡®è®¤
            if (force) {
                if (!confirm(`ç¡®å®šè¦å¼ºåˆ¶åœæ­¢ä»»åŠ¡"${task.name}"å—ï¼Ÿ\n\nè¿™å°†ç«‹å³ç»ˆæ­¢è¿›ç¨‹ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚`)) {
                    return;
                }
            } else {
                // æ™®é€šåœæ­¢ä¹Ÿéœ€è¦ç¡®è®¤
                if (!confirm(`ç¡®å®šè¦åœæ­¢ä»»åŠ¡"${task.name}"å—ï¼Ÿ\n\nè¿›ç¨‹å°†è¢«ä¼˜é›…å…³é—­ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰ã€‚`)) {
                    return;
                }
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(force ? 'ä»»åŠ¡å·²å¼ºåˆ¶åœæ­¢' : 'ä»»åŠ¡åœæ­¢ä¸­...', 'success');
                } else {
                    showToast('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ–°å¢ï¼šåˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ä»»åŠ¡å·²åˆ é™¤', 'success');
                    backendTasks.delete(taskId);
                    updateQueueDisplay();
                } else {
                    showToast('åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡
        function removeFromQueue(index) {
            if (index < runningQueue.length) {
                const removedId = runningQueue.splice(index, 1)[0];
                const testCase = testCases.find(tc => tc.id === removedId);
                if (testCase) {
                    showToast(`å·²ä»é˜Ÿåˆ—ç§»é™¤: ${testCase.name}`, 'success');
                }
                updateQueueDisplay();
            }
        }

        // æ¸…ç©ºé˜Ÿåˆ—
        function clearQueue() {
            if (runningQueue.length === 0) return;

            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºé˜Ÿåˆ—ä¸­çš„ ${runningQueue.length} ä¸ªä»»åŠ¡å—ï¼Ÿå½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¸ä¼šè¢«åœæ­¢ã€‚`)) return;

            // ä¿ç•™ç¬¬ä¸€ä¸ªï¼ˆæ­£åœ¨è¿è¡Œçš„ï¼‰
            if (currentRunning) {
                runningQueue = [runningQueue[0]];
            } else {
                runningQueue = [];
            }

            updateQueueDisplay();
            showToast('é˜Ÿåˆ—å·²æ¸…ç©º', 'success');
        }

        // è¿è¡Œé€‰ä¸­çš„ç”¨ä¾‹
        async function runSelectedCases() {
            if (selectedCases.size === 0) return;

            // å¦‚æœå·²æœ‰é˜Ÿåˆ—åœ¨è¿è¡Œï¼Œè¯¢é—®æ˜¯å¦è¿½åŠ 
            if (runningQueue.length > 0) {
                if (!confirm(`å½“å‰å·²æœ‰ ${runningQueue.length} ä¸ªä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ˜¯å¦è¿½åŠ æ–°ä»»åŠ¡ï¼Ÿ`)) return;
            }

            // è¿½åŠ åˆ°é˜Ÿåˆ—
            const newTasks = Array.from(selectedCases);
            runningQueue.push(...newTasks);

            showToast(`å·²æ·»åŠ  ${newTasks.length} ä¸ªç”¨ä¾‹åˆ°é˜Ÿåˆ—`, 'success');
            updateQueueDisplay();

            // å¦‚æœå½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œå¼€å§‹æ‰§è¡Œ
            if (!currentRunning) {
                await runNextInQueue();
            }
        }

        async function runNextInQueue() {
            if (runningQueue.length === 0) {
                showToast('æ‰€æœ‰ç”¨ä¾‹è¿è¡Œå®Œæˆ', 'success');
                updateQueueDisplay();
                return;
            }

            const id = runningQueue[0]; // ä¸è¦shiftï¼Œç­‰è¿è¡Œå®Œæˆåå†ç§»é™¤
            updateQueueDisplay();
            await runCase(id);
        }

        // åœæ­¢æµ‹è¯•
        async function stopTest() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showToast('æµ‹è¯•å·²åœæ­¢', 'success');
                    if (currentRunning) {
                        const testCase = testCases.find(tc => tc.id === currentRunning);
                        if (testCase) testCase.status = 'idle';
                        currentRunning = null;
                        renderCases();
                    }
                }
            } catch (error) {
                showToast('åœæ­¢å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, runner) {
            document.getElementById('current-status').textContent = getStatusText(status);
            document.getElementById('current-status').className = `status-badge status-${status}`;

            if (status === 'completed' || status === 'error') {
                if (currentRunning) {
                    const testCase = testCases.find(tc => tc.id === currentRunning);
                    if (testCase) {
                        testCase.status = status;
                        if (status === 'completed') {
                            completedToday++;
                            saveCompletedToday();
                        }
                    }
                    currentRunning = null;
                    renderCases();

                    // ä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²å®Œæˆçš„ä»»åŠ¡
                    if (runningQueue.length > 0 && runningQueue[0] === testCase?.id) {
                        runningQueue.shift();
                        updateQueueDisplay();
                    }

                    // å¦‚æœæœ‰é˜Ÿåˆ—ï¼Œç»§ç»­è¿è¡Œä¸‹ä¸€ä¸ª
                    if (runningQueue.length > 0) {
                        setTimeout(() => runNextInQueue(), 2000);
                    }
                }
            }
        }

        function updateProgress(current, total) {
            document.getElementById('progress-text').textContent = `${current}/${total}`;
            const percent = (current / total) * 100;
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        // è¾“å‡ºæ—¥å¿—
        function appendOutput(text) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            output.textContent += `\n[${timestamp}] ${text}`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = 'ç­‰å¾…æµ‹è¯•è¿è¡Œ...';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('case-modal').classList.remove('active');
        }

        // å¯¼å‡ºç”¨ä¾‹
        function exportCases() {
            const dataStr = JSON.stringify(testCases, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `test-cases-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showToast('ç”¨ä¾‹å·²å¯¼å‡º', 'success');
        }

        // å¯¼å…¥ç”¨ä¾‹
        function importCases() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            testCases = imported;
                            saveToStorage();
                            renderCases();
                            showToast(`æˆåŠŸå¯¼å…¥ ${imported.length} ä¸ªç”¨ä¾‹`, 'success');
                        } else {
                            throw new Error('æ ¼å¼é”™è¯¯');
                        }
                    } catch (error) {
                        showToast('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // åŠ è½½é¢„è®¾ç”¨ä¾‹
        function loadPresetCases() {
            const presets = [
                {
                    id: Date.now(),
                    name: 'ğŸ“Š ç¤ºä¾‹1: Bç«™é¦–é¡µ - åŸºç¡€æ€§èƒ½æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 3, iterations: 7 },
                        Runtime: { enabled: false },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'æµ‹è¯•Bç«™é¦–é¡µçš„åˆå§‹åŒ–æ€§èƒ½ï¼ˆå†·å¯åŠ¨ï¼‰',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'åŸºç¡€'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {}
                },
                {
                    id: Date.now() + 1,
                    name: 'ğŸ¬ ç¤ºä¾‹2: Bç«™è§†é¢‘é¡µ - Runtimeæ€§èƒ½ç›‘æ§',
                    runners: {
                        Initialization: { enabled: false },
                        Runtime: { enabled: true, repeatCount: 3, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com/video/BV1xx411c7mD'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'ç›‘æ§è§†é¢‘é¡µ30ç§’è¿è¡Œæ—¶æ€§èƒ½ï¼Œæµ‹è¯•FPSå’Œé•¿ä»»åŠ¡',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'runtime'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        hooks: {
                            onPageLoaded: 'console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§...");',
                            onPageTesting: '// ç‚¹å‡»æ’­æ”¾æŒ‰é’®\nawait page.click(".bpx-player-ctrl-btn");'
                        }
                    }
                },
                {
                    id: Date.now() + 2,
                    name: 'ğŸ§  ç¤ºä¾‹3: å†…å­˜æ³„æ¼æ£€æµ‹ - è§†é¢‘åˆ‡æ¢',
                    runners: {
                        Initialization: { enabled: false },
                        Runtime: { enabled: false },
                        MemoryLeak: { enabled: true, repeatCount: 3, intervalMs: 30000, iterations: 3, onPageTesting: '// æ¨¡æ‹Ÿè§†é¢‘åˆ‡æ¢æ“ä½œ\nawait page.evaluate(() => {\n  // è§¦å‘å¯èƒ½çš„å†…å­˜æ³„æ¼æ“ä½œ\n  window.scrollTo(0, document.body.scrollHeight);\n});' }
                    },
                    urls: ['https://www.bilibili.com/video/BV1xx411c7mD'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'æ£€æµ‹è§†é¢‘é¡µé¢çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œé‡å¤æ‰§è¡Œé¡µé¢æ“ä½œ',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'å†…å­˜æ³„æ¼'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {}
                },
                {
                    id: Date.now() + 3,
                    name: 'ğŸš€ ç¤ºä¾‹4: å¤šé¡µé¢å¯¹æ¯”æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 3, iterations: 5 },
                        Runtime: { enabled: true, repeatCount: 3, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: [
                        'https://www.bilibili.com',
                        'https://www.bilibili.com/video/BV1xx411c7mD',
                        'https://t.bilibili.com',
                        'https://space.bilibili.com'
                    ],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'å¯¹æ¯”æµ‹è¯•Bç«™ä¸åŒé¡µé¢çš„æ€§èƒ½è¡¨ç°',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'å¤šé¡µé¢'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {}
                },
                {
                    id: Date.now() + 4,
                    name: 'ğŸ“± ç¤ºä¾‹5: ç§»åŠ¨ç«¯æ¨¡æ‹Ÿ - æ€§èƒ½æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 3, iterations: 5 },
                        Runtime: { enabled: true, repeatCount: 3, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://m.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'æ¨¡æ‹Ÿç§»åŠ¨è®¾å¤‡æµ‹è¯•Bç«™ç§»åŠ¨ç«¯æ€§èƒ½',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'ç§»åŠ¨ç«¯'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        deviceOptions: ['Mobile', { preset: 'android' }]
                    }
                },
                {
                    id: Date.now() + 5,
                    name: 'ğŸš« ç¤ºä¾‹6: é˜»æ­¢èµ„æºåŠ è½½ - ä¼˜åŒ–æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 3, iterations: 5 },
                        Runtime: { enabled: false },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'é˜»æ­¢å›¾ç‰‡å’Œå­—ä½“åŠ è½½ï¼Œæµ‹è¯•æ ¸å¿ƒé¡µé¢æ€§èƒ½',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'èµ„æºä¼˜åŒ–'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        blockList: ['*.jpg', '*.png', '*.webp', '*.woff', '*.woff2'],
                        hooks: {
                            beforePageLoad: 'console.log("å·²é˜»æ­¢å›¾ç‰‡å’Œå­—ä½“åŠ è½½");'
                        }
                    }
                },
                {
                    id: Date.now() + 6,
                    name: 'ğŸ¨ ç¤ºä¾‹7: è‡ªå®šä¹‰CSS - éšè—å¹¿å‘Š',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 3, iterations: 5 },
                        Runtime: { enabled: true, repeatCount: 3, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'æ³¨å…¥è‡ªå®šä¹‰CSSéšè—å¹¿å‘Šå…ƒç´ ï¼Œæµ‹è¯•æ€§èƒ½å½±å“',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'css'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        customCss: '.ad-report, .bili-banner, [class*="ad-"] { display: none !important; }'
                    }
                },
                {
                    id: Date.now() + 7,
                    name: 'ğŸ”„ ç¤ºä¾‹8: å…¨é¢æµ‹è¯• - æ‰€æœ‰Runner',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 2, iterations: 5, includeWarmNavigation: false },
                        Runtime: { enabled: true, repeatCount: 2, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: true, repeatCount: 2, intervalMs: 30000, iterations: 2, onPageTesting: 'await page.evaluate(() => window.scrollTo(0, 500));' }
                    },
                    urls: ['https://www.bilibili.com/video/BV1xx411c7mD'],
                    mode: 'headless',
                    repeatCount: 2,
                    description: 'å¯¹è§†é¢‘é¡µæ‰§è¡Œå…¨é¢æ€§èƒ½æµ‹è¯•ï¼šåˆå§‹åŒ–ã€è¿è¡Œæ—¶ã€å†…å­˜æ³„æ¼',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'å…¨é¢æµ‹è¯•'],
                    status: 'idle',
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        delayMs: 5000,
                        hooks: {
                            onPageLoaded: 'console.log("é¡µé¢åŠ è½½å®Œæˆ");',
                            onPageTesting: 'console.log("å¼€å§‹æ€§èƒ½æµ‹è¯•");',
                            onPageUnload: 'console.log("æµ‹è¯•å®Œæˆï¼Œæ¸…ç†é¡µé¢");'
                        }
                    }
                }
            ];

            testCases = [...testCases, ...presets];
            saveToStorage();
            renderCases();
            showToast(`âœ… å·²åŠ è½½ ${presets.length} ä¸ªå®æˆ˜ç¤ºä¾‹ï¼åŒ…å«åŸºç¡€æµ‹è¯•ã€é«˜çº§é…ç½®ã€ç”Ÿå‘½å‘¨æœŸé’©å­ç­‰åŠŸèƒ½æ¼”ç¤º`, 'success');
        }

        // å·¥å…·å‡½æ•°
        function saveToStorage() {
            localStorage.setItem('testCases', JSON.stringify(testCases));
        }

        function saveCompletedToday() {
            localStorage.setItem('completedToday', completedToday.toString());
            localStorage.setItem('completedDate', new Date().toDateString());
            updateStats();
        }

        function loadCompletedToday() {
            const savedDate = localStorage.getItem('completedDate');
            const today = new Date().toDateString();

            if (savedDate === today) {
                completedToday = parseInt(localStorage.getItem('completedToday') || '0');
            } else {
                completedToday = 0;
                localStorage.setItem('completedDate', today);
                localStorage.setItem('completedToday', '0');
            }
            updateStats();
        }

        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStatusText(status) {
            const statusMap = {
                'idle': 'ç©ºé—²',
                'running': 'è¿è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'error': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('case-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + N: æ–°å»ºç”¨ä¾‹
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showAddCaseModal();
            }

            // Esc: å…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = () => {
            if (ws) ws.close();
            if (reconnectTimer) clearTimeout(reconnectTimer);
        };
    </script>
</body>
</html>
