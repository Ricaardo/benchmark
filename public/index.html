<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Web Runner - ç”¨ä¾‹ç®¡ç†</title>

    <!-- ç»Ÿä¸€è®¾è®¡ç³»ç»Ÿ -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/navigation.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/enhanced-ui.css">
    <link rel="stylesheet" href="/css/common-components.css">
    <link rel="stylesheet" href="/css/button-fixes.css">
    <link rel="stylesheet" href="/worker-selector.css">

</head>
<body>
    <div class="container">
        <!-- å…¨å±€å¯¼èˆªæ  -->
        <nav class="navbar animate-fade-in-down" id="main-navbar">
            <a href="/" class="navbar-brand">
                <span class="navbar-logo">ğŸš€</span>
                <div>
                    <h1 class="navbar-title">Benchmark Web Runner</h1>
                    <p class="navbar-subtitle">ç”¨ä¾‹é©±åŠ¨çš„æ€§èƒ½æµ‹è¯•å¹³å°</p>
                </div>
            </a>

            <button class="navbar-toggle" id="navbar-toggle" onclick="toggleMobileMenu()">
                <span class="navbar-toggle-bar"></span>
                <span class="navbar-toggle-bar"></span>
                <span class="navbar-toggle-bar"></span>
            </button>

            <div class="navbar-menu" id="navbar-menu">
                <a href="/" class="navbar-item active">
                    <span>ğŸ“‹</span> ç”¨ä¾‹ç®¡ç†
                </a>
                <a href="/records.html" class="navbar-item">
                    <span>ğŸ“Š</span> æµ‹è¯•è®°å½•
                </a>
                <a href="/workers.html" class="navbar-item">
                    <span>ğŸ–¥ï¸</span> èŠ‚ç‚¹ç®¡ç†
                </a>
                <a href="/api.html" class="navbar-item">
                    <span>ğŸ”‘</span> APIç®¡ç†
                </a>
            </div>

            <div class="navbar-actions">
                <button class="btn btn-secondary btn-sm" onclick="showGlobalConfigModal()">
                    <span>âš™ï¸</span> å…¨å±€è®¾ç½®
                </button>
            </div>
        </nav>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-cases">0</div>
                <div class="stat-label">æµ‹è¯•ç”¨ä¾‹æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="running-cases">0</div>
                <div class="stat-label">æ­£åœ¨è¿è¡Œ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completed-today">0</div>
                <div class="stat-label">ä»Šæ—¥å®Œæˆ</div>
            </div>
        </div>

        <!-- ç”¨ä¾‹ç®¡ç†é¢æ¿ -->
        <div class="card">
            <h2>ğŸ“‹ æµ‹è¯•ç”¨ä¾‹ç®¡ç†</h2>

            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn btn-primary" onclick="showAddCaseModal()">â• æ·»åŠ ç”¨ä¾‹</button>
                    <button class="btn btn-success" onclick="runSelectedCases()" id="run-selected-btn" disabled>âš¡ å¹¶è¡Œè¿è¡Œ (<span id="selected-count">0</span>)</button>
                    <button class="btn-secondary btn-sm" onclick="duplicateSelectedCases()" id="duplicate-selected-btn" disabled style="background: #3182ce; color: white;">ğŸ“‹ å¤åˆ¶é€‰ä¸­</button>
                    <button class="btn-danger btn-sm" onclick="deleteSelectedCases()" id="delete-selected-btn" disabled>ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
                    <button class="btn-secondary btn-sm" onclick="loadPresetCases()">âš¡ åŠ è½½é¢„è®¾</button>
                </div>
                <div class="toolbar-right">
                    <button class="btn-secondary btn-sm" onclick="exportCases()">ğŸ“¤ å¯¼å‡º</button>
                    <button class="btn-secondary btn-sm" onclick="importCases()">ğŸ“¥ å¯¼å…¥</button>
                    <button class="btn-secondary btn-sm" onclick="window.location.href='/api.html'">ğŸ”‘ APIç®¡ç†</button>
                </div>
            </div>

            <!-- æœç´¢å’Œç­›é€‰å·¥å…·æ  -->
            <div class="search-toolbar" style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="ğŸ” æœç´¢ç”¨ä¾‹åç§°ã€æè¿°..."
                        style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        oninput="filterTestCases()"
                    />
                    <button
                        onclick="clearSearch()"
                        id="clear-search-btn"
                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999; font-size: 18px; padding: 0 8px; display: none;"
                        title="æ¸…é™¤æœç´¢"
                    >âœ•</button>
                </div>
                <div style="position: relative;">
                    <input
                        type="text"
                        id="tag-filter-input"
                        placeholder="ğŸ·ï¸ æ ‡ç­¾ç­›é€‰ (é€—å·åˆ†éš”)"
                        style="width: 250px; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        oninput="filterTestCases()"
                    />
                    <button
                        onclick="clearTagFilter()"
                        id="clear-tag-btn"
                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999; font-size: 18px; padding: 0 8px; display: none;"
                        title="æ¸…é™¤æ ‡ç­¾ç­›é€‰"
                    >âœ•</button>
                </div>
                <button class="btn-secondary btn-sm" onclick="resetFilters()">ğŸ”„ é‡ç½®ç­›é€‰</button>
            </div>

            <div id="cases-container">
                <div class="empty-state">
                    <h3>æš‚æ— æµ‹è¯•ç”¨ä¾‹</h3>
                    <p>ç‚¹å‡»"æ·»åŠ ç”¨ä¾‹"åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹</p>
                </div>
            </div>
        </div>

        <!-- Worker èŠ‚ç‚¹é€‰æ‹©å™¨ -->
        <div class="card" id="worker-selector-card">
            <h2>ğŸ–¥ï¸ æ‰§è¡ŒèŠ‚ç‚¹é€‰æ‹©</h2>
            <div id="workerSelectorContainer"></div>
        </div>

        <!-- ä»»åŠ¡é˜Ÿåˆ— -->
        <div class="card" id="queue-card" style="display:none;">
            <h2>ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ—</h2>
            <div id="queue-list" style="margin-top: 15px;"></div>
            <div style="margin-top: 15px;">
                <button class="btn-danger btn-sm" onclick="clearQueue()">æ¸…ç©ºé˜Ÿåˆ—</button>
            </div>
        </div>

        <!-- è¾“å‡ºé¢æ¿ -->
        <div class="card">
            <h2>ğŸ’» è¾“å‡ºæ—¥å¿—</h2>
            <div class="output-panel" id="output">
                ç­‰å¾…æµ‹è¯•è¿è¡Œ...
            </div>
            <div style="margin-top: 15px;">
                <button class="btn-secondary btn-sm" onclick="clearOutput()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn-secondary btn-sm" onclick="stopTest()">â¹ åœæ­¢æµ‹è¯•</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç”¨ä¾‹æ¨¡æ€æ¡† -->
    <div class="modal" id="case-modal">
        <div class="modal-content">
            <div class="modal-header">â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹</div>

            <!-- ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬ä¿¡æ¯ ========== -->
            <div class="config-card">
                <div class="config-card-title">ğŸ“ åŸºæœ¬ä¿¡æ¯</div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568;">ç”¨ä¾‹åç§° *</label>
                    <input type="text" id="case-name" placeholder="ä¾‹å¦‚ï¼šBç«™é¦–é¡µæ€§èƒ½æµ‹è¯•" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568;">æè¿°å’Œæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="case-description" placeholder="æµ‹è¯•æè¿°..." style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em;">
                    <input type="text" id="case-tags" placeholder="æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰..." style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.9em;">
                </div>

                <div style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568;">ğŸ–¥ï¸ æ‰§è¡ŒèŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰</label>
                    <select id="case-worker" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                        <option value="">è‡ªåŠ¨åˆ†é…ï¼ˆæ¨èï¼‰</option>
                    </select>
                    <small style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px;">
                        é€‰æ‹©ç‰¹å®šèŠ‚ç‚¹æ‰§è¡Œæµ‹è¯•ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨åˆ†é…å¯ç”¨èŠ‚ç‚¹
                    </small>
                </div>
            </div>

            <!-- ========== ç¬¬äºŒéƒ¨åˆ†ï¼šæµ‹è¯•é…ç½® ========== -->
            <div class="config-card">
                <div class="config-card-title">âš™ï¸ æµ‹è¯•é…ç½®</div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568;">æµ‹è¯•ç±»å‹ *ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="padding: 10px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.borderColor='#cbd5e0'" onmouseout="this.style.borderColor='#e2e8f0'">
                            <input type="checkbox" id="runner-initialization">
                            <span style="font-size: 0.9em; font-weight: 500;">ğŸš€ Initialization</span>
                        </label>
                        <label style="padding: 10px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.borderColor='#cbd5e0'" onmouseout="this.style.borderColor='#e2e8f0'">
                            <input type="checkbox" id="runner-runtime">
                            <span style="font-size: 0.9em; font-weight: 500;">â±ï¸ Runtime</span>
                        </label>
                        <label style="padding: 10px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.borderColor='#cbd5e0'" onmouseout="this.style.borderColor='#e2e8f0'">
                            <input type="checkbox" id="runner-memoryleak">
                            <span style="font-size: 0.9em; font-weight: 500;">ğŸ§  MemoryLeak</span>
                        </label>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568;">è¿è¡Œæ¨¡å¼</label>
                        <select id="case-mode" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                            <option value="headless">ğŸš€ Headlessï¼ˆåå°è¿è¡Œï¼‰</option>
                            <option value="headed">ğŸ‘ï¸ Headedï¼ˆæ˜¾ç¤ºç•Œé¢ï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568;">é‡å¤æ¬¡æ•°</label>
                        <input type="number" id="case-repeat" value="1" min="1" max="100" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: #f7fafc; border-radius: 6px;">
                            <input type="checkbox" id="case-anonymous" checked onchange="toggleAnonymousMode()">
                            <span style="font-weight: 500; color: #4a5568;">åŒ¿åæ¨¡å¼</span>
                        </label>
                        <small style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px; margin-left: 4px;">
                            å¼€å¯åå°†ç¦ç”¨Cookieç™»å½•æ€é…ç½®
                        </small>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568;">CPU èŠ‚æµå€æ•°</label>
                        <input type="number" id="case-cpu-throttling" value="1" min="1" max="20" step="1" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                        <small style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px;">
                            1=æ— èŠ‚æµï¼Œ2=2å€æ…¢ï¼Œ4=4å€æ…¢
                        </small>
                    </div>
                </div>

                <!-- Cookieé…ç½® -->
                <div id="cookie-config-section" style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568;">ğŸª ç™»å½•æ€é…ç½®</label>
                    <select id="cookie-mode" onchange="toggleCookieMode()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em; margin-bottom: 10px;">
                        <option value="auto">ğŸ”„ è‡ªåŠ¨è·å–ï¼ˆæ¨èï¼‰</option>
                        <option value="manual">âœï¸ æ‰‹åŠ¨é…ç½®</option>
                    </select>

                    <!-- è‡ªåŠ¨è·å–é…ç½® -->
                    <div id="auto-cookie-config" style="display: none; background: #f7fafc; padding: 12px; border-radius: 6px; border: 1px solid #cbd5e0;">
                        <select id="auto-cookie-preset" onchange="applyAutoCookiePreset()" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; margin-bottom: 10px; font-size: 0.9em;">
                            <option value="">è‡ªå®šä¹‰UID...</option>
                            <option value="uat:110000233">UATæµ‹è¯•è´¦å·</option>
                            <option value="prod:3546793358919882">ç”Ÿäº§æµ‹è¯•è´¦å·</option>
                        </select>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="text" id="auto-cookie-uid" placeholder="ç”¨æˆ·UID" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;">
                            <select id="auto-cookie-env" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;">
                                <option value="prod">ç”Ÿäº§</option>
                                <option value="uat">UAT</option>
                            </select>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨é…ç½® -->
                    <div id="manual-cookie-config" style="display: none;">
                        <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                            <select id="cookie-preset" onchange="applyCookiePreset()" style="flex: 1; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;">
                                <option value="">é€‰æ‹©é¢„è®¾...</option>
                                <option value="bilibili_login">Bç«™ç™»å½•æ€</option>
                                <option value="youtube_login">YouTubeç™»å½•æ€</option>
                            </select>
                            <button type="button" onclick="showAutoFetchCookieModal()" class="btn-sm" style="padding: 8px 12px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">è·å–</button>
                        </div>
                        <textarea id="testcase-cookie" placeholder='{"name": "value"} æˆ– "name=value"' rows="2" style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"></textarea>
                    </div>
                </div>
            </div>

            <!-- ========== ç¬¬ä¸‰éƒ¨åˆ†ï¼šRunneré…ç½®ï¼ˆé’ˆå¯¹é€‰ä¸­çš„æµ‹è¯•ç±»å‹ï¼‰ ========== -->
            <div class="config-card" id="runner-config-card" style="display: none;">
                <div class="config-card-title">ğŸ¯ Runner è¯¦ç»†é…ç½®</div>

                <!-- Initialization é…ç½® -->
                <div id="initialization-config" style="display: none; padding: 15px; background: #f7fafc; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: #4a5568; margin-bottom: 12px; font-size: 1.05em;">ğŸš€ Initialization é…ç½®</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">è¿­ä»£æ¬¡æ•°</label>
                            <input type="number" id="initialization-iterations" value="7" min="1" max="20" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤ 7 æ¬¡</small>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: white; border-radius: 4px;">
                                <input type="checkbox" id="initialization-include-warm">
                                <span style="font-size: 0.9em;">åŒ…å«çƒ­å¯åŠ¨æµ‹è¯•</span>
                            </label>
                            <small style="color: #718096; font-size: 0.85em; display: block; margin-top: 4px; margin-left: 4px;">æ˜¯å¦æµ‹è¯•çƒ­å¯åŠ¨ï¼Œé»˜è®¤å¦</small>
                        </div>
                    </div>
                </div>

                <!-- Runtime é…ç½® -->
                <div id="runtime-config" style="display: none; padding: 15px; background: #f7fafc; border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: #4a5568; margin-bottom: 12px; font-size: 1.05em;">â±ï¸ Runtime é…ç½®</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">æŒç»­æ—¶é—´ (æ¯«ç§’)</label>
                            <input type="number" id="runtime-duration" value="60000" min="1000" step="1000" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤ 60000ms (60ç§’)</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">å»¶è¿Ÿæ—¶é—´ (æ¯«ç§’)</label>
                            <input type="number" id="runtime-delay" value="10000" min="0" step="1000" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é¡µé¢åŠ è½½åç­‰å¾…ï¼Œé»˜è®¤ 10000ms</small>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #4a5568;">æ”¶é›†çš„æŒ‡æ ‡ç±»å‹</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <label style="padding: 8px; background: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                                <input type="checkbox" id="metric-runtime" checked>
                                <span>runtime</span>
                            </label>
                            <label style="padding: 8px; background: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                                <input type="checkbox" id="metric-longtask" checked>
                                <span>longtask</span>
                            </label>
                            <label style="padding: 8px; background: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                                <input type="checkbox" id="metric-longanimationframe">
                                <span>longAnimationFrame</span>
                            </label>
                            <label style="padding: 8px; background: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                                <input type="checkbox" id="metric-fps">
                                <span>fps</span>
                            </label>
                            <label style="padding: 8px; background: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85em;">
                                <input type="checkbox" id="metric-system">
                                <span>system</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- MemoryLeak é…ç½® -->
                <div id="memoryleak-config" style="display: none; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <div style="font-weight: 600; color: #4a5568; margin-bottom: 12px; font-size: 1.05em;">ğŸ§  MemoryLeak é…ç½®</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">æ£€æµ‹é—´éš”</label>
                            <input type="number" id="memoryleak-interval" value="60000" min="1000" step="1000" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤ 60000ms</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">è¿­ä»£æ¬¡æ•°</label>
                            <input type="number" id="memoryleak-iterations" value="3" min="1" max="20" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤ 3æ¬¡</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">å»¶è¿Ÿæ—¶é—´</label>
                            <input type="number" id="memoryleak-delay" value="10000" min="0" step="1000" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤ 10000ms</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">å†·é™æ—¶é—´</label>
                            <input type="number" id="memoryleak-cooldown" value="3000" min="0" step="1000" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                            <small style="color: #718096; font-size: 0.85em;">é»˜è®¤ 3000ms</small>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 0.9em; color: #4a5568;">é¡µé¢æ“ä½œä»£ç  (onPageTesting)</label>
                        <div style="margin-bottom: 8px;">
                            <select id="memoryleak-onpagetesting-preset" onchange="applyMemoryLeakTestingPreset()" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em; background: #edf2f7;">
                                <option value="">âœ¨ é€‰æ‹©é¢„è®¾æ“ä½œ...</option>
                                <option value="click_play">â–¶ï¸ ç‚¹å‡»æ’­æ”¾æŒ‰é’®</option>
                                <option value="video_switch">ğŸ”„ åˆ‡æ¢è§†é¢‘</option>
                                <option value="scroll_page">ğŸ“œ é¡µé¢æ»šåŠ¨</option>
                                <option value="tab_switch">ğŸ” æ ‡ç­¾é¡µåˆ‡æ¢</option>
                                <option value="popup_open_close">ğŸªŸ å¼¹çª—å¼€å…³</option>
                                <option value="list_scroll">ğŸ“‹ åˆ—è¡¨æ— é™æ»šåŠ¨</option>
                                <option value="image_load">ğŸ–¼ï¸ åŠ¨æ€åŠ è½½å›¾ç‰‡</option>
                                <option value="bilibili_danmaku">ğŸ…±ï¸ Bç«™å¼¹å¹•å¼€å…³</option>
                            </select>
                        </div>
                        <textarea id="memoryleak-onpagetesting" placeholder="// è§¦å‘å†…å­˜æ³„éœ²çš„æ“ä½œ&#10;// ä¾‹å¦‚: await page.click('.play-button');" rows="3" style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"></textarea>
                        <small style="color: #718096; font-size: 0.85em;">ç•™ç©ºåˆ™é™ç½®é¡µé¢</small>
                    </div>
                </div>

                <p id="no-runner-config" style="color: #9ca3af; margin: 0; text-align: center; padding: 20px;">é€‰æ‹©æµ‹è¯•ç±»å‹åæ˜¾ç¤ºå¯¹åº”é…ç½®</p>
            </div>

            <!-- ========== URLåˆ—è¡¨ï¼ˆç§»åˆ°è¿™é‡Œï¼‰ ========== -->
            <div class="config-card">
                <div class="config-card-title">ğŸŒ æµ‹è¯•URL</div>
                <div style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568;">æµ‹è¯•URL * <button type="button" class="btn-secondary btn-sm" onclick="addUrlItem()" style="padding: 4px 10px; font-size: 0.85em; margin-left: 8px;">â• æ·»åŠ URL</button></label>
                    <div id="url-list" style="background: #f7fafc; padding: 12px; border-radius: 6px; border: 1px solid #cbd5e0;">
                        <!-- URL é¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveCase()">ğŸ’¾ ä¿å­˜ç”¨ä¾‹</button>
            </div>
        </div>
    </div>

    <!-- Cookieè‡ªåŠ¨è·å–å¼¹çª— -->
    <div class="modal" id="cookie-fetch-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">ğŸ”„ è‡ªåŠ¨è·å–Cookie</div>

            <div class="form-group">
                <label>é€‰æ‹©é¢„è®¾è´¦å·</label>
                <select id="cookie-account-preset" onchange="selectCookiePreset()" style="width: 100%; padding: 8px;">
                    <option value="">è‡ªå®šä¹‰UID...</option>
                    <option value="uat:110000233">UATæµ‹è¯•è´¦å· (110000233)</option>
                    <option value="prod:3546793358919882">ç”Ÿäº§æµ‹è¯•è´¦å· (3546793358919882)</option>
                </select>
            </div>

            <div class="form-group">
                <label>UID *</label>
                <input type="text" id="cookie-uid" placeholder="è¾“å…¥ç”¨æˆ·UID" style="width: 100%; padding: 8px;">
            </div>

            <div class="form-group">
                <label>ç¯å¢ƒ *</label>
                <select id="cookie-env" style="width: 100%; padding: 8px;">
                    <option value="prod">ç”Ÿäº§ç¯å¢ƒ (Prod)</option>
                    <option value="uat">UATç¯å¢ƒ (UAT)</option>
                </select>
                <small style="color: #718096; font-size: 0.85em;">
                    â€¢ ç”Ÿäº§ç¯å¢ƒ: http://melloi.bilibili.co<br>
                    â€¢ UATç¯å¢ƒ: http://hassan.bilibili.co
                </small>
            </div>

            <div class="form-group">
                <label>Cookieæ ¼å¼</label>
                <select id="cookie-format" style="width: 100%; padding: 8px;">
                    <option value="string">å­—ç¬¦ä¸²æ ¼å¼ (æ¨è)</option>
                    <option value="json">JSONå¯¹è±¡æ ¼å¼</option>
                </select>
            </div>

            <!-- CookieéªŒè¯ç»“æœåŒºåŸŸ -->
            <div id="cookie-validation-result" style="display: none; margin-top: 15px; padding: 12px; border-radius: 6px; font-size: 0.9em;">
                <div id="cookie-validation-message"></div>
                <div id="cookie-validation-details" style="margin-top: 8px; font-size: 0.85em; color: #718096;"></div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeCookieFetchModal()">å–æ¶ˆ</button>
                <button class="btn btn-secondary" onclick="validateCurrentCookie()" style="background: #3182ce; color: white;">ğŸ” éªŒè¯Cookie</button>
                <button class="btn btn-primary" onclick="fetchAndApplyCookie()">è·å–å¹¶åº”ç”¨</button>
            </div>
        </div>
    </div>

    <!-- å…¨å±€è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="global-config-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">âš™ï¸ å…¨å±€è®¾ç½®</div>

            <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #4a5568; font-size: 1.1em;">ğŸ”§ ç³»ç»Ÿé…ç½®</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568;">Chrome å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„</label>
                    <input type="text" id="global-executable-path" placeholder="ç•™ç©ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤Chrome" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                    <small style="color: #718096; display: block; margin-top: 6px;">
                        æŒ‡å®šè‡ªå®šä¹‰Chromeæµè§ˆå™¨è·¯å¾„<br>
                        <strong>ç¤ºä¾‹:</strong> /Applications/Google Chrome.app/Contents/MacOS/Google Chrome
                    </small>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568;">æœ¬åœ°æœåŠ¡ç«¯å£</label>
                    <input type="number" id="global-port" placeholder="é»˜è®¤: 3000 / 8000 / 8080" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95em;">
                    <small style="color: #718096; display: block; margin-top: 6px;">
                        ä»…åœ¨æµ‹è¯•æœ¬åœ°HTMLæ–‡ä»¶æ—¶ä½¿ç”¨,ç•™ç©ºä½¿ç”¨é»˜è®¤ç«¯å£
                    </small>
                </div>
            </div>

            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <strong style="color: #856404; display: block; margin-bottom: 8px;">ğŸ’¡ æç¤º</strong>
                <p style="color: #856404; margin: 0; font-size: 0.9em; line-height: 1.5;">
                    å…¶ä»–é…ç½®(å¦‚åŒ¿åæ¨¡å¼ã€æ— å¤´æ¨¡å¼ã€CPUèŠ‚æµç­‰)å·²æ•´åˆåˆ°ç”¨ä¾‹é…ç½®ä¸­,å¯åœ¨åˆ›å»ºæˆ–ç¼–è¾‘æµ‹è¯•ç”¨ä¾‹æ—¶è®¾ç½®ã€‚
                </p>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeGlobalConfigModal()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="saveGlobalConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- æµ‹è¯•æ ‡è®°è¾“å…¥å¼¹çª— -->
    <div class="modal" id="test-label-modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">ğŸ·ï¸ è®¾ç½®æµ‹è¯•æ ‡è®°</div>

            <div style="margin-bottom: 20px;">
                <p style="color: #4a5568; margin-bottom: 15px; line-height: 1.6;">
                    ä¸ºæœ¬æ¬¡æµ‹è¯•æ·»åŠ æ ‡è®°ï¼Œä»¥ä¾¿åœ¨ç»“æœä¸­åŒºåˆ†ä¸åŒç‰ˆæœ¬æˆ–é…ç½®ã€‚
                </p>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4a5568;">æµ‹è¯•æ ‡è®°ï¼ˆå¯é€‰ï¼‰</label>
                    <input
                        type="text"
                        id="test-label-input"
                        placeholder="ä¾‹å¦‚ï¼šä¼˜åŒ–å‰ã€V2.0ã€ä¸»åˆ†æ”¯..."
                        style="width: 100%; padding: 12px; border: 2px solid #cbd5e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s;"
                        onfocus="this.style.borderColor='#3182ce'"
                        onblur="this.style.borderColor='#cbd5e0'">
                </div>

                <div style="background: #f0f9ff; border-left: 4px solid #3182ce; padding: 12px; border-radius: 4px; margin-top: 15px;">
                    <strong style="color: #1e40af; display: block; margin-bottom: 6px; font-size: 0.9em;">ğŸ’¡ å»ºè®®æ ‡è®°æ ¼å¼</strong>
                    <ul style="color: #1e40af; margin: 0; padding-left: 20px; font-size: 0.85em; line-height: 1.8;">
                        <li>ä¼˜åŒ–å‰ / ä¼˜åŒ–å</li>
                        <li>Baseline / V2.0 / V3.0</li>
                        <li>ä¸»åˆ†æ”¯ / åŠŸèƒ½åˆ†æ”¯</li>
                        <li>Chrome / Firefox / Safari</li>
                    </ul>
                </div>
            </div>

            <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="cancelTestLabelInput()" style="padding: 10px 20px;">å–æ¶ˆ</button>
                <button class="btn btn-secondary" onclick="confirmTestLabelInput(null)" style="padding: 10px 20px; background: #94a3b8;">è·³è¿‡</button>
                <button class="btn btn-primary" onclick="confirmTestLabelInput()" style="padding: 10px 24px; background: #3182ce;">
                    â–¶ï¸ å¼€å§‹æµ‹è¯•
                </button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥é¢„è®¾åº“ -->
    <script src="operation-presets.js"></script>
    <script src="config-presets.js"></script>
    <script src="hook-presets.js"></script>

    <script>
        // ç‰ˆæœ¬æ£€æŸ¥ - ç”¨äºè°ƒè¯•
        const PAGE_VERSION = '2025-11-24-v6-fix-edit-bug';
        console.log('='.repeat(60));
        console.log('é¡µé¢ç‰ˆæœ¬:', PAGE_VERSION);
        console.log('åŠ è½½æ—¶é—´:', new Date().toLocaleString());
        console.log('âœ¨ é‡å¤§æ›´æ–°: æ‰§è¡Œä¸é…ç½®è§£è€¦');
        console.log('âœ“ ç§»é™¤æµ‹è¯•ç”¨ä¾‹ status å­—æ®µ');
        console.log('âœ“ åˆ›å»ºç‹¬ç«‹çš„æµ‹è¯•è®°å½•é¡µé¢ (records.html)');
        console.log('âœ“ æµ‹è¯•ç”¨ä¾‹é¡µé¢ä¸“æ³¨äºé…ç½®ç®¡ç†');
        console.log('='.repeat(60));

        // æ•°æ®å­˜å‚¨
        let testCases = JSON.parse(localStorage.getItem('testCases') || '[]');
        let selectedCases = new Set();
        let currentRunning = null; // ä¿ç•™ç”¨äºå‘åå…¼å®¹
        let runningQueue = [];
        let completedToday = 0;

        // æ–°å¢ï¼šåç«¯ä»»åŠ¡ç®¡ç†
        let backendTasks = new Map(); // taskId -> taskå¯¹è±¡
        const MAX_CONCURRENT = 3;
        let serverMaxConcurrent = 10; // æœåŠ¡å™¨çš„å¹¶å‘é™åˆ¶ï¼Œä»APIè·å–

        // Worker èŠ‚ç‚¹é€‰æ‹©å™¨
        let workerSelector = null;

        // ==================== é¢„è®¾ç³»ç»Ÿ ====================
        let currentPresetParams = {}; // å½“å‰é¢„è®¾çš„å‚æ•°å€¼

        // ConfigPresets å·²åœ¨ config-presets.js ä¸­å®šä¹‰ï¼Œæ— éœ€é‡å¤å£°æ˜

        // æ›´æ–°é¢„è®¾æ“ä½œåˆ—è¡¨
        function updatePresetOperations() {
            const category = document.getElementById('preset-category').value;
            const operationSelect = document.getElementById('preset-operation');
            const paramsDiv = document.getElementById('preset-params');

            // æ¸…ç©ºå¹¶é‡ç½®
            operationSelect.innerHTML = '<option value="">-- é€‰æ‹©æ“ä½œ --</option>';
            paramsDiv.style.display = 'none';
            paramsDiv.innerHTML = '';
            currentPresetParams = {};

            if (!category || !OperationPresets[category]) {
                operationSelect.disabled = true;
                return;
            }

            operationSelect.disabled = false;
            const operations = OperationPresets[category].operations;

            Object.keys(operations).forEach(key => {
                const op = operations[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${op.name} - ${op.description}`;
                operationSelect.appendChild(option);
            });
        }

        // æ›´æ–°é¢„è®¾å‚æ•°é…ç½®UI
        function updatePresetParams() {
            const category = document.getElementById('preset-category').value;
            const operation = document.getElementById('preset-operation').value;
            const paramsDiv = document.getElementById('preset-params');

            paramsDiv.style.display = 'none';
            paramsDiv.innerHTML = '';
            currentPresetParams = {};

            if (!category || !operation) return;

            const preset = OperationPresets[category].operations[operation];
            if (!preset.params || preset.params.length === 0) return;

            paramsDiv.style.display = 'block';

            preset.params.forEach(param => {
                const paramGroup = document.createElement('div');
                paramGroup.style.marginBottom = '8px';

                const label = document.createElement('label');
                label.textContent = param.label + ':';
                label.style.display = 'block';
                label.style.marginBottom = '4px';
                label.style.fontSize = '0.85em';
                label.style.fontWeight = '500';

                let input;
                if (param.type === 'select') {
                    input = document.createElement('select');
                    input.style.width = '100%';
                    input.style.padding = '6px';
                    input.style.border = '1px solid #cbd5e0';
                    input.style.borderRadius = '4px';
                    input.style.fontSize = '0.85em';

                    param.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.label;
                        if (opt.value === param.default) {
                            option.selected = true;
                        }
                        input.appendChild(option);
                    });
                } else if (param.type === 'number') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.value = param.default || 0;
                    if (param.min !== undefined) input.min = param.min;
                    if (param.max !== undefined) input.max = param.max;
                    input.style.width = '100%';
                    input.style.padding = '6px';
                    input.style.border = '1px solid #cbd5e0';
                    input.style.borderRadius = '4px';
                    input.style.fontSize = '0.85em';
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.value = param.default || '';
                    input.style.width = '100%';
                    input.style.padding = '6px';
                    input.style.border = '1px solid #cbd5e0';
                    input.style.borderRadius = '4px';
                    input.style.fontSize = '0.85em';
                }

                input.dataset.paramName = param.name;
                paramGroup.appendChild(label);
                paramGroup.appendChild(input);
                paramsDiv.appendChild(paramGroup);

                // åˆå§‹åŒ–å‚æ•°å€¼
                currentPresetParams[param.name] = input.value;

                // ç›‘å¬å‚æ•°å˜åŒ–
                input.addEventListener('change', () => {
                    currentPresetParams[param.name] = input.value;
                });
                input.addEventListener('input', () => {
                    currentPresetParams[param.name] = input.value;
                });
            });
        }

        // ç”Ÿæˆé¢„è®¾ä»£ç 
        function generatePresetCode() {
            const category = document.getElementById('preset-category').value;
            const operation = document.getElementById('preset-operation').value;

            if (!category || !operation) {
                showToast('è¯·å…ˆé€‰æ‹©é¢„è®¾åˆ†ç±»å’Œæ“ä½œ', 'error');
                return null;
            }

            const preset = OperationPresets[category].operations[operation];
            if (!preset) {
                showToast('é¢„è®¾ä¸å­˜åœ¨', 'error');
                return null;
            }

            // æ„å»ºå‚æ•°å¯¹è±¡
            const params = {};
            Object.keys(currentPresetParams).forEach(key => {
                const value = currentPresetParams[key];
                // å°è¯•è½¬æ¢æ•°å­—ç±»å‹
                if (!isNaN(value) && value !== '') {
                    params[key] = Number(value);
                } else {
                    params[key] = value;
                }
            });

            return preset.code(params);
        }

        // æ’å…¥é¢„è®¾ä»£ç 
        function insertPresetCode() {
            const code = generatePresetCode();
            if (!code) return;

            const textarea = document.getElementById('hook-onpagetesting');
            const currentCode = textarea.value.trim();

            if (currentCode) {
                // å¦‚æœå·²æœ‰ä»£ç ï¼Œè¿½åŠ åˆ°æœ«å°¾
                textarea.value = currentCode + '\n\n' + code;
            } else {
                textarea.value = code;
            }

            showToast('é¢„è®¾ä»£ç å·²æ’å…¥', 'success');
        }

        // é¢„è§ˆé¢„è®¾ä»£ç 
        function previewPresetCode() {
            const code = generatePresetCode();
            if (!code) return;

            // ä½¿ç”¨alertæ˜¾ç¤ºï¼ˆç®€å•å®ç°ï¼Œå¯ä»¥åç»­æ”¹ä¸ºæ›´ç¾è§‚çš„æ¨¡æ€æ¡†ï¼‰
            alert('ç”Ÿæˆçš„ä»£ç é¢„è§ˆï¼š\n\n' + code);
        }

        // æ¸…ç©ºhookä»£ç 
        function clearHookCode(hookId) {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä»£ç å—ï¼Ÿ')) return;
            document.getElementById(hookId).value = '';
            showToast('ä»£ç å·²æ¸…ç©º', 'success');
        }

        // ==================== é…ç½®é¢„è®¾ç³»ç»Ÿ ====================

        // Toggle Cookie æ¨¡å¼æ˜¾ç¤º
        function toggleCookieMode() {
            const mode = document.getElementById('cookie-mode').value;
            const autoConfig = document.getElementById('auto-cookie-config');
            const manualConfig = document.getElementById('manual-cookie-config');

            autoConfig.style.display = mode === 'auto' ? 'block' : 'none';
            manualConfig.style.display = mode === 'manual' ? 'block' : 'none';
        }

        // åˆ‡æ¢åŒ¿åæ¨¡å¼æ—¶è”åŠ¨Cookieé…ç½®
        function toggleAnonymousMode() {
            const anonymousCheckbox = document.getElementById('case-anonymous');
            const cookieSection = document.getElementById('cookie-config-section');

            // æ·»åŠ ç©ºå€¼æ£€æŸ¥
            if (!anonymousCheckbox || !cookieSection) {
                return;
            }

            const isAnonymous = anonymousCheckbox.checked;

            if (isAnonymous) {
                // åŒ¿åæ¨¡å¼ï¼šç¦ç”¨å¹¶éšè—Cookieé…ç½®
                cookieSection.style.opacity = '0.4';
                cookieSection.style.pointerEvents = 'none';
                cookieSection.title = 'åŒ¿åæ¨¡å¼ä¸‹ä¸å¯é…ç½®Cookie';
            } else {
                // ç™»å½•æ¨¡å¼ï¼šå¯ç”¨Cookieé…ç½®
                cookieSection.style.opacity = '1';
                cookieSection.style.pointerEvents = 'auto';
                cookieSection.title = '';
            }
        }

        // åˆ‡æ¢å¯æŠ˜å åŒºåŸŸ
        function toggleCollapsible(headerElement) {
            const section = headerElement.parentElement;
            const content = section.querySelector('.collapsible-content');
            const icon = section.querySelector('.collapsible-icon');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // åº”ç”¨è‡ªåŠ¨Cookieé¢„è®¾
        function applyAutoCookiePreset() {
            const preset = document.getElementById('auto-cookie-preset').value;
            if (!preset) return;

            const [env, uid] = preset.split(':');
            document.getElementById('auto-cookie-uid').value = uid;
            document.getElementById('auto-cookie-env').value = env;

            showToast(`å·²é€‰æ‹©é¢„è®¾è´¦å·: ${uid} (${env === 'uat' ? 'UAT' : 'ç”Ÿäº§'}ç¯å¢ƒ)`, 'success');
        }

        // åº”ç”¨Cookieé¢„è®¾ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
        function applyCookiePreset() {
            const presetKey = document.getElementById('cookie-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.cookies.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-cookie');
            textarea.value = JSON.stringify(preset.value, null, 2);

            if (preset.instruction) {
                const instructionEl = document.getElementById('cookie-instruction');
                if (instructionEl) {
                    instructionEl.textContent = 'ğŸ’¡ ' + preset.instruction;
                    instructionEl.style.color = '#e67e22';
                }
            }

            showToast(`å·²åº”ç”¨Cookieé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨HTTP Headersé¢„è®¾
        function applyHeadersPreset() {
            const presetKey = document.getElementById('headers-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.headers.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-headers');
            textarea.value = JSON.stringify(preset.value, null, 2);

            if (preset.instruction) {
                document.getElementById('headers-instruction').textContent = 'ğŸ’¡ ' + preset.instruction;
                document.getElementById('headers-instruction').style.color = '#e67e22';
            }

            showToast(`å·²åº”ç”¨Headersé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨BlockListé¢„è®¾
        function applyBlocklistPreset() {
            const presetKey = document.getElementById('blocklist-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.blocklist.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-blocklist');
            textarea.value = JSON.stringify(preset.value, null, 2);

            showToast(`å·²åº”ç”¨BlockListé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨CSSé¢„è®¾
        function applyCssPreset() {
            const presetKey = document.getElementById('css-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.customCss.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById('testcase-css');
            textarea.value = preset.value;

            showToast(`å·²åº”ç”¨CSSé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨Deviceé¢„è®¾
        function applyDevicePreset() {
            const presetKey = document.getElementById('device-preset').value;
            if (!presetKey) return;

            const preset = ConfigPresets.devices.presets[presetKey];
            if (!preset) return;

            const deviceType = preset.type;
            const deviceTypeSelect = document.getElementById('testcase-device-type');
            if (deviceTypeSelect) deviceTypeSelect.value = deviceType;

            // è§¦å‘è®¾å¤‡ç±»å‹å˜åŒ–äº‹ä»¶
            updateDeviceOptionsDisplay();

            // è®¾ç½®å…·ä½“é€‰é¡¹
            if (deviceType === 'Desktop') {
                const fullscreenOption = preset.value[1]?.fullscreen;
                document.getElementById('device-fullscreen').checked = fullscreenOption || false;
            } else if (deviceType === 'Mobile') {
                const mobilePresetName = preset.value[1]?.preset || 'iphone';
                document.getElementById('device-mobile-preset').value = mobilePresetName;
            }

            const instruction = document.getElementById('device-instruction');
            instruction.textContent = `å·²åº”ç”¨: ${preset.displayText}`;
            instruction.style.color = '#27ae60';

            showToast(`å·²åº”ç”¨è®¾å¤‡é¢„è®¾: ${preset.name}`, 'success');
        }

        // æ¸…ç©ºè®¾å¤‡é…ç½®
        function clearDeviceConfig() {
            document.getElementById('device-preset').value = '';
            const deviceTypeElem = document.getElementById('testcase-device-type');
            const fullscreenElem = document.getElementById('device-fullscreen');
            const mobilePresetElem = document.getElementById('device-mobile-preset');

            if (deviceTypeElem) deviceTypeElem.value = '';
            if (fullscreenElem) fullscreenElem.checked = false;
            if (mobilePresetElem) mobilePresetElem.value = 'android';
            updateDeviceOptionsDisplay();

            const instruction = document.getElementById('device-instruction');
            instruction.textContent = 'æ¨¡æ‹Ÿä¸åŒè®¾å¤‡ç±»å‹';
            instruction.style.color = '#718096';

            showToast('è®¾å¤‡é…ç½®å·²æ¸…ç©º', 'success');
        }

        // é€šç”¨æ¸…ç©ºé…ç½®
        function clearConfig(elementId) {
            document.getElementById(elementId).value = '';

            // é‡ç½®instructionæ ·å¼
            const instructionId = elementId.replace('testcase-', '') + '-instruction';
            const instructionEl = document.getElementById(instructionId);
            if (instructionEl) {
                instructionEl.style.color = '#718096';
            }

            // é‡ç½®å¯¹åº”çš„é¢„è®¾é€‰æ‹©å™¨
            const presetSelectId = elementId.replace('testcase-', '') + '-preset';
            const presetSelect = document.getElementById(presetSelectId);
            if (presetSelect) {
                presetSelect.value = '';
            }

            showToast('é…ç½®å·²æ¸…ç©º', 'success');
        }

        // ==================== é’©å­å‡½æ•°é¢„è®¾ç³»ç»Ÿ ====================

        // åº”ç”¨é’©å­å‡½æ•°é¢„è®¾
        function applyHookPreset(hookName, textareaId) {
            const presetSelectId = textareaId + '-preset';
            const presetSelect = document.getElementById(presetSelectId);
            const presetKey = presetSelect.value;

            if (!presetKey) return;

            const hookPresets = HookPresets[hookName];
            if (!hookPresets || !hookPresets.presets[presetKey]) {
                showToast('é¢„è®¾ä¸å­˜åœ¨', 'error');
                return;
            }

            const preset = hookPresets.presets[presetKey];
            const textarea = document.getElementById(textareaId);
            const currentCode = textarea.value.trim();

            if (currentCode) {
                // å¦‚æœå·²æœ‰ä»£ç ï¼Œè¯¢é—®æ˜¯æ›¿æ¢è¿˜æ˜¯è¿½åŠ 
                if (confirm(`å½“å‰å·²æœ‰ä»£ç ï¼Œæ˜¯å¦è¿½åŠ æ–°é¢„è®¾ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"è¿½åŠ ï¼Œç‚¹å‡»"å–æ¶ˆ"æ›¿æ¢`)) {
                    textarea.value = currentCode + '\n\n' + preset.code;
                    showToast(`å·²è¿½åŠ é¢„è®¾: ${preset.name}`, 'success');
                } else {
                    textarea.value = preset.code;
                    showToast(`å·²æ›¿æ¢ä¸ºé¢„è®¾: ${preset.name}`, 'success');
                }
            } else {
                textarea.value = preset.code;
                showToast(`å·²åº”ç”¨é¢„è®¾: ${preset.name}`, 'success');
            }

            // é‡ç½®ä¸‹æ‹‰æ¡†
            presetSelect.value = '';
        }

        // WebSocketè¿æ¥
        let ws = null;
        let reconnectTimer = null;

        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                appendOutput('[ç³»ç»Ÿ] WebSocketè¿æ¥æˆåŠŸ');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                appendOutput('[ç³»ç»Ÿ] WebSocketè¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
                reconnectTimer = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'status':
                    updateStatus(data.data.status, data.data.currentRunner);
                    break;
                case 'output':
                    appendOutput(data.data);
                    break;
                case 'tasks':
                    // æ–°å¢ï¼šå¤„ç†ä»»åŠ¡åˆ—è¡¨æ›´æ–°
                    updateTasksList(data.data);
                    break;
                case 'task_update':
                    // æ–°å¢ï¼šå¤„ç†å•ä¸ªä»»åŠ¡æ›´æ–°
                    updateSingleTask(data.data);
                    break;
            }
        }

        // æ–°å¢ï¼šæ›´æ–°ä»»åŠ¡åˆ—è¡¨
        function updateTasksList(tasks) {
            backendTasks.clear();
            tasks.forEach(task => {
                backendTasks.set(task.id, task);
            });
            updateStats();
            updateQueueDisplay();
        }

        // æ–°å¢ï¼šæ›´æ–°å•ä¸ªä»»åŠ¡
        function updateSingleTask(task) {
            const existingTask = backendTasks.get(task.id);
            const statusChanged = !existingTask || existingTask.status !== task.status;

            backendTasks.set(task.id, task);

            // å¦‚æœæœ‰è¾“å‡ºï¼Œè¿½åŠ åˆ°è¾“å‡ºåŒºåŸŸ
            if (task.output) {
                const outputArea = document.getElementById('output-area');
                if (outputArea) {
                    outputArea.value = task.output;
                    outputArea.scrollTop = outputArea.scrollHeight;
                }
            }

            // æ›´æ–°å†…è”æ—¥å¿—æ˜¾ç¤ºï¼ˆå®æ—¶æ›´æ–°ï¼‰
            let logText = '';
            if (Array.isArray(task.logs)) {
                // logsæ•°ç»„æ ¼å¼ï¼ˆåˆ†å¸ƒå¼ä»»åŠ¡ï¼‰
                logText = task.logs.join('\n');
            } else if (typeof task.output === 'string') {
                // outputå­—ç¬¦ä¸²æ ¼å¼ï¼ˆæœ¬åœ°ä»»åŠ¡ï¼‰
                logText = task.output;
            }
            if (logText) {
                updateTaskLog(task.id, logText);
            }

            // å¦‚æœä»»åŠ¡å·²å®Œæˆæˆ–å¤±è´¥ï¼Œ5ç§’åè‡ªåŠ¨ç§»é™¤
            if (task.status === 'completed' || task.status === 'error') {
                setTimeout(() => {
                    if (backendTasks.has(task.id)) {
                        backendTasks.delete(task.id);
                        updateStats();
                        updateQueueDisplay();
                    }
                }, 5000);
            }

            updateStats();

            // åªæœ‰åœ¨çŠ¶æ€æ”¹å˜æ—¶æ‰é‡æ–°æ¸²æŸ“æ•´ä¸ªé˜Ÿåˆ—ï¼Œé¿å…æ—¥å¿—æ›´æ–°æ—¶åˆ·æ–°å¯¼è‡´æ»šåŠ¨ä½ç½®ä¸¢å¤±
            if (statusChanged) {
                updateQueueDisplay();
            }
        }

        // åˆå§‹åŒ– Worker èŠ‚ç‚¹é€‰æ‹©å™¨
        async function initWorkerSelector() {
            try {
                workerSelector = new WorkerSelector();
                await workerSelector.init();

                // æ¸²æŸ“åˆ°å®¹å™¨
                workerSelector.render('workerSelectorContainer');

                // ç›‘å¬å˜åŒ–
                workerSelector.onChange((workers, selectedWorkerId) => {
                    console.log('[Workeré€‰æ‹©å™¨] Workersæ›´æ–°:', workers.length);
                    console.log('[Workeré€‰æ‹©å™¨] é€‰ä¸­èŠ‚ç‚¹:', selectedWorkerId);

                    // é‡æ–°æ¸²æŸ“é€‰æ‹©å™¨
                    workerSelector.render('workerSelectorContainer');
                });

                console.log('[Workeré€‰æ‹©å™¨] âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('[Workeré€‰æ‹©å™¨] åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–
        window.onload = async () => {
            connectWebSocket();

            // åˆå§‹åŒ– Worker èŠ‚ç‚¹é€‰æ‹©å™¨ï¼ˆç­‰å¾…åˆå§‹åŒ–å®Œæˆï¼‰
            await initWorkerSelector();

            // ğŸ†• ä»åç«¯åŠ è½½æµ‹è¯•ç”¨ä¾‹
            console.log('[åˆå§‹åŒ–] æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½æµ‹è¯•ç”¨ä¾‹...');
            const backendCases = await loadTestCasesFromBackend();
            if (backendCases && backendCases.length > 0) {
                testCases = backendCases;
                saveToStorage(); // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºç¼“å­˜
                console.log(`[åˆå§‹åŒ–] âœ… å·²ä»æœåŠ¡å™¨åŠ è½½ ${backendCases.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`);
            } else {
                // å¦‚æœåç«¯æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æœ¬åœ°è¿ç§»
                console.log('[åˆå§‹åŒ–] æœåŠ¡å™¨æ— æ•°æ®ï¼Œæ£€æŸ¥æœ¬åœ°æ•°æ®...');
                await migrateLocalToBackend();

                // è¿ç§»åé‡æ–°åŠ è½½
                const migratedCases = await loadTestCasesFromBackend();
                if (migratedCases && migratedCases.length > 0) {
                    testCases = migratedCases;
                    saveToStorage();
                }
            }

            renderCases();
            updateStats();
            loadCompletedToday();

            // æ·»åŠ é«˜çº§é…ç½®äº‹ä»¶ç›‘å¬
            const runnerInit = document.getElementById('runner-initialization');
            const runnerRuntime = document.getElementById('runner-runtime');
            const runnerMemoryLeak = document.getElementById('runner-memoryleak');
            const deviceTypeSelect = document.getElementById('testcase-device-type');

            if (runnerInit) runnerInit.addEventListener('change', updateAdvancedConfigDisplay);
            if (runnerRuntime) runnerRuntime.addEventListener('change', updateAdvancedConfigDisplay);
            if (runnerMemoryLeak) runnerMemoryLeak.addEventListener('change', updateAdvancedConfigDisplay);
            if (deviceTypeSelect) deviceTypeSelect.addEventListener('change', updateDeviceOptionsDisplay);

            // è°ƒè¯•ä¿¡æ¯
            console.log('âœ“ window.onload å®Œæˆ');
            console.log('âœ“ å·²åŠ è½½æµ‹è¯•ç”¨ä¾‹æ•°é‡:', testCases.length);
            console.log('âœ“ showAddCaseModal å‡½æ•°ç±»å‹:', typeof showAddCaseModal);
            console.log('âœ“ runCase å‡½æ•°ç±»å‹:', typeof runCase);
            console.log('âœ“ editCase å‡½æ•°ç±»å‹:', typeof editCase);
        };

        // å½“å‰æ˜¾ç¤ºçš„æµ‹è¯•ç”¨ä¾‹ï¼ˆç”¨äºå…¨é€‰åŠŸèƒ½ï¼‰
        let currentDisplayedCases = [];

        // æ¸²æŸ“ç”¨ä¾‹åˆ—è¡¨
        function renderCases(filteredCases = null) {
            const container = document.getElementById('cases-container');
            const casesToRender = filteredCases !== null ? filteredCases : testCases;

            // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„æµ‹è¯•ç”¨ä¾‹
            currentDisplayedCases = casesToRender;

            if (testCases.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— æµ‹è¯•ç”¨ä¾‹</h3>
                        <p>ç‚¹å‡»"æ·»åŠ ç”¨ä¾‹"åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹</p>
                    </div>
                `;
                return;
            }

            if (casesToRender.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æœªæ‰¾åˆ°åŒ¹é…çš„æµ‹è¯•ç”¨ä¾‹</h3>
                        <p>è¯·å°è¯•ä¿®æ”¹æœç´¢æ¡ä»¶æˆ–æ¸…é™¤ç­›é€‰</p>
                    </div>
                `;
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å½“å‰æ˜¾ç¤ºçš„ç”¨ä¾‹éƒ½å·²è¢«é€‰ä¸­
            const allSelected = casesToRender.length > 0 && casesToRender.every(tc => selectedCases.has(tc.id));

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" ${allSelected ? 'checked' : ''}></th>
                            <th>ç”¨ä¾‹åç§°</th>
                            <th>æµ‹è¯•ç±»å‹</th>
                            <th>URLæ•°é‡</th>
                            <th>æ¨¡å¼</th>
                            <th>é‡å¤æ¬¡æ•°</th>
                            <th>æ‰§è¡ŒèŠ‚ç‚¹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${casesToRender.map(testCase => {
                            const urls = testCase.urls || (testCase.url ? [testCase.url] : []);
                            const mode = testCase.mode || 'headless';
                            const urlsTitle = urls.join('\\n');

                            // å¤„ç†runner - å…¼å®¹æ–°æ—§æ ¼å¼
                            let runners = [];
                            if (testCase.runners) {
                                // æ–°æ ¼å¼ï¼šrunnerså¯¹è±¡
                                if (testCase.runners.Initialization?.enabled) runners.push('Init');
                                if (testCase.runners.Runtime?.enabled) runners.push('Runtime');
                                if (testCase.runners.MemoryLeak?.enabled) runners.push('Memory');
                            } else if (testCase.runner) {
                                // æ—§æ ¼å¼ï¼šå•ä¸ªrunnerå­—ç¬¦ä¸²
                                runners.push(testCase.runner === 'Initialization' ? 'Init' :
                                           testCase.runner === 'MemoryLeak' ? 'Memory' : testCase.runner);
                            }

                            const runnerTags = runners.map(r =>
                                '<span class="badge runner-' + r.toLowerCase() + '" style="margin-right: 4px;">' + r + '</span>'
                            ).join('');

                            // è·å–èŠ‚ç‚¹ä¿¡æ¯
                            let workerDisplay = '<span style="color: #999; font-size: 0.85em;">è‡ªåŠ¨åˆ†é…</span>';
                            if (testCase.workerId && workerSelector) {
                                const worker = workerSelector.getWorkers().find(w => w.id === testCase.workerId);
                                if (worker) {
                                    const tierName = worker.performanceTier ?
                                        { high: 'é«˜é…', medium: 'ä¸­é…', low: 'ä½é…', custom: 'è‡ªå®šä¹‰' }[worker.performanceTier] : '';
                                    const workerName = tierName ? tierName + '-' + worker.name : worker.name;
                                    const statusIcon = worker.status === 'online' ? 'ğŸŸ¢' : 'ğŸ”´';
                                    workerDisplay = '<span style="font-size: 0.85em;" title="' + escapeHtml(worker.name) + '">' + statusIcon + ' ' + escapeHtml(workerName) + '</span>';
                                }
                            }

                            return `
                            <tr>
                                <td><input type="checkbox" onchange="toggleCaseSelection('${testCase.id}', this.checked)" ${selectedCases.has(testCase.id) ? 'checked' : ''}></td>
                                <td><strong>${escapeHtml(testCase.name)}</strong></td>
                                <td>${runnerTags || '<span style="color: #999;">æœªé…ç½®</span>'}</td>
                                <td><span title="${escapeHtml(urlsTitle)}" style="cursor: help;">${urls.length} ä¸ªURL</span></td>
                                <td><span style="font-size: 0.85em; color: #4a5568;">${mode === 'headless' ? 'ğŸš€ æ— å¤´' : 'ğŸ‘ï¸ æœ‰å¤´'}</span></td>
                                <td>${testCase.repeatCount || 1}</td>
                                <td>${workerDisplay}</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn-success btn-sm" onclick="runCase('${testCase.id}')">â–¶ è¿è¡Œ</button>
                                        <button class="btn-secondary btn-sm" onclick="editCase('${testCase.id}')">âœï¸ ç¼–è¾‘</button>
                                        <button class="btn-secondary btn-sm" onclick="duplicateTestCase('${testCase.id}')" title="å¤åˆ¶è¯¥ç”¨ä¾‹åˆ›å»ºå‰¯æœ¬" style="background: #3182ce; color: white;">ğŸ“‹ å¤åˆ¶</button>
                                        <button class="btn-danger btn-sm" onclick="deleteCase('${testCase.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('total-cases').textContent = testCases.length;

            // ç»Ÿè®¡åç«¯è¿è¡Œä¸­çš„ä»»åŠ¡æ•°
            const runningCount = Array.from(backendTasks.values()).filter(t => t.status === 'running').length;
            document.getElementById('running-cases').textContent = runningCount;

            document.getElementById('completed-today').textContent = completedToday;
        }

        // é€‰æ‹©/å–æ¶ˆé€‰æ‹©ç”¨ä¾‹
        function toggleCaseSelection(id, checked) {
            if (checked) {
                selectedCases.add(id);
            } else {
                selectedCases.delete(id);
            }
            updateSelectionUI();
        }

        function toggleSelectAll(checked) {
            if (checked) {
                // åªé€‰æ‹©å½“å‰æ˜¾ç¤ºçš„æµ‹è¯•ç”¨ä¾‹
                currentDisplayedCases.forEach(tc => selectedCases.add(tc.id));
            } else {
                // å–æ¶ˆé€‰æ‹©å½“å‰æ˜¾ç¤ºçš„æµ‹è¯•ç”¨ä¾‹
                currentDisplayedCases.forEach(tc => selectedCases.delete(tc.id));
            }
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
            renderCases(currentDisplayedCases.length === testCases.length ? null : currentDisplayedCases);
            updateSelectionUI();
        }

        function updateSelectionUI() {
            document.getElementById('selected-count').textContent = selectedCases.size;
            document.getElementById('run-selected-btn').disabled = selectedCases.size === 0;
            document.getElementById('duplicate-selected-btn').disabled = selectedCases.size === 0;
            document.getElementById('delete-selected-btn').disabled = selectedCases.size === 0;
        }

        // ==================== æœç´¢å’Œç­›é€‰åŠŸèƒ½ ====================

        // ç­›é€‰æµ‹è¯•ç”¨ä¾‹
        function filterTestCases() {
            const searchInput = document.getElementById('search-input');
            const tagFilterInput = document.getElementById('tag-filter-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const clearTagBtn = document.getElementById('clear-tag-btn');

            const searchQuery = searchInput.value.trim().toLowerCase();
            const tagQuery = tagFilterInput.value.trim();

            // æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
            clearSearchBtn.style.display = searchQuery ? 'block' : 'none';
            clearTagBtn.style.display = tagQuery ? 'block' : 'none';

            let filtered = testCases;

            // æ ¹æ®æœç´¢å…³é”®è¯ç­›é€‰ï¼ˆæœç´¢åç§°å’Œæè¿°ï¼‰
            if (searchQuery) {
                filtered = filtered.filter(testCase => {
                    const name = (testCase.name || '').toLowerCase();
                    const description = (testCase.description || '').toLowerCase();
                    return name.includes(searchQuery) || description.includes(searchQuery);
                });
            }

            // æ ¹æ®æ ‡ç­¾ç­›é€‰
            if (tagQuery) {
                const searchTags = tagQuery.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
                if (searchTags.length > 0) {
                    filtered = filtered.filter(testCase => {
                        const caseTags = (testCase.tags || []).map(t => t.toLowerCase());
                        // åªè¦æµ‹è¯•ç”¨ä¾‹åŒ…å«ä»»ä½•ä¸€ä¸ªæœç´¢æ ‡ç­¾å³åŒ¹é…
                        return searchTags.some(searchTag =>
                            caseTags.some(caseTag => caseTag.includes(searchTag))
                        );
                    });
                }
            }

            renderCases(filtered);
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('search-input').value = '';
            filterTestCases();
        }

        // æ¸…é™¤æ ‡ç­¾ç­›é€‰
        function clearTagFilter() {
            document.getElementById('tag-filter-input').value = '';
            filterTestCases();
        }

        // é‡ç½®æ‰€æœ‰ç­›é€‰
        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('tag-filter-input').value = '';
            document.getElementById('clear-search-btn').style.display = 'none';
            document.getElementById('clear-tag-btn').style.display = 'none';
            renderCases();
        }

        // ==================== æ‰¹é‡æ“ä½œç”¨ä¾‹ ====================

        // æ‰¹é‡å¤åˆ¶ç”¨ä¾‹
        function duplicateSelectedCases() {
            if (selectedCases.size === 0) return;

            const count = selectedCases.size;
            let duplicatedCount = 0;

            // å¤åˆ¶æ‰€æœ‰é€‰ä¸­çš„ç”¨ä¾‹
            selectedCases.forEach(caseId => {
                const testCase = testCases.find(tc => tc.id === caseId || tc.id == caseId);
                if (testCase) {
                    // æ·±æ‹·è´æµ‹è¯•ç”¨ä¾‹
                    const newCase = JSON.parse(JSON.stringify(testCase));

                    // ç”Ÿæˆæ–°ID
                    newCase.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    // ä¿®æ”¹åç§°
                    newCase.name = testCase.name + ' (å‰¯æœ¬)';

                    // æ·»åŠ åˆ°åˆ—è¡¨
                    testCases.push(newCase);
                    duplicatedCount++;
                }
            });

            // æ¸…ç©ºé€‰æ‹©
            selectedCases.clear();

            saveToStorage();
            renderCases();
            updateSelectionUI();
            showToast(`æˆåŠŸå¤åˆ¶ ${duplicatedCount} ä¸ªç”¨ä¾‹`, 'success');
        }

        // æ‰¹é‡åˆ é™¤ç”¨ä¾‹
        function deleteSelectedCases() {
            if (selectedCases.size === 0) return;

            const count = selectedCases.size;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªç”¨ä¾‹å—ï¼Ÿ`)) return;

            // åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„ç”¨ä¾‹
            testCases = testCases.filter(tc => !selectedCases.has(tc.id));
            selectedCases.clear();

            saveToStorage();
            renderCases();
            updateSelectionUI();
            showToast(`æˆåŠŸåˆ é™¤ ${count} ä¸ªç”¨ä¾‹`, 'success');
        }

        // æ›´æ–°é«˜çº§é…ç½®æ˜¾ç¤º
        function updateAdvancedConfigDisplay() {
            const initializationCheckbox = document.getElementById('runner-initialization');
            const runtimeCheckbox = document.getElementById('runner-runtime');
            const memoryLeakCheckbox = document.getElementById('runner-memoryleak');

            // æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨æŸäº›é¡µé¢ï¼ˆå¦‚records.htmlï¼‰è°ƒç”¨æ­¤å‡½æ•°æ—¶æŠ¥é”™
            if (!initializationCheckbox || !runtimeCheckbox || !memoryLeakCheckbox) {
                return;
            }

            const initializationChecked = initializationCheckbox.checked;
            const runtimeChecked = runtimeCheckbox.checked;
            const memoryLeakChecked = memoryLeakCheckbox.checked;

            const initializationConfig = document.getElementById('initialization-config');
            const runtimeConfig = document.getElementById('runtime-config');
            const memoryLeakConfig = document.getElementById('memoryleak-config');
            const noConfig = document.getElementById('no-runner-config');
            const runnerCard = document.getElementById('runner-config-card');

            if (initializationConfig) initializationConfig.style.display = initializationChecked ? 'block' : 'none';
            if (runtimeConfig) runtimeConfig.style.display = runtimeChecked ? 'block' : 'none';
            if (memoryLeakConfig) memoryLeakConfig.style.display = memoryLeakChecked ? 'block' : 'none';
            if (noConfig) noConfig.style.display = (!initializationChecked && !runtimeChecked && !memoryLeakChecked) ? 'block' : 'none';

            // æ˜¾ç¤º/éšè—Runneré…ç½®å¡ç‰‡
            if (runnerCard) runnerCard.style.display = (initializationChecked || runtimeChecked || memoryLeakChecked) ? 'block' : 'none';

            // æ ¹æ®é€‰æ‹©çš„runneræ˜¾ç¤º/éšè—ç”Ÿå‘½å‘¨æœŸé’©å­
            const onPageTestingContainer = document.getElementById('hook-onpagetesting-container');
            const onPageCollectingContainer = document.getElementById('hook-onpagecollecting-container');

            // onPageTesting åªåœ¨ Runtime æˆ– MemoryLeak æ—¶æ˜¾ç¤º
            if (onPageTestingContainer) {
                onPageTestingContainer.style.display = (runtimeChecked || memoryLeakChecked) ? 'block' : 'none';
            }

            // onPageCollecting åªåœ¨ MemoryLeak æ—¶æ˜¾ç¤º
            if (onPageCollectingContainer) {
                onPageCollectingContainer.style.display = memoryLeakChecked ? 'block' : 'none';
            }
        }

        // æ›´æ–°è®¾å¤‡é€‰é¡¹æ˜¾ç¤º
        function updateDeviceOptionsDisplay() {
            const deviceTypeElem = document.getElementById('testcase-device-type');
            if (!deviceTypeElem) return;
            const deviceType = deviceTypeElem.value;
            const desktopOptions = document.getElementById('device-desktop-options');
            const mobileOptions = document.getElementById('device-mobile-options');

            desktopOptions.style.display = deviceType === 'Desktop' ? 'block' : 'none';
            mobileOptions.style.display = deviceType === 'Mobile' ? 'block' : 'none';
        }

        // åº”ç”¨ MemoryLeak onPageTesting é¢„è®¾
        function applyMemoryLeakTestingPreset() {
            const presetKey = document.getElementById('memoryleak-onpagetesting-preset').value;
            if (!presetKey) return;

            const presets = {
                'click_play': {
                    name: 'ç‚¹å‡»æ’­æ”¾æŒ‰é’®',
                    code: `// ç‚¹å‡»æ’­æ”¾æŒ‰é’®
await page.click('.bpx-player-ctrl-btn, .bilibili-player-video-btn-start, .video-play-btn, [aria-label="play"]');
console.log('å·²ç‚¹å‡»æ’­æ”¾æŒ‰é’®');`
                },
                'video_switch': {
                    name: 'åˆ‡æ¢è§†é¢‘',
                    code: `// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘
await page.evaluate(() => {
    const nextBtn = document.querySelector('.next-button, .recommend-list .video-item');
    if (nextBtn) nextBtn.click();
});
await page.waitForTimeout(2000);
console.log('å·²åˆ‡æ¢è§†é¢‘');`
                },
                'scroll_page': {
                    name: 'é¡µé¢æ»šåŠ¨',
                    code: `// æ»šåŠ¨é¡µé¢åˆ°åº•éƒ¨å†å›åˆ°é¡¶éƒ¨
await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));
await page.waitForTimeout(1000);
await page.evaluate(() => window.scrollTo(0, 0));
console.log('é¡µé¢æ»šåŠ¨å®Œæˆ');`
                },
                'tab_switch': {
                    name: 'æ ‡ç­¾é¡µåˆ‡æ¢',
                    code: `// åˆ‡æ¢æ ‡ç­¾é¡µ
await page.evaluate(() => {
    const tabs = document.querySelectorAll('.tab-item, .nav-tab');
    if (tabs.length > 1) {
        tabs[1].click();
        setTimeout(() => tabs[0].click(), 1000);
    }
});
console.log('æ ‡ç­¾é¡µåˆ‡æ¢å®Œæˆ');`
                },
                'popup_open_close': {
                    name: 'å¼¹çª—å¼€å…³',
                    code: `// æ‰“å¼€å¹¶å…³é—­å¼¹çª—
await page.evaluate(() => {
    const openBtn = document.querySelector('[data-modal], .open-modal, .popup-trigger');
    if (openBtn) {
        openBtn.click();
        setTimeout(() => {
            const closeBtn = document.querySelector('.close, .modal-close, [data-dismiss]');
            if (closeBtn) closeBtn.click();
        }, 1000);
    }
});
console.log('å¼¹çª—æ“ä½œå®Œæˆ');`
                },
                'list_scroll': {
                    name: 'åˆ—è¡¨æ— é™æ»šåŠ¨',
                    code: `// è§¦å‘æ— é™æ»šåŠ¨åŠ è½½
for (let i = 0; i < 3; i++) {
    await page.evaluate(() => {
        const container = document.querySelector('.infinite-list, .scroll-container');
        if (container) container.scrollTop = container.scrollHeight;
    });
    await page.waitForTimeout(1500);
}
console.log('æ— é™æ»šåŠ¨å®Œæˆ');`
                },
                'image_load': {
                    name: 'åŠ¨æ€åŠ è½½å›¾ç‰‡',
                    code: `// æ»šåŠ¨åŠ è½½æ‡’åŠ è½½å›¾ç‰‡
await page.evaluate(() => {
    const images = document.querySelectorAll('img[data-src], img[loading="lazy"]');
    images.forEach(img => {
        img.scrollIntoView();
    });
});
await page.waitForTimeout(2000);
console.log('å›¾ç‰‡åŠ è½½å®Œæˆ');`
                },
                'bilibili_danmaku': {
                    name: 'Bç«™å¼¹å¹•å¼€å…³',
                    code: `// Bç«™å¼¹å¹•å¼€å…³æ“ä½œ
await page.click('.bpx-player-dm-switch, .bilibili-player-video-danmaku-switch');
await page.waitForTimeout(1000);
await page.click('.bpx-player-dm-switch, .bilibili-player-video-danmaku-switch');
console.log('Bç«™å¼¹å¹•å¼€å…³å®Œæˆ');`
                }
            };

            const preset = presets[presetKey];
            if (!preset) return;

            document.getElementById('memoryleak-onpagetesting').value = preset.code;
            document.getElementById('memoryleak-onpagetesting-preset').value = '';

            showToast(`å·²åº”ç”¨é¢„è®¾: ${preset.name}`, 'success');
        }

        // ==================== é€šç”¨å¤åˆ¶åŠŸèƒ½ ====================
        function copyToClipboard(text, successMessage = 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿') {
            navigator.clipboard.writeText(text).then(() => {
                showToast(successMessage, 'success');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶ï¼ˆå…‹éš†ï¼‰URLé¡¹
        function duplicateUrlItem(itemId) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item) {
                showToast('æœªæ‰¾åˆ°URLé¡¹', 'error');
                return;
            }
            // åˆ›å»ºå‰¯æœ¬
            const newUrl = item.url;
            const newDescription = item.description ? `${item.description} (å‰¯æœ¬)` : '';
            const newConfig = JSON.parse(JSON.stringify(item.config || {})); // æ·±æ‹·è´é…ç½®

            addUrlItem(newUrl, newDescription, newConfig);
            showToast('å·²å¤åˆ¶URLé¡¹', 'success');
        }

        // å¤åˆ¶ï¼ˆå…‹éš†ï¼‰æµ‹è¯•ç”¨ä¾‹
        function duplicateTestCase(testCaseId) {
            const testCase = testCases.find(tc => tc.id === testCaseId || tc.id == testCaseId);
            if (!testCase) {
                showToast('æœªæ‰¾åˆ°æµ‹è¯•ç”¨ä¾‹', 'error');
                return;
            }

            // æ·±æ‹·è´æµ‹è¯•ç”¨ä¾‹
            const newCase = JSON.parse(JSON.stringify(testCase));

            // ç”Ÿæˆæ–°ID
            newCase.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // ä¿®æ”¹åç§°
            newCase.name = testCase.name + ' (å‰¯æœ¬)';

            // æ·»åŠ åˆ°åˆ—è¡¨
            testCases.push(newCase);
            saveToStorage();
            renderCases();

            showToast(`å·²å¤åˆ¶ç”¨ä¾‹: ${testCase.name}`, 'success');
        }

        // ==================== URL åˆ—è¡¨ç®¡ç† ====================
        let urlItems = [];
        let urlItemCounter = 0;

        // æ·»åŠ URLé¡¹
        function addUrlItem(url = '', description = '', config = null) {
            const itemId = urlItemCounter++;
            urlItems.push({
                id: itemId,
                url,
                description,
                config: config || {},
                configExpanded: false
            });
            renderUrlList();
        }

        // åˆ é™¤URLé¡¹
        function removeUrlItem(itemId) {
            urlItems = urlItems.filter(item => item.id != itemId);
            renderUrlList();
        }

        // åˆ‡æ¢URLé…ç½®é¢æ¿
        function toggleUrlConfig(itemId) {
            const item = urlItems.find(i => i.id == itemId);
            if (item) {
                item.configExpanded = !item.configExpanded;
                renderUrlList();
            }
        }

        // æ›´æ–°URLçš„é…ç½®é¡¹
        function updateUrlConfig(itemId, field, value) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!item.config) {
                item.config = {};
            }

            if (value === '' || value === null || value === undefined) {
                delete item.config[field];
            } else {
                item.config[field] = value;
            }
        }

        // æ£€æŸ¥URLæ˜¯å¦æœ‰è‡ªå®šä¹‰é…ç½®
        function hasUrlConfig(item) {
            return item.config && Object.keys(item.config).length > 0;
        }

        // æ›´æ–°URLçš„è®¾å¤‡ç±»å‹
        function updateUrlDeviceType(itemId, deviceType) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!item.config) {
                item.config = {};
            }

            // æ˜¾ç¤º/éšè—ç›¸åº”çš„é€‰é¡¹åŒºåŸŸ
            const desktopOptions = document.getElementById(`url-${itemId}-device-desktop-options`);
            const mobileOptions = document.getElementById(`url-${itemId}-device-mobile-options`);

            if (!deviceType) {
                delete item.config.deviceOptions;
                if (desktopOptions) desktopOptions.style.display = 'none';
                if (mobileOptions) mobileOptions.style.display = 'none';
            } else if (deviceType === 'Desktop') {
                item.config.deviceOptions = ['Desktop', { fullscreen: false }];
                if (desktopOptions) desktopOptions.style.display = 'block';
                if (mobileOptions) mobileOptions.style.display = 'none';
            } else if (deviceType === 'Mobile') {
                item.config.deviceOptions = ['Mobile', { preset: 'android' }];
                if (desktopOptions) desktopOptions.style.display = 'none';
                if (mobileOptions) mobileOptions.style.display = 'block';
            }
        }

        // æ›´æ–°URLçš„è®¾å¤‡é€‰é¡¹
        function updateUrlDeviceOptions(itemId, deviceType, options) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item || !item.config) return;

            if (deviceType && options) {
                item.config.deviceOptions = [deviceType, options];
            }
        }

        // æ›´æ–°URLçš„é’©å­å‡½æ•°
        function updateUrlHook(itemId, hookName, value) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!item.config) {
                item.config = {};
            }

            if (!item.config.hooks) {
                item.config.hooks = {};
            }

            if (value === '' || value === null || value === undefined) {
                delete item.config.hooks[hookName];
                // å¦‚æœhookså¯¹è±¡ä¸ºç©ºï¼Œåˆ é™¤å®ƒ
                if (Object.keys(item.config.hooks).length === 0) {
                    delete item.config.hooks;
                }
            } else {
                item.config.hooks[hookName] = value;
            }
        }

        // ========== Per-URL é¢„è®¾åº”ç”¨å‡½æ•° ==========

        // åº”ç”¨URL Cookieé¢„è®¾
        function applyUrlCookiePreset(itemId) {
            const presetKey = document.getElementById(`url-${itemId}-cookie-preset`).value;
            if (!presetKey) return;

            const preset = ConfigPresets.cookies.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById(`url-config-cookie-${itemId}`);
            textarea.value = JSON.stringify(preset.value, null, 2);
            updateUrlConfig(itemId, 'cookie', JSON.stringify(preset.value, null, 2));

            showToast(`å·²åº”ç”¨Cookieé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨URL Headersé¢„è®¾
        function applyUrlHeadersPreset(itemId) {
            const presetKey = document.getElementById(`url-${itemId}-headers-preset`).value;
            if (!presetKey) return;

            const preset = ConfigPresets.headers.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById(`url-config-headers-${itemId}`);
            textarea.value = JSON.stringify(preset.value, null, 2);
            textarea.style.borderColor = '#cbd5e0';
            updateUrlConfig(itemId, 'extraHTTPHeaders', preset.value);

            showToast(`å·²åº”ç”¨Headersé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨URL BlockListé¢„è®¾
        function applyUrlBlocklistPreset(itemId) {
            const presetKey = document.getElementById(`url-${itemId}-blocklist-preset`).value;
            if (!presetKey) return;

            const preset = ConfigPresets.blocklist.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById(`url-config-blocklist-${itemId}`);
            textarea.value = JSON.stringify(preset.value, null, 2);
            textarea.style.borderColor = '#cbd5e0';
            updateUrlConfig(itemId, 'blockList', preset.value);

            showToast(`å·²åº”ç”¨BlockListé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨URL CSSé¢„è®¾
        function applyUrlCssPreset(itemId) {
            const presetKey = document.getElementById(`url-${itemId}-css-preset`).value;
            if (!presetKey) return;

            const preset = ConfigPresets.css.presets[presetKey];
            if (!preset) return;

            const textarea = document.getElementById(`url-config-css-${itemId}`);
            textarea.value = preset.value;
            updateUrlConfig(itemId, 'customCss', preset.value);

            showToast(`å·²åº”ç”¨CSSé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨URL Deviceé¢„è®¾
        function applyUrlDevicePreset(itemId) {
            const presetKey = document.getElementById(`url-${itemId}-device-preset`).value;
            if (!presetKey) return;

            const preset = ConfigPresets.device.presets[presetKey];
            if (!preset) return;

            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!item.config) item.config = {};
            item.config.deviceOptions = preset.value;

            // æ›´æ–°ä¸‹æ‹‰æ¡†å’Œé€‰é¡¹
            const deviceTypeSelect = document.getElementById(`url-config-device-type-${itemId}`);
            if (deviceTypeSelect) {
                deviceTypeSelect.value = preset.value[0];
            }

            renderUrlList();
            showToast(`å·²åº”ç”¨Deviceé¢„è®¾: ${preset.name}`, 'success');
        }

        // åº”ç”¨URL Hooké¢„è®¾
        function applyUrlHookPreset(itemId, hookName) {
            const presetSelect = document.getElementById(`url-${itemId}-hook-${hookName.toLowerCase()}-preset`);
            const presetKey = presetSelect.value;
            if (!presetKey) return;

            // ä½¿ç”¨ HookPresets è€Œä¸æ˜¯ ConfigPresets
            const preset = HookPresets[hookName]?.presets?.[presetKey];
            if (!preset) {
                console.error(`é¢„è®¾æœªæ‰¾åˆ°: HookPresets.${hookName}.presets.${presetKey}`);
                showToast(`é¢„è®¾æœªæ‰¾åˆ°: ${hookName}.${presetKey}`, 'error');
                return;
            }

            const textarea = document.getElementById(`url-config-hook-${hookName}-${itemId}`);
            // ä½¿ç”¨ code å­—æ®µè€Œä¸æ˜¯ value
            const code = preset.code || preset.value || '';
            textarea.value = code;
            updateUrlHook(itemId, hookName, code);

            // é‡ç½®ä¸‹æ‹‰æ¡†
            presetSelect.value = '';

            showToast(`å·²åº”ç”¨${hookName}é¢„è®¾: ${preset.name}`, 'success');
        }

        // æ¸…ç©ºURLé…ç½®é¡¹
        function clearUrlConfig(itemId, field) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item || !item.config) return;

            delete item.config[field];

            // æ¸…ç©ºå¯¹åº”çš„textarea
            const textarea = document.getElementById(`url-config-${field === 'extraHTTPHeaders' ? 'headers' : field === 'blockList' ? 'blocklist' : field === 'customCss' ? 'css' : field}-${itemId}`);
            if (textarea) {
                textarea.value = '';
                textarea.style.borderColor = '#cbd5e0';
            }

            renderUrlList();
            showToast(`å·²æ¸…ç©º${field}é…ç½®`, 'info');
        }

        // æ¸…ç©ºURL Deviceé…ç½®
        function clearUrlDeviceConfig(itemId) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item || !item.config) return;

            delete item.config.deviceOptions;

            // æ¸…ç©ºè®¾å¤‡ç±»å‹é€‰æ‹©
            const deviceTypeSelect = document.getElementById(`url-config-device-type-${itemId}`);
            if (deviceTypeSelect) {
                deviceTypeSelect.value = '';
            }

            renderUrlList();
            showToast('å·²æ¸…ç©ºè®¾å¤‡é…ç½®', 'info');
        }

        // æ¸…ç©ºURL Hook
        function clearUrlHook(itemId, hookName) {
            updateUrlHook(itemId, hookName, '');

            const textarea = document.getElementById(`url-config-hook-${hookName}-${itemId}`);
            if (textarea) {
                textarea.value = '';
            }

            showToast(`å·²æ¸…ç©º${hookName}`, 'info');
        }

        // æ›´æ–°URLç½‘ç»œæ¡ä»¶
        function updateUrlNetworkCondition(itemId, field, value) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!item.config) {
                item.config = {};
            }

            if (!item.config.networkConditions) {
                item.config.networkConditions = {};
            }

            if (value === '' || value === null || value === undefined || value === false) {
                delete item.config.networkConditions[field];
                // å¦‚æœnetworkConditionså¯¹è±¡ä¸ºç©ºï¼Œåˆ é™¤å®ƒ
                if (Object.keys(item.config.networkConditions).length === 0) {
                    delete item.config.networkConditions;
                }
            } else {
                item.config.networkConditions[field] = value;
            }
        }

        // åº”ç”¨URLç½‘ç»œé¢„è®¾
        function applyUrlNetworkPreset(itemId) {
            const presetKey = document.getElementById(`url-${itemId}-network-preset`).value;
            if (!presetKey) return;

            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!item.config) {
                item.config = {};
            }

            // ç½‘ç»œé¢„è®¾é…ç½®
            const networkPresets = {
                offline: {
                    name: 'ç¦»çº¿æ¨¡å¼',
                    value: {
                        offline: true,
                        downloadThroughput: 0,
                        uploadThroughput: 0,
                        latency: 0,
                        connectionType: 'none'
                    }
                },
                slow_3g: {
                    name: 'æ…¢é€Ÿ3G',
                    value: {
                        offline: false,
                        downloadThroughput: 50 * 1024, // 50 KB/s
                        uploadThroughput: 50 * 1024,
                        latency: 2000,
                        connectionType: 'cellular3g'
                    }
                },
                fast_3g: {
                    name: 'å¿«é€Ÿ3G',
                    value: {
                        offline: false,
                        downloadThroughput: 1.6 * 1024 * 1024, // 1.6 MB/s
                        uploadThroughput: 750 * 1024, // 750 KB/s
                        latency: 562.5,
                        connectionType: 'cellular3g'
                    }
                },
                '4g': {
                    name: '4G',
                    value: {
                        offline: false,
                        downloadThroughput: 4 * 1024 * 1024, // 4 MB/s
                        uploadThroughput: 3 * 1024 * 1024, // 3 MB/s
                        latency: 20,
                        connectionType: 'cellular4g'
                    }
                },
                wifi: {
                    name: 'WiFi',
                    value: {
                        offline: false,
                        downloadThroughput: 30 * 1024 * 1024, // 30 MB/s
                        uploadThroughput: 15 * 1024 * 1024, // 15 MB/s
                        latency: 2,
                        connectionType: 'wifi'
                    }
                },
                dsl: {
                    name: 'DSL',
                    value: {
                        offline: false,
                        downloadThroughput: 2 * 1024 * 1024, // 2 MB/s
                        uploadThroughput: 1 * 1024 * 1024, // 1 MB/s
                        latency: 5,
                        connectionType: 'ethernet'
                    }
                },
                custom_low_end: {
                    name: 'ä½ç«¯ç½‘ç»œ',
                    value: {
                        offline: false,
                        downloadThroughput: 400 * 1024, // 400 KB/s
                        uploadThroughput: 400 * 1024,
                        latency: 400,
                        connectionType: 'other'
                    }
                }
            };

            const preset = networkPresets[presetKey];
            if (!preset) return;

            item.config.networkConditions = preset.value;

            // æ›´æ–°UIæ˜¾ç¤º
            renderUrlList();
            showToast(`å·²åº”ç”¨ç½‘ç»œé¢„è®¾: ${preset.name}`, 'success');
        }

        // æ¸²æŸ“URLé…ç½®é¢æ¿ - ä¼˜åŒ–å¸ƒå±€ï¼Œæ¨¡å—åŒ–ç»„ç»‡
        function renderUrlConfigPanel(item) {
            const config = item.config || {};

            return `
                <div style="background: #ffffff; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; margin-top: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
                        <h4 style="margin: 0; font-size: 1em; color: #2d3748; font-weight: 600;">ğŸ”§ URLç‹¬ç«‹é…ç½®</h4>
                        <button type="button" onclick="clearAllUrlConfig('${item.id}')" class="btn-sm" style="padding: 4px 8px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©ºæ‰€æœ‰</button>
                    </div>

                    <!-- é…ç½®æ¨¡å—ï¼šåŸºç¡€é…ç½® -->
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #3182ce;">
                        <h5 style="margin: 0 0 10px 0; font-size: 0.9em; color: #2d3748; font-weight: 600;">ğŸ“ åŸºç¡€é…ç½®</h5>

                        <!-- Cookieé…ç½® -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">ğŸª Cookie</label>
                            <div style="margin-bottom: 6px; display: flex; gap: 6px;">
                                <select id="url-${item.id}-cookie-preset" onchange="applyUrlCookiePreset('${item.id}')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;">
                                    <option value="">é€‰æ‹©é¢„è®¾...</option>
                                    <option value="bilibili_login">Bç«™ç™»å½•æ€</option>
                                    <option value="youtube_login">YouTubeç™»å½•æ€</option>
                                </select>
                                <button type="button" onclick="clearUrlConfig('${item.id}', 'cookie')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-cookie-${item.id}"
                                placeholder='{"name": "value"} æˆ– "name=value"'
                                rows="2"
                                style="width: 100%; padding: 6px; font-family: monospace; font-size: 0.85em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlConfig('${item.id}', 'cookie', this.value)">${escapeHtml(config.cookie || '')}</textarea>
                        </div>

                        <!-- delayMsé…ç½® -->
                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">â±ï¸ å»¶è¿Ÿæ—¶é—´ (delayMs)</label>
                            <input
                                type="number"
                                id="url-config-delay-${item.id}"
                                placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤"
                                value="${config.delayMs || ''}"
                                min="0"
                                step="1000"
                                style="width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;"
                                oninput="updateUrlConfig('${item.id}', 'delayMs', this.value ? parseInt(this.value) : null)">
                        </div>
                    </div>

                    <!-- é…ç½®æ¨¡å—ï¼šç½‘ç»œå’Œèµ„æº -->
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #10b981;">
                        <h5 style="margin: 0 0 10px 0; font-size: 0.9em; color: #2d3748; font-weight: 600;">ğŸŒ ç½‘ç»œå’Œèµ„æº</h5>

                        <!-- HTTP Headers -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">ğŸ“¡ HTTP å¤´</label>
                            <div style="margin-bottom: 6px; display: flex; gap: 6px;">
                                <select id="url-${item.id}-headers-preset" onchange="applyUrlHeadersPreset('${item.id}')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;">
                                    <option value="">é€‰æ‹©é¢„è®¾...</option>
                                    <option value="mobile_chrome">ğŸ“± ç§»åŠ¨Chrome</option>
                                    <option value="mobile_safari">ğŸ“± iPhone Safari</option>
                                    <option value="desktop_chrome">ğŸ–¥ï¸ æ¡Œé¢Chrome</option>
                                    <option value="desktop_mac">ğŸ–¥ï¸ Mac Safari</option>
                                    <option value="with_auth">ğŸ”‘ Bearer Token</option>
                                    <option value="api_key">ğŸ”‘ API Key</option>
                                </select>
                                <button type="button" onclick="clearUrlConfig('${item.id}', 'extraHTTPHeaders')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-headers-${item.id}"
                                placeholder='{"User-Agent": "..."}'
                                rows="2"
                                style="width: 100%; padding: 6px; font-family: monospace; font-size: 0.85em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="try { updateUrlConfig(${item.id}, 'extraHTTPHeaders', this.value ? JSON.parse(this.value) : null); this.style.borderColor='#cbd5e0'; } catch(e) { this.style.borderColor='#fc8181'; }">${escapeHtml(config.extraHTTPHeaders ? JSON.stringify(config.extraHTTPHeaders, null, 2) : '')}</textarea>
                        </div>

                        <!-- Block List -->
                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">ğŸš« é˜»æ­¢åˆ—è¡¨</label>
                            <div style="margin-bottom: 6px; display: flex; gap: 6px;">
                                <select id="url-${item.id}-blocklist-preset" onchange="applyUrlBlocklistPreset('${item.id}')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;">
                                    <option value="">é€‰æ‹©é¢„è®¾...</option>
                                    <option value="block_images">ğŸ–¼ï¸ é˜»æ­¢å›¾ç‰‡</option>
                                    <option value="block_ads">ğŸš« é˜»æ­¢å¹¿å‘Š</option>
                                    <option value="block_analytics">ğŸ“Š é˜»æ­¢ç»Ÿè®¡</option>
                                    <option value="performance_mode">âš¡ æ€§èƒ½æ¨¡å¼</option>
                                    <option value="bilibili_ads">ğŸ…±ï¸ Bç«™å¹¿å‘Š</option>
                                </select>
                                <button type="button" onclick="clearUrlConfig('${item.id}', 'blockList')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-blocklist-${item.id}"
                                placeholder='["*.jpg", "*.png"]'
                                rows="2"
                                style="width: 100%; padding: 6px; font-family: monospace; font-size: 0.85em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="try { updateUrlConfig(${item.id}, 'blockList', this.value ? JSON.parse(this.value) : null); this.style.borderColor='#cbd5e0'; } catch(e) { this.style.borderColor='#fc8181'; }">${escapeHtml(config.blockList ? JSON.stringify(config.blockList, null, 2) : '')}</textarea>
                        </div>
                    </div>

                    <!-- é…ç½®æ¨¡å—ï¼šé¡µé¢å®šåˆ¶ -->
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #8b5cf6;">
                        <h5 style="margin: 0 0 10px 0; font-size: 0.9em; color: #2d3748; font-weight: 600;">ğŸ¨ é¡µé¢å®šåˆ¶</h5>

                        <!-- Custom CSS -->
                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">ğŸ¨ è‡ªå®šä¹‰ CSS</label>
                            <div style="margin-bottom: 6px; display: flex; gap: 6px;">
                                <select id="url-${item.id}-css-preset" onchange="applyUrlCssPreset('${item.id}')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;">
                                    <option value="">é€‰æ‹©é¢„è®¾...</option>
                                    <option value="hide_ads">ğŸš« éšè—å¹¿å‘Š</option>
                                    <option value="dark_mode">ğŸŒ™ æš—é»‘æ¨¡å¼</option>
                                    <option value="performance_boost">âš¡ æ€§èƒ½ä¼˜åŒ–</option>
                                    <option value="bilibili_clean">ğŸ…±ï¸ Bç«™å‡€åŒ–</option>
                                </select>
                                <button type="button" onclick="clearUrlConfig('${item.id}', 'customCss')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-css-${item.id}"
                                placeholder="body { background: red; }"
                                rows="2"
                                style="width: 100%; padding: 6px; font-family: monospace; font-size: 0.85em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlConfig('${item.id}', 'customCss', this.value)">${escapeHtml(config.customCss || '')}</textarea>
                        </div>
                    </div>

                    <!-- é…ç½®æ¨¡å—ï¼šè®¾å¤‡å’Œç½‘ç»œ -->
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #f59e0b;">
                        <h5 style="margin: 0 0 10px 0; font-size: 0.9em; color: #2d3748; font-weight: 600;">ğŸ“± è®¾å¤‡å’Œç½‘ç»œ</h5>

                        <!-- Device Options -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">ğŸ“± è®¾å¤‡æ¨¡æ‹Ÿ</label>
                            <div style="margin-bottom: 6px; display: flex; gap: 6px;">
                                <select id="url-${item.id}-device-preset" onchange="applyUrlDevicePreset('${item.id}')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;">
                                    <option value="">é€‰æ‹©è®¾å¤‡é¢„è®¾...</option>
                                    <optgroup label="ğŸ–¥ï¸ æ¡Œé¢">
                                        <option value="desktop_fullhd">Full HD å…¨å±</option>
                                        <option value="desktop_2k">2K</option>
                                    </optgroup>
                                    <optgroup label="ğŸ“± ç§»åŠ¨">
                                        <option value="mobile_iphone">iPhone</option>
                                        <option value="mobile_android">Android</option>
                                        <option value="mobile_ipad">iPad</option>
                                    </optgroup>
                                </select>
                                <button type="button" onclick="clearUrlDeviceConfig('${item.id}')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©º</button>
                            </div>
                            <select
                                id="url-config-device-type-${item.id}"
                                style="width: 100%; padding: 6px; margin-bottom: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;"
                                onchange="updateUrlDeviceType('${item.id}', this.value)">
                                <option value="">ä½¿ç”¨é»˜è®¤</option>
                                <option value="Desktop" ${config.deviceOptions && config.deviceOptions[0] === 'Desktop' ? 'selected' : ''}>æ¡Œé¢</option>
                                <option value="Mobile" ${config.deviceOptions && config.deviceOptions[0] === 'Mobile' ? 'selected' : ''}>ç§»åŠ¨</option>
                            </select>
                            <div id="url-${item.id}-device-desktop-options" style="display: ${config.deviceOptions && config.deviceOptions[0] === 'Desktop' ? 'block' : 'none'};">
                                <label style="cursor: pointer; font-size: 0.85em;">
                                    <input type="checkbox" id="url-${item.id}-device-fullscreen" ${config.deviceOptions && config.deviceOptions[1]?.fullscreen ? 'checked' : ''} onchange="updateUrlDeviceOptions('${item.id}', 'Desktop', {fullscreen: this.checked})"> å…¨å±æ¨¡å¼
                                </label>
                            </div>
                            <div id="url-${item.id}-device-mobile-options" style="display: ${config.deviceOptions && config.deviceOptions[0] === 'Mobile' ? 'block' : 'none'};">
                                <select id="url-${item.id}-device-mobile-preset" style="width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;" onchange="updateUrlDeviceOptions('${item.id}', 'Mobile', {preset: this.value})">
                                    <option value="android" ${config.deviceOptions && config.deviceOptions[1]?.preset === 'android' ? 'selected' : ''}>Android</option>
                                    <option value="iphone" ${config.deviceOptions && config.deviceOptions[1]?.preset === 'iphone' ? 'selected' : ''}>iPhone</option>
                                </select>
                            </div>
                        </div>

                        <!-- ç½‘ç»œæ¨¡æ‹Ÿé…ç½® -->
                        <div style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; font-size: 0.85em;">ğŸŒ ç½‘ç»œæ¨¡æ‹Ÿ</label>
                            <div style="margin-bottom: 6px; display: flex; gap: 6px;">
                                <select id="url-${item.id}-network-preset" onchange="applyUrlNetworkPreset('${item.id}')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em;">
                                    <option value="">é€‰æ‹©ç½‘ç»œé¢„è®¾...</option>
                                    <option value="slow_3g">ğŸŒ æ…¢é€Ÿ3G</option>
                                    <option value="fast_3g">ğŸ“¶ å¿«é€Ÿ3G</option>
                                    <option value="4g">ğŸ“¶ 4G</option>
                                    <option value="wifi">ğŸ“¡ WiFi</option>
                                </select>
                                <button type="button" onclick="clearUrlConfig('${item.id}', 'networkConditions')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ¸…ç©º</button>
                            </div>
                            ${config.networkConditions ? `<div style="background: #ffffff; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0; margin-top: 6px; font-size: 0.8em; color: #718096;">
                                ${config.networkConditions.offline ? 'ğŸ“µ ç¦»çº¿' : ''}
                                ${config.networkConditions.downloadThroughput ? `ğŸ“¥ ${(config.networkConditions.downloadThroughput / 1024).toFixed(0)} KB/s` : ''}
                                ${config.networkConditions.latency ? `â±ï¸ ${config.networkConditions.latency}ms` : ''}
                            </div>` : ''}
                        </div>
                    </div>

                    <!-- é…ç½®æ¨¡å—ï¼šç”Ÿå‘½å‘¨æœŸé’©å­ -->
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #ef4444;">
                        <h5 style="margin: 0 0 10px 0; font-size: 0.9em; color: #2d3748; font-weight: 600;">âš¡ ç”Ÿå‘½å‘¨æœŸé’©å­</h5>

                        <!-- beforePageLoad -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #4a5568;">ğŸ”§ beforePageLoad</label>
                            <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                <select id="url-${item.id}-hook-beforepageload-preset" onchange="applyUrlHookPreset('${item.id}', 'beforePageLoad')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                    <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                    <option value="set_viewport_1080p">ğŸ–¥ï¸ è®¾ç½®è§†å£ 1080P</option>
                                    <option value="set_viewport_720p">ğŸ–¥ï¸ è®¾ç½®è§†å£ 720P</option>
                                    <option value="set_viewport_mobile">ğŸ“± è®¾ç½®ç§»åŠ¨ç«¯è§†å£</option>
                                    <option value="enable_console_log">ğŸ“‹ å¯ç”¨æ§åˆ¶å°æ—¥å¿—</option>
                                    <option value="block_notifications">ğŸ”• é˜»æ­¢é€šçŸ¥æƒé™</option>
                                    <option value="set_geolocation">ğŸŒ è®¾ç½®åœ°ç†ä½ç½®</option>
                                    <option value="inject_script">ğŸ’‰ æ³¨å…¥å…¨å±€è„šæœ¬</option>
                                    <option value="disable_animations">âš¡ ç¦ç”¨CSSåŠ¨ç”»</option>
                                </select>
                                <button type="button" onclick="clearUrlHook('${item.id}', 'beforePageLoad')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-hook-beforePageLoad-${item.id}"
                                placeholder="// é¡µé¢åŠ è½½å‰æ‰§è¡Œ\n// ä¾‹å¦‚ï¼šawait page.setViewportSize({ width: 1920, height: 1080 });"
                                rows="3"
                                style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlHook('${item.id}', 'beforePageLoad', this.value)">${escapeHtml(config.hooks?.beforePageLoad || '')}</textarea>
                            <small style="color: #718096; font-size: 0.85em;">åœ¨é¡µé¢åŠ è½½ä¹‹å‰æ‰§è¡Œ | ç”¨äºè®¾ç½®ç¯å¢ƒ</small>
                        </div>

                        <!-- onPageLoaded -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #4a5568;">âœ… onPageLoaded</label>
                            <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                <select id="url-${item.id}-hook-onpageloaded-preset" onchange="applyUrlHookPreset('${item.id}', 'onPageLoaded')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                    <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                    <option value="wait_for_video">ğŸ“¹ ç­‰å¾…è§†é¢‘åŠ è½½</option>
                                    <option value="wait_for_content">ğŸ“„ ç­‰å¾…å†…å®¹åŠ è½½</option>
                                    <option value="wait_network_idle">ğŸŒ ç­‰å¾…ç½‘ç»œç©ºé—²</option>
                                    <option value="check_no_errors">ğŸ› æ£€æŸ¥é¡µé¢é”™è¯¯</option>
                                    <option value="scroll_to_load">ğŸ“œ æ»šåŠ¨è§¦å‘æ‡’åŠ è½½</option>
                                    <option value="remove_overlays">âŒ ç§»é™¤å¼¹çª—é®ç½©</option>
                                    <option value="bilibili_wait_player">ğŸ…±ï¸ Bç«™ç­‰å¾…æ’­æ”¾å™¨</option>
                                </select>
                                <button type="button" onclick="clearUrlHook('${item.id}', 'onPageLoaded')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-hook-onPageLoaded-${item.id}"
                                placeholder="// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ\n// ä¾‹å¦‚ï¼šawait page.waitForSelector('.content');"
                                rows="3"
                                style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlHook('${item.id}', 'onPageLoaded', this.value)">${escapeHtml(config.hooks?.onPageLoaded || '')}</textarea>
                            <small style="color: #718096; font-size: 0.85em;">åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ | ç”¨äºéªŒè¯å’Œç­‰å¾…</small>
                        </div>

                        <!-- onPageTesting -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #4a5568;">ğŸ”„ onPageTesting</label>
                            <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                <select id="url-${item.id}-hook-onpagetesting-preset" onchange="applyUrlHookPreset('${item.id}', 'onPageTesting')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                    <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                    <option value="click_play">â–¶ï¸ ç‚¹å‡»æ’­æ”¾æŒ‰é’®</option>
                                    <option value="video_switch">ğŸ”„ åˆ‡æ¢è§†é¢‘</option>
                                    <option value="scroll_page">ğŸ“œ é¡µé¢æ»šåŠ¨</option>
                                    <option value="tab_switch">ğŸ” æ ‡ç­¾é¡µåˆ‡æ¢</option>
                                    <option value="popup_open_close">ğŸªŸ å¼¹çª—å¼€å…³</option>
                                    <option value="list_scroll">ğŸ“‹ åˆ—è¡¨æ— é™æ»šåŠ¨</option>
                                    <option value="image_load">ğŸ–¼ï¸ åŠ¨æ€åŠ è½½å›¾ç‰‡</option>
                                    <option value="bilibili_danmaku">ğŸ…±ï¸ Bç«™å¼¹å¹•å¼€å…³</option>
                                </select>
                                <button type="button" onclick="clearUrlHook('${item.id}', 'onPageTesting')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-hook-onPageTesting-${item.id}"
                                placeholder="// Runtime/MemoryLeak æµ‹è¯•æœŸé—´æ‰§è¡Œ\n// ä¾‹å¦‚ï¼šawait page.click('.button');"
                                rows="3"
                                style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlHook('${item.id}', 'onPageTesting', this.value)">${escapeHtml(config.hooks?.onPageTesting || '')}</textarea>
                            <small style="color: #718096; font-size: 0.85em;">ä»…åœ¨ Runtime æˆ– MemoryLeak æµ‹è¯•æœŸé—´æ‰§è¡Œ | ç”¨äºè§¦å‘ç”¨æˆ·äº¤äº’</small>
                        </div>

                        <!-- onPageCollecting -->
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #4a5568;">ğŸ“Š onPageCollecting</label>
                            <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                <select id="url-${item.id}-hook-onpagecollecting-preset" onchange="applyUrlHookPreset('${item.id}', 'onPageCollecting')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                    <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                    <option value="force_gc">ğŸ—‘ï¸ å¼ºåˆ¶åƒåœ¾å›æ”¶</option>
                                    <option value="pause_video">â¸ï¸ æš‚åœè§†é¢‘</option>
                                    <option value="clear_cache">ğŸ§¹ æ¸…ç†é¡µé¢ç¼“å­˜</option>
                                    <option value="stop_animations">â¹ï¸ åœæ­¢æ‰€æœ‰åŠ¨ç”»</option>
                                    <option value="collect_metrics">ğŸ“Š æ”¶é›†æ€§èƒ½æŒ‡æ ‡</option>
                                </select>
                                <button type="button" onclick="clearUrlHook('${item.id}', 'onPageCollecting')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-hook-onPageCollecting-${item.id}"
                                placeholder="// MemoryLeak æ”¶é›†æ•°æ®æ—¶æ‰§è¡Œ\n// ä¾‹å¦‚ï¼šawait page.evaluate(() => window.gc());"
                                rows="3"
                                style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlHook('${item.id}', 'onPageCollecting', this.value)">${escapeHtml(config.hooks?.onPageCollecting || '')}</textarea>
                            <small style="color: #718096; font-size: 0.85em;">ä»…åœ¨ MemoryLeak æ”¶é›†æ•°æ®æ—¶æ‰§è¡Œ | å»ºè®®ä½¿ç”¨GCé¢„è®¾</small>
                        </div>

                        <!-- onPageUnload -->
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #4a5568;">ğŸ onPageUnload</label>
                            <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                <select id="url-${item.id}-hook-onpageunload-preset" onchange="applyUrlHookPreset('${item.id}', 'onPageUnload')" style="flex: 1; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.85em; background: #edf2f7;">
                                    <option value="">âœ¨ é€‰æ‹©é¢„è®¾...</option>
                                    <option value="save_screenshot">ğŸ“¸ ä¿å­˜æˆªå›¾</option>
                                    <option value="log_final_state">ğŸ“ è®°å½•æœ€ç»ˆçŠ¶æ€</option>
                                    <option value="collect_errors">â— æ”¶é›†é”™è¯¯æ—¥å¿—</option>
                                    <option value="cleanup_listeners">ğŸ§¹ æ¸…ç†äº‹ä»¶ç›‘å¬</option>
                                    <option value="close_connections">ğŸ”Œ å…³é—­è¿æ¥</option>
                                    <option value="export_data">ğŸ“¤ å¯¼å‡ºæ•°æ®</option>
                                </select>
                                <button type="button" onclick="clearUrlHook('${item.id}', 'onPageUnload')" class="btn-sm" style="padding: 6px 10px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">æ¸…ç©º</button>
                            </div>
                            <textarea
                                id="url-config-hook-onPageUnload-${item.id}"
                                placeholder="// é¡µé¢å¸è½½å‰æ‰§è¡Œ\n// ä¾‹å¦‚ï¼šawait page.evaluate(() => console.log('cleanup'));"
                                rows="3"
                                style="width: 100%; padding: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e0; border-radius: 4px;"
                                oninput="updateUrlHook('${item.id}', 'onPageUnload', this.value)">${escapeHtml(config.hooks?.onPageUnload || '')}</textarea>
                            <small style="color: #718096; font-size: 0.85em;">åœ¨é¡µé¢å¸è½½å‰æ‰§è¡Œ | ç”¨äºæ¸…ç†å’Œä¿å­˜</small>
                        </div>
                    </div>

                    <div style="margin-top: 12px; padding: 8px; background: #f7fafc; border-radius: 4px; font-size: 0.8em; color: #718096; text-align: center;">
                        ğŸ’¡ ç•™ç©ºçš„é…ç½®é¡¹å°†ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼
                    </div>
                </div>
            `;
        }

        // æ¸…ç©ºURLçš„æ‰€æœ‰é…ç½®
        function clearAllUrlConfig(itemId) {
            const item = urlItems.find(i => i.id == itemId);
            if (!item) return;

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ­¤URLçš„æ‰€æœ‰é…ç½®å—ï¼Ÿ')) return;

            // æ¸…ç©ºæ‰€æœ‰é…ç½®
            item.config = {};

            renderUrlList();
            showToast('å·²æ¸…ç©ºæ‰€æœ‰é…ç½®', 'info');
        }

        // æ¸²æŸ“URLåˆ—è¡¨
        function renderUrlList() {
            const container = document.getElementById('url-list');

            if (urlItems.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; margin: 0;">æš‚æ— URLï¼Œç‚¹å‡»ä¸Šæ–¹"â• æ·»åŠ URL"æŒ‰é’®æ·»åŠ </p>';
                return;
            }

            container.innerHTML = urlItems.map((item, index) => {
                const hasConfig = hasUrlConfig(item);
                const configBadge = hasConfig ? '<span style="background: #48bb78; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 8px;">âœ“ å·²é…ç½®</span>' : '';

                return `
                <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 10px; border: 1px solid ${hasConfig ? '#48bb78' : '#e2e8f0'};">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #4a5568; min-width: 30px;">URL ${index + 1}:</span>
                        <input type="text"
                               class="url-input"
                               data-id="${item.id}"
                               value="${escapeHtml(item.url)}"
                               placeholder="https://www.bilibili.com"
                               style="flex: 1; padding: 6px 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;"
                               oninput="updateUrlItem('${item.id}', 'url', this.value)">
                        <button type="button"
                                class="btn-secondary btn-sm"
                                onclick="duplicateUrlItem('${item.id}')"
                                style="padding: 6px 12px; font-size: 0.85em; white-space: nowrap;"
                                title="å¤åˆ¶è¯¥URLé¡¹">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                        <button type="button"
                                class="btn-secondary btn-sm"
                                onclick="toggleUrlConfig('${item.id}')"
                                style="padding: 6px 12px; font-size: 0.85em; white-space: nowrap;">
                            ${item.configExpanded ? 'â–²' : 'â–¼'} ç‹¬ç«‹é…ç½®
                        </button>
                        <button type="button"
                                class="btn-danger btn-sm"
                                onclick="removeUrlItem('${item.id}')"
                                style="padding: 6px 12px; font-size: 0.85em;">ğŸ—‘ï¸</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: ${item.configExpanded ? '12px' : '0'};">
                        <span style="font-weight: 600; color: #4a5568; min-width: 30px;">æè¿°:</span>
                        <input type="text"
                               class="desc-input"
                               data-id="${item.id}"
                               value="${escapeHtml(item.description)}"
                               placeholder="ä¾‹å¦‚ï¼šBç«™é¦–é¡µã€è§†é¢‘æ’­æ”¾é¡µ"
                               style="flex: 1; padding: 6px 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9em;"
                               oninput="updateUrlItem('${item.id}', 'description', this.value)">
                        ${configBadge}
                    </div>

                    ${item.configExpanded ? renderUrlConfigPanel(item) : ''}
                </div>
            `}).join('');
        }

        // æ›´æ–°URLé¡¹
        function updateUrlItem(itemId, field, value) {
            const item = urlItems.find(i => i.id == itemId);
            if (item) {
                item[field] = value;
            }
        }

        // æ¸…ç©ºURLåˆ—è¡¨
        function clearUrlList() {
            urlItems = [];
            urlItemCounter = 0;
            renderUrlList();
        }

        // ä»æ—§æ ¼å¼åŠ è½½URLsï¼ˆå…¼å®¹æ€§ï¼‰
        function loadUrlsFromOldFormat(urls) {
            clearUrlList();
            urls.forEach(url => {
                addUrlItem(url, url); // é»˜è®¤æè¿°ä¸ºURLæœ¬èº«
            });
        }

        // ä»æ–°æ ¼å¼åŠ è½½URLsï¼ˆå¸¦æè¿°å’Œé…ç½®ï¼‰
        function loadUrlsFromNewFormat(urlsWithDesc) {
            clearUrlList();
            urlsWithDesc.forEach(item => {
                if (typeof item === 'string') {
                    addUrlItem(item, item, {});
                } else {
                    addUrlItem(item.url || '', item.description || item.url || '', item.config || {});
                }
            });
        }

        // å¡«å……èŠ‚ç‚¹é€‰æ‹©å™¨ä¸‹æ‹‰åˆ—è¡¨
        async function populateWorkerSelector(selectedWorkerId) {
            const workerSelect = document.getElementById('case-worker');
            if (!workerSelect) return;

            try {
                // è·å–æ‰€æœ‰èŠ‚ç‚¹
                const res = await fetch('/api/workers');
                const data = await res.json();
                const workers = data.workers || [];

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                workerSelect.innerHTML = '<option value="">è‡ªåŠ¨åˆ†é…ï¼ˆæ¨èï¼‰</option>';

                // æŒ‰æ€§èƒ½ç­‰çº§åˆ†ç»„
                const tiers = ['high', 'medium', 'low', 'custom', null];
                const tierNames = {
                    high: 'é«˜é…èŠ‚ç‚¹',
                    medium: 'ä¸­é…èŠ‚ç‚¹',
                    low: 'ä½é…èŠ‚ç‚¹',
                    custom: 'è‡ªå®šä¹‰èŠ‚ç‚¹',
                    null: 'æœªåˆ†ç±»èŠ‚ç‚¹'
                };

                for (const tier of tiers) {
                    const workersInTier = workers.filter(w => w.performanceTier === tier);
                    if (workersInTier.length === 0) continue;

                    // æ·»åŠ åˆ†ç»„æ ‡é¢˜ï¼ˆä»…å½“æœ‰å¤šä¸ªåˆ†ç»„æ—¶ï¼‰
                    const hasMixedTiers = workers.some(w => w.performanceTier) &&
                                          workers.some(w => !w.performanceTier);
                    if (hasMixedTiers || new Set(workers.map(w => w.performanceTier)).size > 1) {
                        const groupOption = document.createElement('option');
                        groupOption.disabled = true;
                        groupOption.textContent = `â”€â”€ ${tierNames[tier] || tierNames.null} â”€â”€`;
                        workerSelect.appendChild(groupOption);
                    }

                    // æ·»åŠ è¯¥åˆ†ç»„çš„ workers
                    for (const worker of workersInTier) {
                        const option = document.createElement('option');
                        option.value = worker.id;

                        // è·å–æ€§èƒ½ç­‰çº§åç§°
                        const tierName = worker.performanceTier ?
                            { high: 'é«˜é…', medium: 'ä¸­é…', low: 'ä½é…', custom: 'è‡ªå®šä¹‰' }[worker.performanceTier] : '';

                        option.textContent = tierName ? `${tierName} - ${worker.name}` : worker.name;

                        // å¦‚æœèŠ‚ç‚¹ç¦»çº¿ï¼Œç¦ç”¨é€‰é¡¹
                        if (worker.status !== 'online') {
                            option.disabled = true;
                            option.textContent += ' (ç¦»çº¿)';
                        }

                        // è®¾ç½®tooltip
                        const tooltipParts = [
                            `èŠ‚ç‚¹: ${worker.name}`,
                            `å¹³å°: ${worker.platform} ${worker.arch}`,
                            `CPU: ${worker.cpuCount} æ ¸`,
                            `å†…å­˜: ${worker.memory} GB`
                        ];
                        if (worker.description) {
                            tooltipParts.push(`æè¿°: ${worker.description}`);
                        }
                        option.title = tooltipParts.join('\n');

                        // è®¾ç½®é€‰ä¸­çŠ¶æ€
                        if (selectedWorkerId && worker.id === selectedWorkerId) {
                            option.selected = true;
                        }

                        workerSelect.appendChild(option);
                    }
                }
            } catch (error) {
                console.error('Failed to load workers:', error);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ ç”¨ä¾‹æ¨¡æ€æ¡†
        function showAddCaseModal() {
            const modal = document.getElementById('case-modal');
            console.log('â• showAddCaseModal - æ¸…é™¤å‰ editId:', modal.dataset.editId);

            modal.classList.add('active');
            document.querySelector('.modal-header').textContent = 'â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹';

            // æ¸…ç©ºè¡¨å• - åŸºç¡€å­—æ®µ
            document.getElementById('case-name').value = '';
            document.getElementById('runner-initialization').checked = false;
            document.getElementById('runner-runtime').checked = false;
            document.getElementById('runner-memoryleak').checked = false;
            clearUrlList();
            addUrlItem(); // æ·»åŠ ä¸€ä¸ªç©ºçš„URLé¡¹
            document.getElementById('case-mode').value = 'headless';
            document.getElementById('case-repeat').value = '1';
            document.getElementById('case-anonymous').checked = true;
            document.getElementById('case-cpu-throttling').value = '1';
            document.getElementById('case-description').value = '';
            document.getElementById('case-tags').value = '';

            // æ¸…ç©º Runner é…ç½®
            document.getElementById('runtime-duration').value = '60000';
            document.getElementById('runtime-delay').value = '10000';
            document.getElementById('memoryleak-interval').value = '60000';
            document.getElementById('memoryleak-iterations').value = '3';
            document.getElementById('memoryleak-onpagetesting').value = '';

            // æ¸…ç©ºèŠ‚ç‚¹é€‰æ‹©
            populateWorkerSelector();

            // æ›´æ–°æ˜¾ç¤º
            updateAdvancedConfigDisplay();
            toggleAnonymousMode(); // åˆå§‹åŒ–åŒ¿åæ¨¡å¼çŠ¶æ€

            // ç§»é™¤ç¼–è¾‘æ¨¡å¼æ ‡è®°
            const modal2 = document.getElementById('case-modal');
            delete modal2.dataset.editId;
            console.log('â• showAddCaseModal - æ¸…é™¤å editId:', modal2.dataset.editId, 'hasEditId:', 'editId' in modal2.dataset);
        }

        // ç¼–è¾‘ç”¨ä¾‹
        function editCase(id) {
            console.log('âœï¸ editCase - ç¼–è¾‘ç”¨ä¾‹ ID:', id);
            const testCase = testCases.find(tc => tc.id === id || tc.id == id);
            if (!testCase) {
                console.error('æ— æ³•æ‰¾åˆ°æµ‹è¯•ç”¨ä¾‹:', id, 'ç°æœ‰ç”¨ä¾‹IDs:', testCases.map(tc => tc.id));
                showToast('æ— æ³•æ‰¾åˆ°æµ‹è¯•ç”¨ä¾‹', 'error');
                return;
            }

            document.getElementById('case-modal').classList.add('active');
            document.querySelector('.modal-header').textContent = 'âœï¸ ç¼–è¾‘æµ‹è¯•ç”¨ä¾‹';

            document.getElementById('case-name').value = testCase.name;

            // å¤„ç†runners - å…¼å®¹æ–°æ—§æ ¼å¼
            if (testCase.runners) {
                // æ–°æ ¼å¼ï¼šrunnerså¯¹è±¡
                document.getElementById('runner-initialization').checked = testCase.runners.Initialization?.enabled || false;
                document.getElementById('runner-runtime').checked = testCase.runners.Runtime?.enabled || false;
                document.getElementById('runner-memoryleak').checked = testCase.runners.MemoryLeak?.enabled || false;
            } else if (testCase.runner) {
                // æ—§æ ¼å¼ï¼šå•ä¸ªrunnerå­—ç¬¦ä¸²
                document.getElementById('runner-initialization').checked = testCase.runner === 'Initialization';
                document.getElementById('runner-runtime').checked = testCase.runner === 'Runtime';
                document.getElementById('runner-memoryleak').checked = testCase.runner === 'MemoryLeak';
            }

            // å¤„ç†URLs - æ”¯æŒæ–°æ—§æ ¼å¼
            if (testCase.urlsWithDesc && Array.isArray(testCase.urlsWithDesc)) {
                // æ–°æ ¼å¼ï¼šå¸¦æè¿°çš„URLæ•°ç»„
                loadUrlsFromNewFormat(testCase.urlsWithDesc);
            } else {
                // æ—§æ ¼å¼ï¼šçº¯URLæ•°ç»„
                const urls = testCase.urls || (testCase.url ? [testCase.url] : []);
                loadUrlsFromOldFormat(urls);
            }

            document.getElementById('case-mode').value = testCase.mode || 'headless';
            document.getElementById('case-repeat').value = testCase.repeatCount || 1;
            document.getElementById('case-anonymous').checked = testCase.anonymous !== undefined ? testCase.anonymous : true;
            document.getElementById('case-cpu-throttling').value = testCase.cpuThrottling || 1;

            // å¡«å…… Runner é…ç½®å­—æ®µ
            if (testCase.runners?.Runtime) {
                document.getElementById('runtime-duration').value = testCase.runners.Runtime.durationMs || 60000;
                document.getElementById('runtime-delay').value = testCase.runners.Runtime.delayMs || 10000;
            } else {
                document.getElementById('runtime-duration').value = 60000;
                document.getElementById('runtime-delay').value = 10000;
            }

            if (testCase.runners?.MemoryLeak) {
                document.getElementById('memoryleak-interval').value = testCase.runners.MemoryLeak.intervalMs || 60000;
                document.getElementById('memoryleak-iterations').value = testCase.runners.MemoryLeak.iterations || 3;
                document.getElementById('memoryleak-onpagetesting').value = testCase.runners.MemoryLeak.onPageTesting || '';
            } else {
                document.getElementById('memoryleak-interval').value = 60000;
                document.getElementById('memoryleak-iterations').value = 3;
                document.getElementById('memoryleak-onpagetesting').value = '';
            }

            document.getElementById('case-description').value = testCase.description || '';
            document.getElementById('case-tags').value = (testCase.tags || []).join(', ');

            // å¡«å……èŠ‚ç‚¹é€‰æ‹©
            populateWorkerSelector(testCase.workerId);

            // æ›´æ–°æ˜¾ç¤º
            updateAdvancedConfigDisplay();
            toggleAnonymousMode(); // åˆå§‹åŒ–åŒ¿åæ¨¡å¼çŠ¶æ€

            // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
            const editModal = document.getElementById('case-modal');
            editModal.dataset.editId = id;
        }

        // ä¿å­˜ç”¨ä¾‹
        function saveCase() {
            const name = document.getElementById('case-name').value.trim();
            const initChecked = document.getElementById('runner-initialization').checked;
            const runtimeChecked = document.getElementById('runner-runtime').checked;
            const memoryChecked = document.getElementById('runner-memoryleak').checked;
            const mode = document.getElementById('case-mode').value;
            const repeatCount = parseInt(document.getElementById('case-repeat').value);
            const anonymous = document.getElementById('case-anonymous').checked;
            const cpuThrottling = parseInt(document.getElementById('case-cpu-throttling').value) || 1;
            const description = document.getElementById('case-description').value.trim();
            const tags = document.getElementById('case-tags').value.split(',').map(t => t.trim()).filter(t => t);

            // è°ƒè¯•æ—¥å¿—
            console.log('ğŸ’¾ ä¿å­˜ç”¨ä¾‹ - åŒ¿åæ¨¡å¼:', anonymous, 'èŠ‚æµ:', cpuThrottling);

            if (!name) {
                showToast('è¯·è¾“å…¥ç”¨ä¾‹åç§°', 'error');
                return;
            }

            // æ£€æŸ¥è‡³å°‘é€‰æ‹©ä¸€ä¸ªrunner
            if (!initChecked && !runtimeChecked && !memoryChecked) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæµ‹è¯•ç±»å‹', 'error');
                return;
            }

            // ä» urlItems æ”¶é›† URL å’Œæè¿°
            if (urlItems.length === 0) {
                showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªURL', 'error');
                return;
            }

            // éªŒè¯ URL æ ¼å¼å¹¶æ„å»ºæ•°æ®ç»“æ„
            const urlsWithDesc = [];
            const invalidUrls = [];

            for (const item of urlItems) {
                const url = item.url.trim();
                const desc = item.description.trim();

                if (!url) {
                    showToast('å­˜åœ¨ç©ºçš„URLï¼Œè¯·å¡«å†™æˆ–åˆ é™¤', 'error');
                    return;
                }

                if (!isValidURL(url)) {
                    invalidUrls.push(url);
                    continue;
                }

                const urlConfig = {
                    url: url,
                    description: desc || url  // å¦‚æœæ²¡æœ‰æè¿°ï¼Œä½¿ç”¨URLæœ¬èº«
                };

                // ğŸ†• æ·»åŠ per-URLé…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.config && Object.keys(item.config).length > 0) {
                    urlConfig.config = item.config;
                }

                urlsWithDesc.push(urlConfig);
            }

            if (invalidUrls.length > 0) {
                showToast(`ä»¥ä¸‹URLæ ¼å¼æ— æ•ˆï¼š\n${invalidUrls.join('\n')}`, 'error');
                return;
            }

            // ä¸ºäº†å…¼å®¹æ€§ï¼Œä¹Ÿä¿ç•™çº¯URLæ•°ç»„
            const urls = urlsWithDesc.map(item => item.url);

            // è¯»å–é«˜çº§é…ç½®å€¼
            const runtimeDuration = parseInt(document.getElementById('runtime-duration').value) || 60000;
            const runtimeDelay = parseInt(document.getElementById('runtime-delay').value) || 10000;
            const memoryInterval = parseInt(document.getElementById('memoryleak-interval').value) || 60000;
            const memoryIterations = parseInt(document.getElementById('memoryleak-iterations').value) || 3;
            const memoryOnPageTesting = document.getElementById('memoryleak-onpagetesting').value.trim();

            // æ„å»ºrunnersé…ç½®å¯¹è±¡
            const runners = {
                Initialization: {
                    enabled: initChecked,
                    repeatCount: repeatCount
                },
                Runtime: {
                    enabled: runtimeChecked,
                    repeatCount: repeatCount,
                    durationMs: runtimeDuration,
                    delayMs: runtimeDelay
                },
                MemoryLeak: {
                    enabled: memoryChecked,
                    repeatCount: repeatCount,
                    intervalMs: memoryInterval,
                    iterations: memoryIterations,
                    onPageTesting: memoryOnPageTesting
                }
            };

            // è·å–é€‰ä¸­çš„èŠ‚ç‚¹
            const selectedWorkerId = document.getElementById('case-worker').value || undefined;

            const modal = document.getElementById('case-modal');
            const editId = modal.dataset.editId;

            if (editId && editId !== 'undefined' && editId !== '') {
                // ç¼–è¾‘æ¨¡å¼
                console.log('âœï¸ ç¼–è¾‘æ¨¡å¼ - æ›´æ–°ç”¨ä¾‹ ID:', editId);
                const testCase = testCases.find(tc => {
                    return tc.id === parseInt(editId) || tc.id === editId || String(tc.id) === String(editId);
                });
                if (testCase) {
                    testCase.name = name;
                    testCase.runners = runners;
                    testCase.urls = urls;
                    testCase.urlsWithDesc = urlsWithDesc;  // æ–°å¢ï¼šå¸¦æè¿°çš„URLæ•°ç»„
                    testCase.mode = mode;
                    testCase.repeatCount = repeatCount;
                    testCase.anonymous = anonymous;
                    testCase.cpuThrottling = cpuThrottling;
                    testCase.description = description;
                    testCase.tags = tags;
                    testCase.workerId = selectedWorkerId;  // æ–°å¢ï¼šä¿å­˜é€‰ä¸­çš„èŠ‚ç‚¹
                    // ç§»é™¤æ—§çš„å­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    delete testCase.url;
                    delete testCase.runner;

                    // åŒæ­¥åˆ°åç«¯
                    saveTestCaseToBackend(testCase).then(saved => {
                        if (saved) {
                            // æ›´æ–°æœ¬åœ°IDä¸ºåç«¯è¿”å›çš„ID
                            testCase.id = saved.id;
                        }
                        saveToStorage();
                        renderCases();
                    });

                    showToast('ç”¨ä¾‹æ›´æ–°æˆåŠŸ', 'success');
                    // æ¸…é™¤ç¼–è¾‘æ¨¡å¼æ ‡è®°
                    delete modal.dataset.editId;

                    // ç¼–è¾‘æ¨¡å¼ä¸‹ç«‹å³å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°æ˜¾ç¤º
                    saveToStorage();
                    renderCases();
                    closeModal();
                } else {
                    showToast('æ— æ³•æ‰¾åˆ°è¦ç¼–è¾‘çš„ç”¨ä¾‹', 'error');
                }
            } else {
                // æ–°å¢æ¨¡å¼
                console.log('â• æ–°å¢æ¨¡å¼');
                const newCase = {
                    name,
                    runners,
                    urls,
                    urlsWithDesc,  // æ–°å¢ï¼šå¸¦æè¿°çš„URLæ•°ç»„
                    mode,
                    repeatCount,
                    anonymous,
                    cpuThrottling,
                    description,
                    tags,
                    workerId: selectedWorkerId,  // æ–°å¢ï¼šä¿å­˜é€‰ä¸­çš„èŠ‚ç‚¹
                    createdAt: new Date().toISOString(),
                    executionHistory: [] // åˆå§‹åŒ–æ‰§è¡Œå†å²ä¸ºç©ºæ•°ç»„
                };

                // å…ˆä¿å­˜åˆ°åç«¯è·å–ID
                saveTestCaseToBackend(newCase).then(saved => {
                    if (saved) {
                        // ä½¿ç”¨åç«¯è¿”å›çš„å®Œæ•´å¯¹è±¡ï¼ˆåŒ…å«åç«¯ç”Ÿæˆçš„IDï¼‰
                        testCases.push(saved);
                    } else {
                        // å¦‚æœåç«¯ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨ä¸´æ—¶IDä¿å­˜åˆ°æœ¬åœ°
                        newCase.id = Date.now();
                        testCases.push(newCase);
                    }
                    saveToStorage();
                    renderCases();
                });

                showToast('ç”¨ä¾‹æ·»åŠ æˆåŠŸ', 'success');

                // æ–°å¢æ¨¡å¼ä¸‹ç«‹å³å…³é—­æ¨¡æ€æ¡†
                closeModal();
            }
        }

        // åˆ é™¤ç”¨ä¾‹
        async function deleteCase(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹å—ï¼Ÿ')) return;

            // ä»åç«¯åˆ é™¤
            await deleteTestCaseFromBackend(id);

            // ä»æœ¬åœ°åˆ é™¤
            testCases = testCases.filter(tc => tc.id != id);
            selectedCases.delete(id);
            saveToStorage();
            renderCases();
            showToast('ç”¨ä¾‹å·²åˆ é™¤', 'success');
        }

        // æµ‹è¯•æ ‡è®°è¾“å…¥ç›¸å…³çš„å…¨å±€å˜é‡
        let testLabelCallback = null;
        let currentTestCaseId = null;

        // æ˜¾ç¤ºæµ‹è¯•æ ‡è®°è¾“å…¥å¼¹çª—
        function showTestLabelModal(caseId, callback) {
            currentTestCaseId = caseId;
            testLabelCallback = callback;
            document.getElementById('test-label-input').value = '';
            document.getElementById('test-label-modal').style.display = 'flex';
            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('test-label-input').focus();
            }, 100);
        }

        // ç¡®è®¤æµ‹è¯•æ ‡è®°è¾“å…¥
        function confirmTestLabelInput(skipLabel) {
            const label = skipLabel === null ? '' : document.getElementById('test-label-input').value.trim();
            document.getElementById('test-label-modal').style.display = 'none';

            if (testLabelCallback) {
                testLabelCallback(label);
                testLabelCallback = null;
            }
        }

        // å–æ¶ˆæµ‹è¯•æ ‡è®°è¾“å…¥
        function cancelTestLabelInput() {
            document.getElementById('test-label-modal').style.display = 'none';
            testLabelCallback = null;
            currentTestCaseId = null;
        }

        // æ”¯æŒå›è½¦é”®ç¡®è®¤
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('test-label-input');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmTestLabelInput();
                    }
                });
            }
        });

        // è¿è¡Œå•ä¸ªç”¨ä¾‹
        async function runCase(id, testLabel = '') {
            const testCase = testCases.find(tc => tc.id == id);
            if (!testCase) return;

            // å¦‚æœæ˜¯å•ä¸ªè¿è¡Œï¼ˆæ²¡æœ‰ä¼ å…¥testLabelï¼‰ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—è¯¢é—®æµ‹è¯•æ ‡è®°
            if (!testLabel && arguments.length === 1) {
                return new Promise((resolve) => {
                    showTestLabelModal(id, (label) => {
                        testLabel = label;
                        executeRun(id, testLabel);
                        resolve();
                    });
                });
            }

            executeRun(id, testLabel);
        }

        // æ‰§è¡Œè¿è¡Œé€»è¾‘
        async function executeRun(id, testLabel) {
            const testCase = testCases.find(tc => tc.id == id);
            if (!testCase) return;

            // ç§»é™¤å•ä»»åŠ¡é™åˆ¶ï¼Œå…è®¸å¹¶å‘æ‰§è¡Œ
            const runningCount = Array.from(backendTasks.values()).filter(t => t.status === 'running').length;
            if (runningCount >= MAX_CONCURRENT) {
                showToast(`å½“å‰å·²æœ‰ ${runningCount} ä¸ªä»»åŠ¡åœ¨è¿è¡Œï¼Œå°†è¿›å…¥é˜Ÿåˆ—ç­‰å¾…`, 'info');
            }

            testCase.status = 'pending';
            renderCases();

            // æ„å»ºä»»åŠ¡åç§°
            const taskName = testLabel ? `[${testLabel}] ${testCase.name}` : testCase.name;

            try {
                // è·å–URLs - æ”¯æŒæ–°æ ¼å¼ï¼ˆå¸¦æè¿°ï¼‰å’Œæ—§æ ¼å¼
                let urlsData = [];
                const mode = testCase.mode || 'headless';

                if (testCase.urlsWithDesc && testCase.urlsWithDesc.length > 0) {
                    // æ–°æ ¼å¼ï¼šå¸¦æè¿°çš„URLæ•°ç»„
                    urlsData = testCase.urlsWithDesc;
                } else {
                    // æ—§æ ¼å¼ï¼šçº¯URLæ•°ç»„
                    const urls = testCase.urls || (testCase.url ? [testCase.url] : []);
                    urlsData = urls.map(url => ({
                        url: url,
                        description: url
                    }));
                }

                if (urlsData.length === 0) {
                    throw new Error('æµ‹è¯•ç”¨ä¾‹æ²¡æœ‰é…ç½®URL');
                }

                // æ„å»º testCases æ•°ç»„ - å°† URLs è½¬æ¢ä¸º testCases å¹¶åº”ç”¨é«˜çº§é…ç½®
                const advConfig = testCase.advancedConfig || {};
                console.log('ğŸ”§ è¿è¡Œæ—¶ - ç”¨ä¾‹çš„advancedConfig:', advConfig);

                const testCasesArray = urlsData.map(item => {
                    const tc = {
                        target: item.url,
                        description: item.description || item.url  // ä½¿ç”¨è‡ªå®šä¹‰æè¿°æˆ–URLæœ¬èº«
                    };

                    // åº”ç”¨å…¨å±€é«˜çº§é…ç½®ï¼ˆé»˜è®¤é…ç½®ï¼‰
                    if (advConfig.delayMs !== undefined) tc.delayMs = advConfig.delayMs;
                    if (advConfig.cookie) tc.cookie = advConfig.cookie;
                    if (advConfig.autoCookie) tc.autoCookie = advConfig.autoCookie;  // ğŸ†• æ·»åŠ è‡ªåŠ¨Cookieæ”¯æŒ
                    if (advConfig.extraHTTPHeaders) tc.extraHTTPHeaders = advConfig.extraHTTPHeaders;
                    if (advConfig.blockList) tc.blockList = advConfig.blockList;
                    if (advConfig.customCss) tc.customCss = advConfig.customCss;
                    if (advConfig.deviceOptions) tc.deviceOptions = advConfig.deviceOptions;
                    if (advConfig.hooks) tc.hooks = advConfig.hooks;

                    // ğŸ†• åº”ç”¨per-URLé…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä¼šè¦†ç›–å…¨å±€é…ç½®
                    if (item.config) {
                        tc.config = item.config;
                        console.log('âœ¨ URLæœ‰ç‹¬ç«‹é…ç½®:', item.url, item.config);
                    }

                    // å°†æ•´ä¸ªadvancedConfigä¼ é€’ï¼Œä»¥ä¾¿åç«¯å¤„ç†autoCookie
                    tc.advancedConfig = advConfig;

                    console.log('ğŸ“ æ„å»ºçš„testCase:', tc);

                    return tc;
                });

                // æ„å»ºrunnersé…ç½® - å…¼å®¹æ–°æ—§æ ¼å¼
                let runnersConfig = {};
                let enabledRunners = [];

                if (testCase.runners) {
                    // æ–°æ ¼å¼ï¼šå¤šrunneræ”¯æŒ
                    if (testCase.runners.Initialization?.enabled) {
                        runnersConfig.Initialization = {
                            enabled: true,
                            testCases: testCasesArray,
                            iterations: testCase.runners.Initialization.iterations || 7
                        };
                        enabledRunners.push('Initialization');
                    }

                    if (testCase.runners.Runtime?.enabled) {
                        runnersConfig.Runtime = {
                            enabled: true,
                            testCases: testCasesArray,
                            durationMs: testCase.runners.Runtime.durationMs || 60000,
                            delayMs: testCase.runners.Runtime.delayMs || 10000
                        };
                        enabledRunners.push('Runtime');
                    }

                    if (testCase.runners.MemoryLeak?.enabled) {
                        // ä¸º MemoryLeak å¤„ç† onPageTestingï¼ˆå‘åå…¼å®¹ï¼‰
                        const memoryTestCases = testCasesArray.map(tc => {
                            const mtc = { ...tc };
                            if (testCase.runners.MemoryLeak.onPageTesting) {
                                mtc.onPageTesting = testCase.runners.MemoryLeak.onPageTesting;
                            }
                            return mtc;
                        });

                        runnersConfig.MemoryLeak = {
                            enabled: true,
                            testCases: memoryTestCases,
                            intervalMs: testCase.runners.MemoryLeak.intervalMs || 60000,
                            iterations: testCase.runners.MemoryLeak.iterations || 3
                        };
                        enabledRunners.push('MemoryLeak');
                    }
                } else if (testCase.runner) {
                    // æ—§æ ¼å¼ï¼šå•ä¸ªrunner
                    runnersConfig[testCase.runner] = {
                        enabled: true,
                        testCases: testCasesArray
                    };
                    enabledRunners.push(testCase.runner);
                }

                if (Object.keys(runnersConfig).length === 0) {
                    throw new Error('æµ‹è¯•ç”¨ä¾‹æ²¡æœ‰å¯ç”¨ä»»ä½•æµ‹è¯•ç±»å‹');
                }

                // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº† Worker èŠ‚ç‚¹
                // ä¼˜å…ˆä½¿ç”¨ç”¨ä¾‹é…ç½®çš„èŠ‚ç‚¹ï¼Œå…¶æ¬¡ä½¿ç”¨å…¨å±€é€‰æ‹©çš„èŠ‚ç‚¹
                let selectedWorkerId = testCase.workerId || (workerSelector ? workerSelector.getSelectedWorkerId() : null);

                // ğŸ†• é»˜è®¤ä¸­ç«¯æ€§èƒ½æœºå™¨ï¼šå¦‚æœæœªé€‰æ‹©Workerï¼Œè‡ªåŠ¨é€‰æ‹©ä¸­é…Worker
                if (!selectedWorkerId || selectedWorkerId === 'local') {
                    const workers = workerSelector ? workerSelector.getOnlineWorkers() : [];
                    if (workers.length > 0) {
                        // ä¼˜å…ˆé€‰æ‹©ä¸­é…Worker
                        const mediumWorker = workers.find(w => w.performanceTier === 'medium');
                        if (mediumWorker) {
                            selectedWorkerId = mediumWorker.id;
                            console.log(`[RunCase] ğŸ¯ æœªé€‰æ‹©Workerï¼Œé»˜è®¤ä½¿ç”¨ä¸­é…Worker: ${mediumWorker.name}`);
                            appendOutput(`[ç³»ç»Ÿ] ğŸ¯ è‡ªåŠ¨é€‰æ‹©ä¸­é…Worker: ${mediumWorker.name}`);
                        } else {
                            // å¦‚æœæ²¡æœ‰ä¸­é…ï¼ŒæŒ‰ä¼˜å…ˆçº§é€‰æ‹©ï¼šlow > high > custom
                            const lowWorker = workers.find(w => w.performanceTier === 'low');
                            const highWorker = workers.find(w => w.performanceTier === 'high');
                            const fallbackWorker = lowWorker || highWorker || workers[0];

                            if (fallbackWorker) {
                                selectedWorkerId = fallbackWorker.id;
                                console.log(`[RunCase] âš ï¸ æ— ä¸­é…Workerï¼Œä½¿ç”¨å¤‡é€‰: ${fallbackWorker.name} (${fallbackWorker.performanceTier})`);
                                appendOutput(`[ç³»ç»Ÿ] âš ï¸ æ— ä¸­é…Workerï¼Œä½¿ç”¨å¤‡é€‰: ${fallbackWorker.name}`);
                            }
                        }
                    }
                }

                let response, result;

                if (selectedWorkerId && selectedWorkerId !== 'local') {
                    // ä½¿ç”¨åˆ†å¸ƒå¼ API
                    appendOutput(`[ç³»ç»Ÿ] ğŸŒ ä½¿ç”¨åˆ†å¸ƒå¼æ‰§è¡Œï¼Œç›®æ ‡èŠ‚ç‚¹: ${selectedWorkerId}`);

                    response = await fetch('/api/distributed-tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            testCaseId: testCase.id,
                            workerId: selectedWorkerId,
                            runner: enabledRunners[0], // åˆ†å¸ƒå¼APIå½“å‰åªæ”¯æŒå•ä¸ªrunner
                            config: {
                                mode: {
                                    anonymous: testCase.anonymous !== undefined ? testCase.anonymous : true,
                                    headless: mode === 'headless'
                                },
                                cpuThrottlingRate: testCase.cpuThrottling || 1,
                                runners: runnersConfig
                            },
                            remarks: testLabel || undefined
                        })
                    });

                    result = await response.json();

                    if (!result.success) {
                        throw new Error(result.message || result.error || 'åˆ†å¸ƒå¼ä»»åŠ¡åˆ›å»ºå¤±è´¥');
                    }

                    showToast(`âœ… åˆ†å¸ƒå¼ä»»åŠ¡å·²åˆ›å»º: ${taskName}`, 'success');
                    appendOutput(`[ç³»ç»Ÿ] ğŸŒ åˆ†å¸ƒå¼ä»»åŠ¡å·²æäº¤åˆ°èŠ‚ç‚¹: ${selectedWorkerId}`);
                } else {
                    // ä½¿ç”¨æœ¬åœ°æ‰§è¡Œ API
                    appendOutput(`[ç³»ç»Ÿ] ğŸ’» ä½¿ç”¨æœ¬åœ°æ‰§è¡Œ`);

                    response = await fetch('/api/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: taskName, // ä½¿ç”¨å¸¦æ ‡è®°çš„ä»»åŠ¡åç§°
                            testCaseId: testCase.id && testCase.id.toString().startsWith('testcase_') ? testCase.id : undefined, // å…³è”æµ‹è¯•ç”¨ä¾‹ID
                            remarks: testLabel || undefined, // å¤‡æ³¨ï¼šæµ‹è¯•ç›®çš„ã€ç‰ˆæœ¬ç­‰ä¿¡æ¯
                            config: {
                                mode: {
                                    anonymous: testCase.anonymous !== undefined ? testCase.anonymous : true,
                                    headless: mode === 'headless'
                                },
                                cpuThrottlingRate: testCase.cpuThrottling || 1,
                                runners: runnersConfig
                            }
                        })
                    });

                    result = await response.json();

                    if (!result.success) {
                        throw new Error(result.message || result.error || 'å¯åŠ¨æµ‹è¯•å¤±è´¥');
                    }

                    showToast(`ä»»åŠ¡å·²åˆ›å»º: ${taskName}`, 'success');
                    appendOutput(`[ç³»ç»Ÿ] æµ‹è¯•ç”¨ä¾‹ "${taskName}" å·²æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—`);
                }

                // é€šç”¨è¾“å‡º
                if (testLabel) {
                    appendOutput(`[ç³»ç»Ÿ] æµ‹è¯•æ ‡è®°: ${testLabel}`);
                }
                appendOutput(`[ç³»ç»Ÿ] ä»»åŠ¡ID: ${result.taskId}`);
                appendOutput(`[ç³»ç»Ÿ] è¿è¡Œæ¨¡å¼: ${mode === 'headless' ? 'æ— å¤´æ¨¡å¼' : 'æœ‰å¤´æ¨¡å¼'}`);
                appendOutput(`[ç³»ç»Ÿ] æµ‹è¯•ç±»å‹: ${enabledRunners.join(' + ')}`);
                appendOutput(`[ç³»ç»Ÿ] æµ‹è¯• ${urlsData.length} ä¸ªURL, é‡å¤ ${testCase.repeatCount || 1} æ¬¡`);
            } catch (error) {
                testCase.status = 'error';
                renderCases();
                showToast('è¿è¡Œå¤±è´¥: ' + error.message, 'error');
                appendOutput(`[é”™è¯¯] ${error.message}`);
            }
        }

        // æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤º - æ˜¾ç¤ºåç«¯ä»»åŠ¡çŠ¶æ€
        function updateQueueDisplay() {
            const queueCard = document.getElementById('queue-card');
            const queueList = document.getElementById('queue-list');

            const tasks = Array.from(backendTasks.values());

            if (tasks.length === 0) {
                queueCard.style.display = 'none';
                return;
            }

            queueCard.style.display = 'block';

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼ˆcompleted æˆ– errorï¼‰
            const allCompleted = tasks.every(task =>
                task.status === 'completed' || task.status === 'error'
            );

            // å¦‚æœæ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œ3ç§’åè‡ªåŠ¨æ¸…ç©ºé˜Ÿåˆ—
            if (allCompleted && tasks.length > 0) {
                setTimeout(() => {
                    // å†æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿åœ¨è¿™3ç§’å†…æ²¡æœ‰æ–°ä»»åŠ¡åŠ å…¥
                    const currentTasks = Array.from(backendTasks.values());
                    const stillAllCompleted = currentTasks.every(task =>
                        task.status === 'completed' || task.status === 'error'
                    );

                    if (stillAllCompleted && currentTasks.length > 0) {
                        backendTasks.clear();
                        updateStats();
                        updateQueueDisplay();
                        showToast('æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œé˜Ÿåˆ—å·²è‡ªåŠ¨æ¸…ç©º', 'success');
                    }
                }, 3000);
            }

            // æŒ‰çŠ¶æ€æ’åºï¼šrunning -> pending -> completed -> error
            const sortedTasks = tasks.sort((a, b) => {
                const statusOrder = { running: 0, pending: 1, completed: 2, error: 3 };
                return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
            });

            const queueHTML = sortedTasks.map(task => {
                const statusIcons = {
                    running: 'ğŸ”„',
                    pending: 'â³',
                    completed: 'âœ…',
                    error: 'âŒ'
                };
                const statusTexts = {
                    running: 'æ­£åœ¨è¿è¡Œ',
                    pending: 'ç­‰å¾…ä¸­',
                    completed: 'å·²å®Œæˆ',
                    error: 'å¤±è´¥'
                };
                const bgColors = {
                    running: '#fef3c7',
                    pending: '#f3f4f6',
                    completed: '#d1fae5',
                    error: '#fee2e2'
                };

                const icon = statusIcons[task.status] || 'â“';
                const statusText = statusTexts[task.status] || 'æœªçŸ¥';
                const bgColor = bgColors[task.status] || '#f3f4f6';

                // Perfcaté“¾æ¥
                const perfcatLinks = task.perfcatUrl ? `
                    <div style="margin-top: 6px;">
                        <a href="${task.perfcatUrl}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 0.9em; margin-right: 10px;">
                            ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š
                        </a>
                        <a href="${task.perfcatUrl}&viewType=chart" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 0.9em;">
                            ğŸ“ˆ å›¾è¡¨æ¨¡å¼
                        </a>
                    </div>
                ` : '';

                // æ—¥å¿—æŠ˜å æŒ‰é’®ï¼ˆè¿è¡Œä¸­æˆ–å·²å®Œæˆçš„ä»»åŠ¡æ˜¾ç¤ºï¼‰
                const logButton = (task.status === 'running' || task.status === 'completed' || task.status === 'error') ? `
                    <button class="btn-secondary btn-sm" onclick="toggleTaskLog('${task.id}')" id="log-toggle-${task.id}" style="margin-left: 5px;">
                        ğŸ“‹ éšè—æ—¥å¿—
                    </button>
                ` : '';

                // è·å–æ—¥å¿—å†…å®¹
                let logText = '';
                if (Array.isArray(task.logs)) {
                    // logsæ•°ç»„æ ¼å¼ï¼ˆåˆ†å¸ƒå¼ä»»åŠ¡ï¼‰
                    logText = task.logs.join('\n');
                } else if (typeof task.output === 'string') {
                    // outputå­—ç¬¦ä¸²æ ¼å¼ï¼ˆæœ¬åœ°ä»»åŠ¡ï¼‰
                    logText = task.output;
                }

                // å†…è”æ—¥å¿—è¾“å‡ºåŒºåŸŸï¼ˆé»˜è®¤å±•å¼€ï¼‰
                const logOutput = (task.status === 'running' || task.status === 'completed' || task.status === 'error') ? `
                    <div id="task-log-${task.id}" style="display: block; margin-top: 10px; background: #f8f9fa; border: 1px solid #e2e8f0; border-radius: 4px; padding: 12px; max-height: 300px; overflow-y: auto;">
                        <pre style="margin: 0; font-family: 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; color: #1f2937;">${escapeHtml(logText) || '<span style="color: #9ca3af;">æš‚æ— æ—¥å¿—è¾“å‡º...</span>'}</pre>
                    </div>
                ` : '';

                return `
                    <div style="padding: 10px; margin-bottom: 8px; background: ${bgColor}; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div>
                                    <strong>${escapeHtml(task.name)}</strong>
                                    <span style="margin-left: 10px; color: #6b7280; font-size: 0.9em;">${icon} ${statusText}</span>
                                    <span style="margin-left: 10px; color: #9ca3af; font-size: 0.85em;">${task.runner}</span>
                                </div>
                                ${perfcatLinks}
                            </div>
                            <div>
                                ${logButton}
                                ${task.status === 'running' ? `
                                    <button class="btn-danger btn-sm" onclick="stopTask('${task.id}')" style="margin-left: 5px;" title="ä¼˜é›…åœæ­¢ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰">åœæ­¢</button>
                                    <button class="btn-danger btn-sm" onclick="stopTask('${task.id}', true)" style="margin-left: 5px; background: #991b1b;" title="ç«‹å³å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹">å¼ºåˆ¶åœæ­¢</button>
                                ` : ''}
                                ${task.status === 'pending' ? `<button class="btn-danger btn-sm" onclick="deleteTask('${task.id}')" style="margin-left: 5px;">å–æ¶ˆ</button>` : ''}
                                ${(task.status === 'completed' || task.status === 'error') ? `<button class="btn-secondary btn-sm" onclick="deleteTask('${task.id}')" style="margin-left: 5px;">ç§»é™¤</button>` : ''}
                            </div>
                        </div>
                        ${logOutput}
                    </div>
                `;
            }).join('');

            queueList.innerHTML = queueHTML || '<p style="color: #9ca3af;">é˜Ÿåˆ—ä¸ºç©º</p>';
        }

        // æ–°å¢ï¼šåœ¨æ–°çª—å£æ‰“å¼€ä»»åŠ¡æ—¥å¿—
        function openTaskLogWindow(taskId) {
            const task = backendTasks.get(taskId);
            if (!task) return;

            // è·å–æ—¥å¿—å†…å®¹
            let logText = '';
            if (Array.isArray(task.logs)) {
                // logsæ•°ç»„æ ¼å¼ï¼ˆåˆ†å¸ƒå¼ä»»åŠ¡ï¼‰
                logText = task.logs.join('\n');
            } else if (typeof task.output === 'string') {
                // outputå­—ç¬¦ä¸²æ ¼å¼ï¼ˆæœ¬åœ°ä»»åŠ¡ï¼‰
                logText = task.output;
            } else {
                logText = 'æš‚æ— æ—¥å¿—è¾“å‡º...';
            }

            // åˆ›å»ºæ–°çª—å£
            const logWindow = window.open('', `task-log-${taskId}`, 'width=900,height=700,scrollbars=yes,resizable=yes');

            if (!logWindow) {
                showToast('æ— æ³•æ‰“å¼€æ—¥å¿—çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—æ‹¦æˆªè®¾ç½®', 'error');
                return;
            }

            // å†™å…¥HTMLå†…å®¹
            logWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>ä»»åŠ¡æ—¥å¿— - ${escapeHtml(task.name)}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
                            background: #1e293b;
                            color: #e2e8f0;
                            padding: 20px;
                            line-height: 1.6;
                        }
                        .header {
                            background: #334155;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            border-left: 4px solid #3b82f6;
                        }
                        .header h1 {
                            font-size: 1.4em;
                            margin-bottom: 5px;
                            color: #f1f5f9;
                        }
                        .header .meta {
                            font-size: 0.9em;
                            color: #94a3b8;
                        }
                        .log-container {
                            background: #0f172a;
                            padding: 20px;
                            border-radius: 8px;
                            font-family: 'Monaco', 'Courier New', monospace;
                            font-size: 13px;
                            line-height: 1.5;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                            max-width: 100%;
                        }
                        .controls {
                            margin-bottom: 15px;
                            display: flex;
                            gap: 10px;
                        }
                        .btn {
                            padding: 8px 16px;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 0.9em;
                            transition: background 0.2s;
                        }
                        .btn:hover {
                            background: #2563eb;
                        }
                        .btn-secondary {
                            background: #64748b;
                        }
                        .btn-secondary:hover {
                            background: #475569;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 4px 12px;
                            border-radius: 12px;
                            font-size: 0.85em;
                            font-weight: 500;
                        }
                        .status-running {
                            background: #dbeafe;
                            color: #1e40af;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ“‹ ${escapeHtml(task.name)}</h1>
                        <div class="meta">
                            <span class="badge status-running">${task.status === 'running' ? 'è¿è¡Œä¸­' : task.status}</span>
                            <span> | ä»»åŠ¡ID: ${escapeHtml(task.id)}</span>
                            <span> | è¿›åº¦: ${task.progress || 0}%</span>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn" onclick="window.location.reload()">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>
                        <button class="btn btn-secondary" onclick="copyLogs()">ğŸ“‹ å¤åˆ¶æ—¥å¿—</button>
                    </div>
                    <div class="log-container" id="log-content">${escapeHtml(logText) || '<span style="color: #64748b;">æš‚æ— æ—¥å¿—è¾“å‡º...</span>'}</div>
                    <scr` + `ipt>
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        window.scrollTo(0, document.body.scrollHeight);

                        // å¤åˆ¶æ—¥å¿—åŠŸèƒ½
                        function copyLogs() {
                            const logText = document.getElementById('log-content').textContent;
                            navigator.clipboard.writeText(logText).then(() => {
                                // åˆ›å»ºç®€å•çš„æç¤º
                                const tip = document.createElement('div');
                                tip.textContent = 'âœ“ æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                                tip.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;';
                                document.body.appendChild(tip);
                                setTimeout(() => tip.remove(), 2000);
                            }).catch(err => {
                                console.error('å¤åˆ¶å¤±è´¥:', err);
                                const tip = document.createElement('div');
                                tip.textContent = 'âœ• å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶';
                                tip.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;';
                                document.body.appendChild(tip);
                                setTimeout(() => tip.remove(), 3000);
                            });
                        }
                    </scr` + `ipt>
                </body>
                </html>
            `);

            logWindow.document.close();
        }

        // åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º/éšè—
        function toggleTaskLog(taskId) {
            const logElement = document.getElementById(`task-log-${taskId}`);
            const toggleButton = document.getElementById(`log-toggle-${taskId}`);

            if (!logElement || !toggleButton) return;

            if (logElement.style.display === 'none') {
                logElement.style.display = 'block';
                toggleButton.textContent = 'ğŸ“‹ éšè—æ—¥å¿—';
            } else {
                logElement.style.display = 'none';
                toggleButton.textContent = 'ğŸ“‹ æ˜¾ç¤ºæ—¥å¿—';
            }
        }

        // æ›´æ–°ä»»åŠ¡æ—¥å¿—ï¼ˆå®æ—¶æ›´æ–°ï¼‰
        function updateTaskLog(taskId, logText) {
            const logElement = document.getElementById(`task-log-${taskId}`);
            if (!logElement) return;

            const preElement = logElement.querySelector('pre');
            if (preElement) {
                preElement.innerHTML = escapeHtml(logText) || '<span style="color: #9ca3af;">æš‚æ— æ—¥å¿—è¾“å‡º...</span>';
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        // æ–°å¢ï¼šåœæ­¢ä»»åŠ¡
        async function stopTask(taskId, force = false) {
            const task = backendTasks.get(taskId);
            if (!task) {
                showToast('ä»»åŠ¡ä¸å­˜åœ¨', 'error');
                return;
            }

            // å¦‚æœæ˜¯å¼ºåˆ¶åœæ­¢ï¼Œå…ˆç¡®è®¤
            if (force) {
                if (!confirm(`ç¡®å®šè¦å¼ºåˆ¶åœæ­¢ä»»åŠ¡"${task.name}"å—ï¼Ÿ\n\nè¿™å°†ç«‹å³ç»ˆæ­¢è¿›ç¨‹ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚`)) {
                    return;
                }
            } else {
                // æ™®é€šåœæ­¢ä¹Ÿéœ€è¦ç¡®è®¤
                if (!confirm(`ç¡®å®šè¦åœæ­¢ä»»åŠ¡"${task.name}"å—ï¼Ÿ\n\nè¿›ç¨‹å°†è¢«ä¼˜é›…å…³é—­ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰ã€‚`)) {
                    return;
                }
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(force ? 'ä»»åŠ¡å·²å¼ºåˆ¶åœæ­¢' : 'ä»»åŠ¡åœæ­¢ä¸­...', 'success');
                } else {
                    showToast('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('åœæ­¢ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ–°å¢ï¼šåˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ä»»åŠ¡å·²åˆ é™¤', 'success');
                    backendTasks.delete(taskId);
                    updateQueueDisplay();
                } else {
                    showToast('åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡
        function removeFromQueue(index) {
            if (index < runningQueue.length) {
                const removedId = runningQueue.splice(index, 1)[0];
                const testCase = testCases.find(tc => tc.id == removedId);
                if (testCase) {
                    showToast(`å·²ä»é˜Ÿåˆ—ç§»é™¤: ${testCase.name}`, 'success');
                }
                updateQueueDisplay();
            }
        }

        // æ¸…ç©ºé˜Ÿåˆ—
        function clearQueue() {
            // è®¡ç®—ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•°é‡ï¼ˆæ’é™¤æ­£åœ¨è¿è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼‰
            const waitingCount = currentRunning ? runningQueue.length - 1 : runningQueue.length;

            if (waitingCount === 0) {
                showToast('é˜Ÿåˆ—ä¸­æ²¡æœ‰ç­‰å¾…çš„ä»»åŠ¡', 'info');
                return;
            }

            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºé˜Ÿåˆ—ä¸­çš„ ${waitingCount} ä¸ªç­‰å¾…ä»»åŠ¡å—ï¼Ÿå½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¸ä¼šè¢«åœæ­¢ã€‚`)) return;

            // ä¿ç•™ç¬¬ä¸€ä¸ªï¼ˆæ­£åœ¨è¿è¡Œçš„ï¼‰
            if (currentRunning) {
                runningQueue = [runningQueue[0]];
            } else {
                runningQueue = [];
            }

            updateQueueDisplay();
            showToast('é˜Ÿåˆ—å·²æ¸…ç©º', 'success');
        }

        // è¿è¡Œé€‰ä¸­çš„ç”¨ä¾‹
        async function runSelectedCases() {
            if (selectedCases.size === 0) return;

            const selectedArray = Array.from(selectedCases);

            // è·å–æœåŠ¡å™¨å¹¶å‘é™åˆ¶ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰è·å–ï¼‰
            if (!serverMaxConcurrent) {
                try {
                    const tasksResponse = await fetch('/api/tasks');
                    const tasksData = await tasksResponse.json();
                    serverMaxConcurrent = tasksData.maxConcurrent || 10;
                } catch (e) {
                    serverMaxConcurrent = 10; // é»˜è®¤å€¼
                }
            }

            // ğŸ†• è¯¢é—®æµ‹è¯•æ ‡è®°
            const testLabel = prompt(
                `è¯·è¾“å…¥æœ¬æ¬¡æµ‹è¯•çš„æ ‡è®°ï¼ˆå¯é€‰ï¼‰ï¼š\n\n` +
                `å»ºè®®æ ‡è®°æ ¼å¼ï¼š\n` +
                `â€¢ ä¼˜åŒ–å‰ / ä¼˜åŒ–å\n` +
                `â€¢ Baseline / V2.0\n` +
                `â€¢ ä¸»åˆ†æ”¯ / åŠŸèƒ½åˆ†æ”¯\n` +
                `â€¢ ç”Ÿäº§ç¯å¢ƒ / æµ‹è¯•ç¯å¢ƒ\n\n` +
                `æ ‡è®°å°†æ˜¾ç¤ºåœ¨ä»»åŠ¡åç§°ä¸­ï¼Œç•™ç©ºåˆ™ä¸æ·»åŠ æ ‡è®°`,
                '' // é»˜è®¤å€¼ä¸ºç©º
            );

            // å¦‚æœç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œåœæ­¢æ‰§è¡Œ
            if (testLabel === null) return;

            // æ¸…ç†æ ‡è®°ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼ï¼‰
            const cleanedLabel = testLabel.trim();

            // æç¤ºç”¨æˆ·å°†å¹¶è¡Œæ‰§è¡Œ
            const confirmMsg = `å³å°†å¹¶è¡Œæ‰§è¡Œ ${selectedArray.length} ä¸ªæµ‹è¯•ç”¨ä¾‹\n` +
                             (cleanedLabel ? `æµ‹è¯•æ ‡è®°: ${cleanedLabel}\n` : '') +
                             `æœåŠ¡å™¨å¹¶å‘é™åˆ¶: æœ€å¤šåŒæ—¶è¿è¡Œ ${serverMaxConcurrent} ä¸ªä»»åŠ¡\n` +
                             (selectedArray.length > serverMaxConcurrent ?
                              `å‰ ${serverMaxConcurrent} ä¸ªå°†ç«‹å³æ‰§è¡Œï¼Œå…¶ä½™å°†æ’é˜Ÿç­‰å¾…\n` : '') +
                             `ç¡®è®¤æ‰§è¡Œï¼Ÿ`;

            if (!confirm(confirmMsg)) return;

            // å¹¶è¡Œæäº¤æ‰€æœ‰é€‰ä¸­çš„ä»»åŠ¡
            let successCount = 0;
            let failCount = 0;

            showToast(`ğŸš€ æ­£åœ¨å¹¶è¡Œæäº¤ ${selectedArray.length} ä¸ªä»»åŠ¡...`, 'info');
            appendOutput(`\n========== æ‰¹é‡å¹¶è¡Œæ‰§è¡Œå¼€å§‹ ==========`);
            appendOutput(`[ç³»ç»Ÿ] æäº¤ ${selectedArray.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`);
            if (cleanedLabel) {
                appendOutput(`[ç³»ç»Ÿ] æµ‹è¯•æ ‡è®°: ${cleanedLabel}`);
            }
            appendOutput(`[ç³»ç»Ÿ] æœåŠ¡å™¨å¹¶å‘é™åˆ¶: ${serverMaxConcurrent} ä¸ª`);

            const startTime = Date.now();

            // ä½¿ç”¨ Promise.allSettled å¹¶è¡Œå‘èµ·æ‰€æœ‰è¯·æ±‚ï¼ˆå³ä½¿æœ‰å¤±è´¥ä¹Ÿä¸å½±å“å…¶ä»–ä»»åŠ¡ï¼‰
            const results = await Promise.allSettled(
                selectedArray.map(async (id, index) => {
                    const testCase = testCases.find(tc => tc.id == id);
                    const taskName = cleanedLabel ? `[${cleanedLabel}] ${testCase?.name}` : testCase?.name;
                    appendOutput(`[${index + 1}/${selectedArray.length}] æäº¤ä»»åŠ¡: ${taskName}`);
                    return runCase(id, cleanedLabel);
                })
            );

            // ç»Ÿè®¡ç»“æœ
            results.forEach((result, index) => {
                if (result.status === 'fulfilled') {
                    successCount++;
                } else {
                    failCount++;
                    const testCase = testCases.find(tc => tc.id == selectedArray[index]);
                    console.error(`ä»»åŠ¡ ${testCase?.name} æäº¤å¤±è´¥:`, result.reason);
                    appendOutput(`[é”™è¯¯] ${testCase?.name} æäº¤å¤±è´¥: ${result.reason}`);
                }
            });

            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            appendOutput(`[ç³»ç»Ÿ] æ‰¹é‡æäº¤å®Œæˆï¼Œè€—æ—¶ ${duration}ç§’`);
            appendOutput(`========== æ‰¹é‡å¹¶è¡Œæ‰§è¡Œç»“æŸ ==========\n`);

            // æ˜¾ç¤ºç»“æœ
            if (failCount === 0) {
                showToast(`âœ… å·²æˆåŠŸæäº¤ ${successCount} ä¸ªä»»åŠ¡ï¼Œæ­£åœ¨å¹¶è¡Œæ‰§è¡Œ`, 'success');
            } else {
                showToast(`âš ï¸ æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'warning');
            }

            // æ¸…ç©ºé€‰æ‹©
            selectedCases.clear();
            updateSelectionUI();
            renderCases();
        }

        // ä¿ç•™ runNextInQueue ç”¨äºå‘åå…¼å®¹ï¼ˆè™½ç„¶ä¸å†ä½¿ç”¨ï¼‰
        async function runNextInQueue() {
            console.warn('runNextInQueue å·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œæ¨¡å¼');
        }

        // åœæ­¢æµ‹è¯•
        async function stopTest() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showToast('æµ‹è¯•å·²åœæ­¢', 'success');
                    if (currentRunning) {
                        const testCase = testCases.find(tc => tc.id == currentRunning);
                        if (testCase) testCase.status = 'idle';
                        currentRunning = null;
                        renderCases();
                    }
                }
            } catch (error) {
                showToast('åœæ­¢å¤±è´¥', 'error');
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'running': 'è¿è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'error': 'å¤±è´¥',
                'failed': 'å¤±è´¥',
                'stopped': 'å·²åœæ­¢'
            };
            return statusMap[status] || status;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, runner) {
            if (status === 'completed' || status === 'error') {
                if (currentRunning) {
                    const testCase = testCases.find(tc => tc.id == currentRunning);
                    if (testCase) {
                        testCase.status = status;
                        if (status === 'completed') {
                            completedToday++;
                            saveCompletedToday();
                        }
                    }
                    currentRunning = null;
                    renderCases();

                    // ä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²å®Œæˆçš„ä»»åŠ¡
                    if (runningQueue.length > 0 && runningQueue[0] === testCase?.id) {
                        runningQueue.shift();
                        updateQueueDisplay();
                    }

                    // å¦‚æœæœ‰é˜Ÿåˆ—ï¼Œç»§ç»­è¿è¡Œä¸‹ä¸€ä¸ª
                    if (runningQueue.length > 0) {
                        setTimeout(() => runNextInQueue(), 2000);
                    }
                }
            }
        }


        // è¾“å‡ºæ—¥å¿—
        function appendOutput(text) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            output.textContent += `\n[${timestamp}] ${text}`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = 'ç­‰å¾…æµ‹è¯•è¿è¡Œ...';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('case-modal');
            console.log('âŒ closeModal - æ¸…é™¤å‰ editId:', modal.dataset.editId);
            modal.classList.remove('active');
            // æ¸…é™¤ç¼–è¾‘æ¨¡å¼æ ‡è®°ï¼Œé˜²æ­¢ä¸‹æ¬¡æ–°å¢æ—¶è¯¯åˆ¤ä¸ºç¼–è¾‘
            delete modal.dataset.editId;
            console.log('âŒ closeModal - æ¸…é™¤å editId:', modal.dataset.editId, 'hasEditId:', 'editId' in modal.dataset);
        }

        // ==================== Cookieè‡ªåŠ¨è·å–åŠŸèƒ½ ====================

        // æ˜¾ç¤ºCookieè‡ªåŠ¨è·å–å¼¹çª—
        function showAutoFetchCookieModal() {
            document.getElementById('cookie-fetch-modal').classList.add('active');
            // é‡ç½®è¡¨å•
            document.getElementById('cookie-uid').value = '';
            document.getElementById('cookie-env').value = 'prod';
            document.getElementById('cookie-format').value = 'string';
            document.getElementById('cookie-account-preset').value = '';
        }

        // å…³é—­Cookieè·å–å¼¹çª—
        function closeCookieFetchModal() {
            document.getElementById('cookie-fetch-modal').classList.remove('active');
        }

        // é€‰æ‹©é¢„è®¾è´¦å·
        function selectCookiePreset() {
            const preset = document.getElementById('cookie-account-preset').value;
            if (!preset) return;

            const [env, uid] = preset.split(':');
            document.getElementById('cookie-uid').value = uid;
            document.getElementById('cookie-env').value = env;
        }

        // è·å–å¹¶åº”ç”¨Cookie
        async function fetchAndApplyCookie() {
            const uidInput = document.getElementById('cookie-uid').value.trim();
            const env = document.getElementById('cookie-env').value;
            const format = document.getElementById('cookie-format').value;

            if (!uidInput) {
                showToast('è¯·è¾“å…¥UID', 'error');
                return;
            }

            // è½¬æ¢ä¸ºæ•°å­—ç±»å‹ï¼ˆåç«¯APIè¦æ±‚midå¿…é¡»æ˜¯æ•°å­—ï¼‰
            const uid = parseInt(uidInput, 10);
            if (isNaN(uid)) {
                showToast('UIDå¿…é¡»æ˜¯æ•°å­—', 'error');
                return;
            }

            try {
                showToast('æ­£åœ¨è·å–Cookie...', 'info');

                const response = await fetch('/api/cookie/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid, env })  // uidç°åœ¨æ˜¯æ•°å­—ç±»å‹
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || result.details || 'è·å–å¤±è´¥');
                }

                // æ ¹æ®é€‰æ‹©çš„æ ¼å¼å¡«å……Cookie
                const cookieTextarea = document.getElementById('testcase-cookie');
                if (format === 'json') {
                    cookieTextarea.value = JSON.stringify(result.cookieJson, null, 2);
                } else {
                    cookieTextarea.value = result.cookieString;
                }

                showToast(`âœ… Cookieè·å–æˆåŠŸ (UID: ${uid}, ç¯å¢ƒ: ${env === 'uat' ? 'UAT' : 'ç”Ÿäº§'})`, 'success');

                // è‡ªåŠ¨éªŒè¯è·å–çš„Cookie
                await validateCookie(result.cookieString);

                // æ˜¾ç¤ºè·å–çš„è¯¦ç»†ä¿¡æ¯
                console.log('[Cookie] è·å–æˆåŠŸ:', result);
                appendOutput(`[Cookie] è‡ªåŠ¨è·å–æˆåŠŸ - UID: ${uid}, ç¯å¢ƒ: ${env === 'uat' ? 'UAT' : 'ç”Ÿäº§ç¯å¢ƒ'}`);
            } catch (error) {
                console.error('[Cookie] è·å–å¤±è´¥:', error);
                showToast('è·å–Cookieå¤±è´¥: ' + error.message, 'error');
                appendOutput(`[Cookie] è·å–å¤±è´¥: ${error.message}`);
            }
        }

        // éªŒè¯å½“å‰Cookieï¼ˆä»æ–‡æœ¬æ¡†è¯»å–ï¼‰
        async function validateCurrentCookie() {
            const cookieTextarea = document.getElementById('testcase-cookie');
            const cookieValue = cookieTextarea.value.trim();

            if (!cookieValue) {
                showToast('è¯·å…ˆé…ç½®Cookie', 'error');
                return;
            }

            // å¦‚æœæ˜¯JSONæ ¼å¼ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            let cookieString = cookieValue;
            if (cookieValue.startsWith('{')) {
                try {
                    const cookieObj = JSON.parse(cookieValue);
                    cookieString = Object.entries(cookieObj)
                        .map(([key, value]) => `${key}=${value}`)
                        .join('; ');
                } catch (e) {
                    showToast('Cookieæ ¼å¼é”™è¯¯', 'error');
                    return;
                }
            }

            await validateCookie(cookieString);
        }

        // éªŒè¯Cookieï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        async function validateCookie(cookieString) {
            const resultDiv = document.getElementById('cookie-validation-result');
            const messageDiv = document.getElementById('cookie-validation-message');
            const detailsDiv = document.getElementById('cookie-validation-details');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#EDF2F7';
                resultDiv.style.border = '1px solid #CBD5E0';
                messageDiv.innerHTML = 'ğŸ”„ æ­£åœ¨éªŒè¯Cookie...';
                detailsDiv.innerHTML = '';

                const response = await fetch('/api/cookie/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cookieString })
                });

                const result = await response.json();

                // æ˜¾ç¤ºéªŒè¯ç»“æœ
                if (result.valid) {
                    resultDiv.style.background = '#C6F6D5';
                    resultDiv.style.border = '1px solid #48BB78';
                    messageDiv.innerHTML = `âœ… ${result.message}`;

                    if (result.userInfo) {
                        detailsDiv.innerHTML = `
                            <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong><br>
                            â€¢ UID: ${result.userInfo.mid}<br>
                            â€¢ ç”¨æˆ·å: ${result.userInfo.uname || 'æœªçŸ¥'}<br>
                            â€¢ VIPçŠ¶æ€: ${result.userInfo.vipStatus === 1 ? 'å¤§ä¼šå‘˜' : 'æ™®é€šç”¨æˆ·'}
                        `;
                    }

                    showToast('âœ… CookieéªŒè¯æˆåŠŸ', 'success');
                    appendOutput(`[Cookie] éªŒè¯æˆåŠŸ - UID: ${result.userInfo?.mid}, ç”¨æˆ·: ${result.userInfo?.uname}`);
                } else {
                    resultDiv.style.background = '#FED7D7';
                    resultDiv.style.border = '1px solid #FC8181';
                    messageDiv.innerHTML = `âŒ ${result.message}`;

                    detailsDiv.innerHTML = `
                        <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
                        â€¢ Cookieå·²è¿‡æœŸ<br>
                        â€¢ Cookieæ ¼å¼ä¸æ­£ç¡®<br>
                        â€¢ ç¼ºå°‘å¿…éœ€å­—æ®µ (SESSDATA, bili_jct)<br>
                        â€¢ ç½‘ç»œé—®é¢˜æˆ–æƒé™ä¸è¶³
                    `;

                    showToast('âŒ CookieéªŒè¯å¤±è´¥', 'error');
                    appendOutput(`[Cookie] éªŒè¯å¤±è´¥: ${result.message}`);
                }

                console.log('[Cookie] éªŒè¯ç»“æœ:', result);
            } catch (error) {
                console.error('[Cookie] éªŒè¯å¼‚å¸¸:', error);

                resultDiv.style.display = 'block';
                resultDiv.style.background = '#FED7D7';
                resultDiv.style.border = '1px solid #FC8181';
                messageDiv.innerHTML = 'âŒ éªŒè¯å¤±è´¥';
                detailsDiv.innerHTML = `é”™è¯¯: ${error.message}`;

                showToast('CookieéªŒè¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== åŸæœ‰åŠŸèƒ½ ====================

        // å¯¼å‡ºç”¨ä¾‹
        function exportCases() {
            const dataStr = JSON.stringify(testCases, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `test-cases-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showToast('ç”¨ä¾‹å·²å¯¼å‡º', 'success');
        }

        // å¯¼å…¥ç”¨ä¾‹
        function importCases() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            testCases = imported;
                            saveToStorage();
                            renderCases();
                            showToast(`æˆåŠŸå¯¼å…¥ ${imported.length} ä¸ªç”¨ä¾‹`, 'success');
                        } else {
                            throw new Error('æ ¼å¼é”™è¯¯');
                        }
                    } catch (error) {
                        showToast('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // åŠ è½½é¢„è®¾ç”¨ä¾‹
        function loadPresetCases() {
            const presets = [
                {
                    id: Date.now(),
                    name: 'ğŸ“Š ç¤ºä¾‹1: Bç«™é¦–é¡µ - åŸºç¡€æ€§èƒ½æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 1, iterations: 7 },
                        Runtime: { enabled: false },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 1,
                    description: 'æµ‹è¯•Bç«™é¦–é¡µçš„åˆå§‹åŒ–æ€§èƒ½ï¼ˆå†·å¯åŠ¨ï¼‰',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'åŸºç¡€'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {}
                },
                {
                    id: Date.now() + 1,
                    name: 'ğŸ¬ ç¤ºä¾‹2: Bç«™è§†é¢‘é¡µ - Runtimeæ€§èƒ½ç›‘æ§',
                    runners: {
                        Initialization: { enabled: false },
                        Runtime: { enabled: true, repeatCount: 1, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com/video/BV1xx411c7mD'],
                    mode: 'headless',
                    repeatCount: 1,
                    description: 'ç›‘æ§è§†é¢‘é¡µ30ç§’è¿è¡Œæ—¶æ€§èƒ½ï¼Œæµ‹è¯•FPSå’Œé•¿ä»»åŠ¡',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'runtime'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        hooks: {
                            onPageLoaded: 'console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§...");',
                            onPageTesting: '// ç‚¹å‡»æ’­æ”¾æŒ‰é’®\nawait page.click(".bpx-player-ctrl-btn");'
                        }
                    }
                },
                {
                    id: Date.now() + 2,
                    name: 'ğŸ§  ç¤ºä¾‹3: å†…å­˜æ³„æ¼æ£€æµ‹ - è§†é¢‘åˆ‡æ¢',
                    runners: {
                        Initialization: { enabled: false },
                        Runtime: { enabled: false },
                        MemoryLeak: { enabled: true, repeatCount: 1, intervalMs: 30000, iterations: 3, onPageTesting: '// æ¨¡æ‹Ÿè§†é¢‘åˆ‡æ¢æ“ä½œ\nawait page.evaluate(() => {\n  // è§¦å‘å¯èƒ½çš„å†…å­˜æ³„æ¼æ“ä½œ\n  window.scrollTo(0, document.body.scrollHeight);\n});' }
                    },
                    urls: ['https://www.bilibili.com/video/BV1xx411c7mD'],
                    mode: 'headless',
                    repeatCount: 1,
                    description: 'æ£€æµ‹è§†é¢‘é¡µé¢çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œé‡å¤æ‰§è¡Œé¡µé¢æ“ä½œ',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'å†…å­˜æ³„æ¼'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {}
                },
                {
                    id: Date.now() + 3,
                    name: 'ğŸš€ ç¤ºä¾‹4: å¤šé¡µé¢å¯¹æ¯”æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 1, iterations: 5 },
                        Runtime: { enabled: true, repeatCount: 1, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: [
                        'https://www.bilibili.com',
                        'https://www.bilibili.com/video/BV1xx411c7mD',
                        'https://t.bilibili.com',
                        'https://space.bilibili.com'
                    ],
                    mode: 'headless',
                    repeatCount: 1,
                    description: 'å¯¹æ¯”æµ‹è¯•Bç«™ä¸åŒé¡µé¢çš„æ€§èƒ½è¡¨ç°',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'å¤šé¡µé¢'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {}
                },
                {
                    id: Date.now() + 4,
                    name: 'ğŸ“± ç¤ºä¾‹5: ç§»åŠ¨ç«¯æ¨¡æ‹Ÿ - æ€§èƒ½æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 1, iterations: 5 },
                        Runtime: { enabled: true, repeatCount: 1, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://m.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 1,
                    description: 'æ¨¡æ‹Ÿç§»åŠ¨è®¾å¤‡æµ‹è¯•Bç«™ç§»åŠ¨ç«¯æ€§èƒ½',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'ç§»åŠ¨ç«¯'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        deviceOptions: ['Mobile', { preset: 'android' }]
                    }
                },
                {
                    id: Date.now() + 5,
                    name: 'ğŸš« ç¤ºä¾‹6: é˜»æ­¢èµ„æºåŠ è½½ - ä¼˜åŒ–æµ‹è¯•',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 1, iterations: 5 },
                        Runtime: { enabled: false },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 1,
                    description: 'é˜»æ­¢å›¾ç‰‡å’Œå­—ä½“åŠ è½½ï¼Œæµ‹è¯•æ ¸å¿ƒé¡µé¢æ€§èƒ½',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'èµ„æºä¼˜åŒ–'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        blockList: ['*.jpg', '*.png', '*.webp', '*.woff', '*.woff2'],
                        hooks: {
                            beforePageLoad: 'console.log("å·²é˜»æ­¢å›¾ç‰‡å’Œå­—ä½“åŠ è½½");'
                        }
                    }
                },
                {
                    id: Date.now() + 6,
                    name: 'ğŸ¨ ç¤ºä¾‹7: è‡ªå®šä¹‰CSS - éšè—å¹¿å‘Š',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 3, iterations: 5 },
                        Runtime: { enabled: true, repeatCount: 3, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: false }
                    },
                    urls: ['https://www.bilibili.com'],
                    mode: 'headless',
                    repeatCount: 3,
                    description: 'æ³¨å…¥è‡ªå®šä¹‰CSSéšè—å¹¿å‘Šå…ƒç´ ï¼Œæµ‹è¯•æ€§èƒ½å½±å“',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'css'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        customCss: '.ad-report, .bili-banner, [class*="ad-"] { display: none !important; }'
                    }
                },
                {
                    id: Date.now() + 7,
                    name: 'ğŸ”„ ç¤ºä¾‹8: å…¨é¢æµ‹è¯• - æ‰€æœ‰Runner',
                    runners: {
                        Initialization: { enabled: true, repeatCount: 2, iterations: 5, includeWarmNavigation: false },
                        Runtime: { enabled: true, repeatCount: 2, durationMs: 30000, delayMs: 5000 },
                        MemoryLeak: { enabled: true, repeatCount: 2, intervalMs: 30000, iterations: 2, onPageTesting: 'await page.evaluate(() => window.scrollTo(0, 500));' }
                    },
                    urls: ['https://www.bilibili.com/video/BV1xx411c7mD'],
                    mode: 'headless',
                    repeatCount: 2,
                    description: 'å¯¹è§†é¢‘é¡µæ‰§è¡Œå…¨é¢æ€§èƒ½æµ‹è¯•ï¼šåˆå§‹åŒ–ã€è¿è¡Œæ—¶ã€å†…å­˜æ³„æ¼',
                    tags: ['ç¤ºä¾‹', 'bilibili', 'å…¨é¢æµ‹è¯•'],
                    executionHistory: [],
                    createdAt: new Date().toISOString(),
                    advancedConfig: {
                        delayMs: 5000,
                        hooks: {
                            onPageLoaded: 'console.log("é¡µé¢åŠ è½½å®Œæˆ");',
                            onPageTesting: 'console.log("å¼€å§‹æ€§èƒ½æµ‹è¯•");',
                            onPageUnload: 'console.log("æµ‹è¯•å®Œæˆï¼Œæ¸…ç†é¡µé¢");'
                        }
                    }
                }
            ];

            testCases = [...testCases, ...presets];
            saveToStorage();
            renderCases();
            showToast(`âœ… å·²åŠ è½½ ${presets.length} ä¸ªå®æˆ˜ç¤ºä¾‹ï¼åŒ…å«åŸºç¡€æµ‹è¯•ã€é«˜çº§é…ç½®ã€ç”Ÿå‘½å‘¨æœŸé’©å­ç­‰åŠŸèƒ½æ¼”ç¤º`, 'success');
        }

        // ==================== åç«¯åŒæ­¥åŠŸèƒ½ ====================

        // ä»åç«¯åŠ è½½æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
        async function loadTestCasesFromBackend() {
            try {
                const response = await fetch('/api/testcases');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                return data.testCases || [];
            } catch (error) {
                console.error('[åç«¯åŒæ­¥] åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                showToast('ä»æœåŠ¡å™¨åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜', 'warning');
                return null;
            }
        }

        // ä¿å­˜æµ‹è¯•ç”¨ä¾‹åˆ°åç«¯
        async function saveTestCaseToBackend(testCase) {
            try {
                const url = testCase.id && testCase.id.startsWith('testcase_')
                    ? `/api/testcases/${testCase.id}`
                    : '/api/testcases';

                const method = testCase.id && testCase.id.startsWith('testcase_') ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testCase)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.testCase;
            } catch (error) {
                console.error('[åç«¯åŒæ­¥] ä¿å­˜æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                showToast('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°', 'warning');
                return null;
            }
        }

        // ä»åç«¯åˆ é™¤æµ‹è¯•ç”¨ä¾‹
        async function deleteTestCaseFromBackend(testCaseId) {
            if (!testCaseId || !testCaseId.startsWith('testcase_')) {
                return; // æ—§æ ¼å¼çš„IDä¸éœ€è¦ä»åç«¯åˆ é™¤
            }

            try {
                const response = await fetch(`/api/testcases/${testCaseId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('[åç«¯åŒæ­¥] åˆ é™¤æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
            }
        }

        // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°åç«¯ï¼ˆé¦–æ¬¡è¿ç§»ï¼‰
        async function migrateLocalToBackend() {
            const localCases = JSON.parse(localStorage.getItem('testCases') || '[]');
            if (localCases.length === 0) return;

            // æ£€æŸ¥æ˜¯å¦å·²è¿ç§»
            const migrated = localStorage.getItem('migrated_to_backend');
            if (migrated === 'true') return;

            console.log(`[æ•°æ®è¿ç§»] å¼€å§‹è¿ç§» ${localCases.length} ä¸ªæœ¬åœ°æµ‹è¯•ç”¨ä¾‹åˆ°åç«¯...`);

            let successCount = 0;
            for (const testCase of localCases) {
                // å¦‚æœæ˜¯æ—§IDæ ¼å¼ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œé‡æ–°ç”Ÿæˆä¸ºåç«¯æ ¼å¼
                if (!testCase.id || !testCase.id.startsWith('testcase_')) {
                    delete testCase.id; // è®©åç«¯ç”Ÿæˆæ–°ID
                }

                const saved = await saveTestCaseToBackend(testCase);
                if (saved) {
                    successCount++;
                }
            }

            console.log(`[æ•°æ®è¿ç§»] è¿ç§»å®Œæˆ: ${successCount}/${localCases.length} ä¸ªç”¨ä¾‹å·²ä¿å­˜åˆ°åç«¯`);
            localStorage.setItem('migrated_to_backend', 'true');
            showToast(`âœ… å·²å°† ${successCount} ä¸ªæœ¬åœ°ç”¨ä¾‹åŒæ­¥åˆ°æœåŠ¡å™¨`, 'success');
        }

        // å·¥å…·å‡½æ•°
        function saveToStorage() {
            localStorage.setItem('testCases', JSON.stringify(testCases));
        }

        function saveCompletedToday() {
            localStorage.setItem('completedToday', completedToday.toString());
            localStorage.setItem('completedDate', new Date().toDateString());
            updateStats();
        }

        function loadCompletedToday() {
            const savedDate = localStorage.getItem('completedDate');
            const today = new Date().toDateString();

            if (savedDate === today) {
                completedToday = parseInt(localStorage.getItem('completedToday') || '0');
            } else {
                completedToday = 0;
                localStorage.setItem('completedDate', today);
                localStorage.setItem('completedToday', '0');
            }
            updateStats();
        }

        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ - å·²ç¦ç”¨ï¼Œé˜²æ­¢è¯¯æ“ä½œå¯¼è‡´ç¼–è¾‘å†…å®¹ä¸¢å¤±
        // ç”¨æˆ·å¿…é¡»ç‚¹å‡»"å–æ¶ˆ"æˆ–"ä¿å­˜"æŒ‰é’®æ¥å…³é—­æ¨¡æ€æ¡†
        // document.getElementById('case-modal').addEventListener('click', (e) => {
        //     if (e.target.classList.contains('modal')) {
        //         closeModal();
        //     }
        // });

        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + N: æ–°å»ºç”¨ä¾‹
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showAddCaseModal();
            }

            // Esc: å…³é—­æ¨¡æ€æ¡† - å·²ç¦ç”¨ï¼Œé˜²æ­¢è¯¯æ“ä½œå¯¼è‡´ç¼–è¾‘å†…å®¹ä¸¢å¤±
            // ç”¨æˆ·å¿…é¡»ç‚¹å‡»"å–æ¶ˆ"æˆ–"ä¿å­˜"æŒ‰é’®æ¥å…³é—­æ¨¡æ€æ¡†
            // if (e.key === 'Escape') {
            //     closeModal();
            // }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = () => {
            if (ws) ws.close();
            if (reconnectTimer) clearTimeout(reconnectTimer);
        };

        // ==================== å…¨å±€é…ç½®ç®¡ç† ====================

        // æ˜¾ç¤ºå…¨å±€è®¾ç½®æ¨¡æ€æ¡†
        function showGlobalConfigModal() {
            document.getElementById('global-config-modal').classList.add('active');
            loadGlobalConfig(); // åŠ è½½å½“å‰é…ç½®
        }

        // å…³é—­å…¨å±€è®¾ç½®æ¨¡æ€æ¡†
        function closeGlobalConfigModal() {
            document.getElementById('global-config-modal').classList.remove('active');
        }

        // ä¿å­˜å…¨å±€é…ç½®
        async function saveGlobalConfig() {
            try {
                // å…ˆè·å–å½“å‰å®Œæ•´é…ç½®
                const currentResponse = await fetch('/api/dynamic-config');
                const currentConfig = await currentResponse.json();

                // åªæ›´æ–°çœŸæ­£çš„å…¨å±€é…ç½®
                currentConfig.port = document.getElementById('global-port').value.trim() ? parseInt(document.getElementById('global-port').value) : null;
                currentConfig.executablePath = document.getElementById('global-executable-path').value.trim();

                // ä¿å­˜å®Œæ•´é…ç½®
                const response = await fetch('/api/dynamic-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentConfig)
                });

                const data = await response.json();
                if (data.success) {
                    showToast('å…¨å±€é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    closeGlobalConfigModal(); // ä¿å­˜æˆåŠŸåå…³é—­æ¨¡æ€æ¡†
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å…¨å±€é…ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½å…¨å±€é…ç½®
        async function loadGlobalConfig() {
            try {
                const response = await fetch('/api/dynamic-config');
                const config = await response.json();

                // æ¢å¤å…¨å±€é…ç½®
                document.getElementById('global-port').value = config.port || '';
                document.getElementById('global-executable-path').value = config.executablePath || '';
            } catch (error) {
                console.error('åŠ è½½å…¨å±€é…ç½®å¤±è´¥:', error);
            }
        }
    </script>

    <!-- Worker èŠ‚ç‚¹é€‰æ‹©å™¨è„šæœ¬ -->
    <script src="worker-selector.js"></script>

    <!-- æ‰¹é‡åˆ†å‘ç»„ä»¶è„šæœ¬ -->
    <script src="batch-dispatcher.js"></script>
    <script>
        // åˆå§‹åŒ–æ‰¹é‡åˆ†å‘ç»„ä»¶
        let batchDispatcher = null;

        // åœ¨é¡µé¢åŠ è½½åå»¶è¿Ÿåˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                batchDispatcher = new BatchDispatcher();
                batchDispatcher.init();
                console.log('[BatchDispatcher] âœ… æ‰¹é‡åˆ†å‘åŠŸèƒ½å·²å¯ç”¨');
            }, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿DOMå·²å®Œå…¨åŠ è½½
        });
    </script>

    <!-- å¯¼èˆªæ äº¤äº’è„šæœ¬ -->
    <script>
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const toggle = document.getElementById('navbar-toggle');
            const menu = document.getElementById('navbar-menu');
            if (toggle && menu) {
                toggle.classList.toggle('active');
                menu.classList.toggle('show');
            }
        }

        // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('main-navbar');
            if (navbar) {
                if (window.scrollY > 20) {
                    navbar.classList.add('navbar-scrolled');
                } else {
                    navbar.classList.remove('navbar-scrolled');
                }
            }
        });
    </script>
    <!-- UIå·¥å…·åº“ -->
    <script src="/js/ui-utils.js"></script>
</body>
</html>
