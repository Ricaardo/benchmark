<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Web Runner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        .status-idle {
            background: #e0e0e0;
            color: #666;
        }

        .status-running {
            background: #ffd54f;
            color: #f57c00;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background: #81c784;
            color: #2e7d32;
        }

        .status-error {
            background: #e57373;
            color: #c62828;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e57373;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ef5350;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 115, 115, 0.4);
        }

        .btn-secondary {
            background: #90a4ae;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #78909c;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .output-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
        }

        .config-editor {
            width: 100%;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
            resize: vertical;
        }

        .config-editor:focus {
            outline: none;
            border-color: #667eea;
        }

        .reports-list {
            list-style: none;
        }

        .reports-list li {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reports-list li:last-child {
            border-bottom: none;
        }

        .reports-list a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .reports-list a:hover {
            text-decoration: underline;
        }

        .report-date {
            color: #999;
            font-size: 0.85em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .test-case-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .test-case-item input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .test-case-item label {
            display: block;
            margin-top: 8px;
            color: #555;
            font-weight: 500;
            font-size: 0.9em;
        }

        .test-case-item button {
            margin-top: 8px;
            padding: 6px 12px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Benchmark Web Runner</h1>
            <p>Bilibili Player Performance Testing</p>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/" style="padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 6px; font-weight: 600; margin: 0 5px; display: inline-block;">ğŸ  æ§åˆ¶å°</a>
            <a href="/config.html" style="padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 6px; font-weight: 600; margin: 0 5px; display: inline-block;">âš™ï¸ é…ç½®ç®¡ç†</a>
        </div>

        <div class="card">
            <h2>æ§åˆ¶é¢æ¿</h2>
            <div style="margin-bottom: 15px;">
                <strong>å½“å‰çŠ¶æ€:</strong>
                <span id="status-badge" class="status-badge status-idle">IDLE</span>
                <span id="current-runner" style="margin-left: 10px; color: #666;"></span>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>é€‰æ‹©æµ‹è¯•æ¨¡å¼:</strong>
                <select id="runner-select" style="margin-left: 10px; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em; background: white;">
                    <option value="Initialization">Initialization - åˆå§‹åŒ–æ€§èƒ½æµ‹è¯•</option>
                    <option value="Runtime" selected>Runtime - è¿è¡Œæ—¶æ€§èƒ½æµ‹è¯•</option>
                    <option value="MemoryLeak">MemoryLeak - å†…å­˜æ³„æ¼æµ‹è¯•</option>
                </select>
            </div>
            <div class="button-group">
                <button id="start-btn" class="btn-primary" onclick="startBenchmark()">
                    â–¶ï¸ å¯åŠ¨æµ‹è¯•
                </button>
                <button id="stop-btn" class="btn-danger" onclick="stopBenchmark()" disabled>
                    â¹ï¸ åœæ­¢æµ‹è¯•
                </button>
                <button class="btn-secondary" onclick="refreshStatus()">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 6px; font-size: 0.9em;">
                <strong>æµ‹è¯•æ¨¡å¼è¯´æ˜:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li><strong>Initialization:</strong> æµ‹è¯•é¡µé¢åˆå§‹åŒ–åŠ è½½æ€§èƒ½</li>
                    <li><strong>Runtime:</strong> æµ‹è¯•é¡µé¢è¿è¡Œæ—¶é•¿æ—¶é—´æ€§èƒ½è¡¨ç°</li>
                    <li><strong>MemoryLeak:</strong> æ£€æµ‹é¡µé¢å†…å­˜æ³„æ¼é—®é¢˜</li>
                </ul>
            </div>
        </div>

        <div class="card" style="border: 2px solid #667eea;">
            <h2 style="color: #667eea;">âš™ï¸ å¿«é€Ÿé…ç½®</h2>

            <!-- Initialization é…ç½® -->
            <div id="init-quick-config" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px; color: #333;">ğŸš€ Initialization é…ç½®</h3>
                <div id="init-test-cases-quick"></div>
                <button class="btn-secondary" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em;" onclick="addQuickTestCase('Initialization')">â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹</button>
            </div>

            <!-- Runtime é…ç½® -->
            <div id="runtime-quick-config" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px; color: #333;">â±ï¸ Runtime é…ç½®</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">è¿è¡Œæ—¶é•¿ (æ¯«ç§’)</label>
                        <input type="number" id="runtime-duration-quick" value="60000" step="1000" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">å»¶è¿Ÿæ—¶é—´ (æ¯«ç§’)</label>
                        <input type="number" id="runtime-delay-quick" value="10000" step="1000" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                </div>
                <div id="runtime-test-cases-quick"></div>
                <button class="btn-secondary" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em;" onclick="addQuickTestCase('Runtime')">â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹</button>
            </div>

            <!-- MemoryLeak é…ç½® -->
            <div id="memory-quick-config" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin-bottom: 10px; color: #333;">ğŸ” MemoryLeak é…ç½®</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">è¿­ä»£é—´éš” (æ¯«ç§’)</label>
                        <input type="number" id="memory-interval-quick" value="60000" step="1000" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">è¿­ä»£æ¬¡æ•°</label>
                        <input type="number" id="memory-iterations-quick" value="3" min="2" max="10" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                </div>
                <div id="memory-test-cases-quick"></div>
                <button class="btn-secondary" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em;" onclick="addQuickTestCase('MemoryLeak')">â• æ·»åŠ æµ‹è¯•ç”¨ä¾‹</button>
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" onclick="saveQuickConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button class="btn-secondary" onclick="loadQuickConfig()">ğŸ”„ é‡æ–°åŠ è½½</button>
            </div>

            <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #667eea; border-radius: 4px;">
                <strong style="color: #1565c0;">ğŸ’¡ æç¤ºï¼š</strong>
                <span style="color: #1565c0;">åœ¨è¿™é‡Œå¿«é€Ÿé…ç½®ï¼Œæˆ–å‰å¾€ <a href="/config.html" style="color: #1565c0; font-weight: 600;">é…ç½®ç®¡ç†é¡µé¢</a> è¿›è¡Œé«˜çº§é…ç½®ã€‚</span>
            </div>
        </div>

        <div class="card">
            <h2>å®æ—¶è¾“å‡º</h2>
            <div id="output" class="output-box">ç­‰å¾…å¯åŠ¨æµ‹è¯•...</div>
        </div>

        <div class="card">
            <h2>æµ‹è¯•æŠ¥å‘Š</h2>
            <div id="reports" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let statusInterval;
        let currentConfig = null;

        // å¯åŠ¨æµ‹è¯•
        async function startBenchmark() {
            try {
                const runner = document.getElementById('runner-select').value;
                const response = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ runner })
                });
                const data = await response.json();
                if (data.success) {
                    startStatusPolling();
                } else {
                    alert(data.error || 'å¯åŠ¨å¤±è´¥');
                }
            } catch (error) {
                alert('å¯åŠ¨æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // åœæ­¢æµ‹è¯•
        async function stopBenchmark() {
            try {
                const response = await fetch(`${API_BASE}/stop`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    stopStatusPolling();
                    await refreshStatus();
                } else {
                    alert(data.error || 'åœæ­¢å¤±è´¥');
                }
            } catch (error) {
                alert('åœæ­¢æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ›´æ–°UI
        function updateUI(data) {
            const badge = document.getElementById('status-badge');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const output = document.getElementById('output');
            const runnerSelect = document.getElementById('runner-select');
            const currentRunner = document.getElementById('current-runner');

            badge.className = `status-badge status-${data.status}`;
            badge.textContent = data.status.toUpperCase();

            startBtn.disabled = data.status === 'running';
            stopBtn.disabled = data.status !== 'running';
            runnerSelect.disabled = data.status === 'running';

            if (data.currentRunner) {
                currentRunner.textContent = `(${data.currentRunner})`;
            } else {
                currentRunner.textContent = '';
            }

            output.textContent = data.output || 'æš‚æ— è¾“å‡º...';
            output.scrollTop = output.scrollHeight;
        }

        // å¼€å§‹è½®è¯¢çŠ¶æ€
        function startStatusPolling() {
            if (!statusInterval) {
                statusInterval = setInterval(refreshStatus, 1000);
            }
        }

        // åœæ­¢è½®è¯¢çŠ¶æ€
        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
        async function loadReports() {
            try {
                const response = await fetch(`${API_BASE}/reports`);
                const reports = await response.json();
                const reportsDiv = document.getElementById('reports');

                if (reports.length === 0) {
                    reportsDiv.innerHTML = '<p class="loading">æš‚æ— æµ‹è¯•æŠ¥å‘Š</p>';
                    return;
                }

                const list = document.createElement('ul');
                list.className = 'reports-list';

                reports.forEach(report => {
                    const li = document.createElement('li');
                    const date = new Date(report.modified).toLocaleString('zh-CN');
                    li.innerHTML = `
                        <a href="${report.path}" target="_blank">${report.name}</a>
                        <span class="report-date">${date}</span>
                    `;
                    list.appendChild(li);
                });

                reportsDiv.innerHTML = '';
                reportsDiv.appendChild(list);
            } catch (error) {
                document.getElementById('reports').innerHTML =
                    '<p class="loading">åŠ è½½æŠ¥å‘Šå¤±è´¥</p>';
            }
        }

        // ç›‘å¬ runner é€‰æ‹©å˜åŒ–ï¼Œæ˜¾ç¤ºå¯¹åº”çš„å¿«é€Ÿé…ç½®
        document.addEventListener('DOMContentLoaded', () => {
            const runnerSelect = document.getElementById('runner-select');
            runnerSelect.addEventListener('change', updateQuickConfigVisibility);
            updateQuickConfigVisibility(); // åˆå§‹åŒ–æ˜¾ç¤º
        });

        function updateQuickConfigVisibility() {
            const runner = document.getElementById('runner-select').value;

            // éšè—æ‰€æœ‰é…ç½®
            document.getElementById('init-quick-config').style.display = 'none';
            document.getElementById('runtime-quick-config').style.display = 'none';
            document.getElementById('memory-quick-config').style.display = 'none';

            // æ˜¾ç¤ºé€‰ä¸­çš„é…ç½®
            if (runner === 'Initialization') {
                document.getElementById('init-quick-config').style.display = 'block';
            } else if (runner === 'Runtime') {
                document.getElementById('runtime-quick-config').style.display = 'block';
            } else if (runner === 'MemoryLeak') {
                document.getElementById('memory-quick-config').style.display = 'block';
            }
        }

        // åŠ è½½å¿«é€Ÿé…ç½®
        async function loadQuickConfig() {
            try {
                const response = await fetch(`${API_BASE}/dynamic-config`);
                currentConfig = await response.json();

                // æ¸²æŸ“ Initialization é…ç½®
                renderQuickTestCases('Initialization', currentConfig.runners.Initialization.testCases || []);

                // æ¸²æŸ“ Runtime é…ç½®
                document.getElementById('runtime-duration-quick').value = currentConfig.runners.Runtime.durationMs || 60000;
                document.getElementById('runtime-delay-quick').value = currentConfig.runners.Runtime.delayMs || 10000;
                renderQuickTestCases('Runtime', currentConfig.runners.Runtime.testCases || []);

                // æ¸²æŸ“ MemoryLeak é…ç½®
                document.getElementById('memory-interval-quick').value = currentConfig.runners.MemoryLeak.intervalMs || 60000;
                document.getElementById('memory-iterations-quick').value = currentConfig.runners.MemoryLeak.iterations || 3;
                renderQuickTestCases('MemoryLeak', currentConfig.runners.MemoryLeak.testCases || []);

            } catch (error) {
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨
        function renderQuickTestCases(runner, testCases) {
            const containerId = runner === 'Initialization' ? 'init-test-cases-quick' :
                               runner === 'Runtime' ? 'runtime-test-cases-quick' :
                               'memory-test-cases-quick';

            const container = document.getElementById(containerId);
            container.innerHTML = '';

            testCases.forEach((tc, index) => {
                const div = document.createElement('div');
                div.className = 'test-case-item';
                div.innerHTML = `
                    <label>æµ‹è¯• URL</label>
                    <input type="text" value="${tc.target || ''}" data-runner="${runner}" data-index="${index}" data-field="target">
                    <label>æè¿°</label>
                    <input type="text" value="${tc.description || ''}" data-runner="${runner}" data-index="${index}" data-field="description">
                    <button class="btn-danger" onclick="removeQuickTestCase('${runner}', ${index})">ğŸ—‘ï¸ åˆ é™¤</button>
                `;
                container.appendChild(div);
            });
        }

        // æ·»åŠ æµ‹è¯•ç”¨ä¾‹
        function addQuickTestCase(runner) {
            if (!currentConfig) return;

            const runnerKey = runner;
            if (!currentConfig.runners[runnerKey].testCases) {
                currentConfig.runners[runnerKey].testCases = [];
            }

            currentConfig.runners[runnerKey].testCases.push({
                target: '',
                description: ''
            });

            renderQuickTestCases(runner, currentConfig.runners[runnerKey].testCases);
        }

        // åˆ é™¤æµ‹è¯•ç”¨ä¾‹
        function removeQuickTestCase(runner, index) {
            if (!currentConfig) return;

            currentConfig.runners[runner].testCases.splice(index, 1);
            renderQuickTestCases(runner, currentConfig.runners[runner].testCases);
        }

        // ä¿å­˜å¿«é€Ÿé…ç½®
        async function saveQuickConfig() {
            if (!currentConfig) {
                alert('è¯·å…ˆåŠ è½½é…ç½®');
                return;
            }

            try {
                // æ”¶é›†è¡¨å•ä¸­çš„ä¿®æ”¹
                const inputs = document.querySelectorAll('.test-case-item input[data-runner]');
                inputs.forEach(input => {
                    const runner = input.dataset.runner;
                    const index = parseInt(input.dataset.index);
                    const field = input.dataset.field;

                    if (currentConfig.runners[runner].testCases[index]) {
                        currentConfig.runners[runner].testCases[index][field] = input.value;
                    }
                });

                // æ”¶é›† Runtime å‚æ•°
                currentConfig.runners.Runtime.durationMs = parseInt(document.getElementById('runtime-duration-quick').value);
                currentConfig.runners.Runtime.delayMs = parseInt(document.getElementById('runtime-delay-quick').value);

                // æ”¶é›† MemoryLeak å‚æ•°
                currentConfig.runners.MemoryLeak.intervalMs = parseInt(document.getElementById('memory-interval-quick').value);
                currentConfig.runners.MemoryLeak.iterations = parseInt(document.getElementById('memory-iterations-quick').value);

                // å‘é€åˆ°åç«¯
                const response = await fetch(`${API_BASE}/dynamic-config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentConfig)
                });

                const data = await response.json();
                if (data.success) {
                    alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async () => {
            await refreshStatus();
            await loadReports();
            await loadQuickConfig();
        };
    </script>
</body>
</html>
