# Cookie验证功能使用指南

## 🔍 功能简介

Cookie验证功能可以帮助你快速检查配置的Cookie是否有效，避免因Cookie失效导致测试失败。

## 🎯 使用场景

### 1. **Cookie获取后自动验证**
自动获取Cookie后，系统会自动验证Cookie的有效性，确保立即可用。

### 2. **手动配置Cookie验证**
手动复制粘贴Cookie后，可以点击"🔍 验证Cookie"按钮检查是否有效。

### 3. **测试失败时诊断**
测试运行失败时，使用Cookie验证功能快速定位是否是Cookie问题。

## 📝 使用方法

### 方法1：自动获取Cookie时的自动验证

```
1. 点击 "🔄 自动获取" 按钮
2. 选择账号和环境
3. 点击 "获取并应用"
4. ✅ Cookie自动填充并验证
```

**验证结果会直接显示在弹窗中：**

**成功示例：**
```
┌────────────────────────────────────────┐
│ ✅ Cookie有效，已登录                   │
│                                        │
│ 用户信息：                              │
│ • UID: 110000233                       │
│ • 用户名: 测试账号                      │
│ • VIP状态: 普通用户                     │
└────────────────────────────────────────┘
```

**失败示例：**
```
┌────────────────────────────────────────┐
│ ❌ Cookie无效或已过期                   │
│                                        │
│ 可能的原因：                            │
│ • Cookie已过期                          │
│ • Cookie格式不正确                      │
│ • 缺少必需字段 (SESSDATA, bili_jct)    │
│ • 网络问题或权限不足                     │
└────────────────────────────────────────┘
```

### 方法2：手动验证已配置的Cookie

```
1. 配置好Cookie（自动获取或手动粘贴）
2. 点击 "🔍 验证Cookie" 按钮
3. 查看验证结果
```

## 🔧 技术实现

### 后端API

#### Cookie验证接口

```http
POST /api/cookie/validate
Content-Type: application/json

{
  "cookieString": "SESSDATA=xxx; bili_jct=yyy; DedeUserID=zzz"
}
```

**响应示例（成功）：**
```json
{
  "valid": true,
  "message": "Cookie有效，已登录",
  "userInfo": {
    "mid": 110000233,
    "uname": "测试账号",
    "vipStatus": 0
  }
}
```

**响应示例（失败）：**
```json
{
  "valid": false,
  "message": "Cookie无效或已过期",
  "userInfo": null
}
```

### 验证逻辑

1. **Cookie格式解析**
   - 字符串格式: `SESSDATA=xxx; bili_jct=yyy`
   - JSON格式: `{"SESSDATA": "xxx", "bili_jct": "yyy"}`

2. **必需字段检查**
   - `SESSDATA` - 会话令牌（必需）
   - `bili_jct` - CSRF令牌（必需）

3. **API验证**
   - 调用 Bilibili Nav API: `https://api.bilibili.com/x/web-interface/nav`
   - 检查登录状态和用户信息

4. **返回结果**
   - 验证成功：显示用户信息
   - 验证失败：显示失败原因

## 💡 验证流程图

```
┌─────────────────────┐
│  用户点击验证按钮    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  读取Cookie文本框    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  格式转换（JSON→字符串）│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  解析Cookie字段      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  检查必需字段        │
│  (SESSDATA/bili_jct) │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  调用Bilibili Nav API│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  解析API响应         │
│  检查code和isLogin   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  显示验证结果        │
│  • 成功：用户信息     │
│  • 失败：错误原因     │
└─────────────────────┘
```

## 📊 实际应用示例

### 示例1：自动获取后验证

```javascript
// 用户操作
1. 点击 "🔄 自动获取"
2. 选择 "UAT测试账号 (110000233)"
3. 点击 "获取并应用"

// 系统自动执行
→ 调用 /api/cookie/fetch
→ Cookie填充到文本框
→ 自动调用 /api/cookie/validate
→ 显示验证结果

// 控制台输出
[Cookie] 自动获取成功 - UID: 110000233, 环境: UAT环境
[Cookie] 验证成功 - UID: 110000233, 用户: 测试账号
```

### 示例2：手动配置后验证

```javascript
// 用户操作
1. 手动粘贴Cookie到文本框
   SESSDATA=xxx; bili_jct=yyy; DedeUserID=110000233
2. 点击 "🔍 验证Cookie"

// 系统执行
→ 读取文本框内容
→ 调用 /api/cookie/validate
→ 显示验证结果

// 成功情况
✅ Cookie有效，已登录
用户信息：
• UID: 110000233
• 用户名: 测试账号
• VIP状态: 普通用户
```

### 示例3：测试失败后诊断

```javascript
// 问题场景
测试运行后报错: 退出码 1

// 诊断步骤
1. 打开测试用例编辑
2. 点击 "🔍 验证Cookie"
3. 查看验证结果

// 发现问题
❌ Cookie无效或已过期

// 解决方案
1. 点击 "🔄 自动获取"
2. 重新获取新的Cookie
3. 再次验证
4. ✅ 验证成功后重新运行测试
```

## ⚠️ 注意事项

### 1. **Cookie格式支持**
验证功能支持两种格式：
- 字符串格式: `SESSDATA=xxx; bili_jct=yyy`
- JSON格式: `{"SESSDATA": "xxx", "bili_jct": "yyy"}`

如果是JSON格式，会自动转换为字符串后验证。

### 2. **网络要求**
Cookie验证需要能够访问 `api.bilibili.com`，确保网络连接正常。

### 3. **必需字段**
Cookie必须包含以下字段才能验证成功：
- `SESSDATA` - 会话令牌
- `bili_jct` - CSRF令牌

### 4. **Cookie有效期**
- Cookie有时效性，过期后需要重新获取
- 验证失败时，使用自动获取功能重新获取新Cookie

### 5. **环境区分**
- UAT环境Cookie只能在UAT环境使用
- 生产环境Cookie只能在生产环境使用
- 跨环境使用会导致验证失败

## 🐛 常见问题

### Q1: 为什么自动获取的Cookie验证失败？

**A:** 可能的原因：
1. **网络问题**：无法访问 `api.bilibili.com`
2. **Cookie立即过期**：获取的Cookie已经失效
3. **权限问题**：UID没有访问权限

**解决方法：**
- 检查网络连接
- 重新获取Cookie
- 尝试使用其他UID

### Q2: 手动配置的Cookie验证失败？

**A:** 检查以下几点：
1. **格式是否正确**
   ```
   ✅ 正确: SESSDATA=xxx; bili_jct=yyy
   ❌ 错误: SESSDATA:xxx, bili_jct:yyy
   ```

2. **是否包含必需字段**
   - 必须有 `SESSDATA`
   - 必须有 `bili_jct`

3. **Cookie是否过期**
   - 从浏览器复制的Cookie可能已过期
   - 建议使用自动获取功能

### Q3: 验证成功但测试仍然失败？

**A:** Cookie验证成功只说明Cookie有效，测试失败可能有其他原因：

1. **页面权限问题**
   - Cookie有效但没有访问特定页面的权限

2. **测试配置问题**
   - URL配置错误
   - Runner配置不正确

3. **Benchmark SDK问题**
   - SDK版本不兼容
   - Cookie传递方式不正确

**调试建议：**
1. 查看测试输出日志
2. 检查测试配置
3. 参考 [COOKIE_TEST_DEBUG.md](COOKIE_TEST_DEBUG.md)

### Q4: JSON格式的Cookie能验证吗？

**A:** 可以！验证功能会自动识别并转换：

```javascript
// JSON格式输入
{
  "SESSDATA": "xxx",
  "bili_jct": "yyy",
  "DedeUserID": "110000233"
}

// 自动转换为字符串
SESSDATA=xxx; bili_jct=yyy; DedeUserID=110000233

// 然后进行验证
```

## 📚 验证结果说明

### 成功状态指示

| 指示器 | 含义 |
|-------|------|
| ✅ 绿色背景 | Cookie有效，验证成功 |
| 显示用户信息 | 包含UID、用户名、VIP状态 |
| Toast提示 "验证成功" | 顶部通知 |

### 失败状态指示

| 指示器 | 含义 |
|-------|------|
| ❌ 红色背景 | Cookie无效或已过期 |
| 显示失败原因 | 列出可能的问题 |
| Toast提示 "验证失败" | 顶部通知 |

### 加载状态指示

| 指示器 | 含义 |
|-------|------|
| 🔄 灰色背景 | 正在验证中... |
| 显示加载文本 | "正在验证Cookie..." |

## 🎯 最佳实践

### 1. **每次测试前验证**
```
自动获取Cookie → 自动验证 ✅ → 运行测试
或
手动配置Cookie → 点击验证 → 验证成功 ✅ → 运行测试
```

### 2. **测试失败后验证**
```
测试失败 → 检查Cookie → 验证 → 失败？重新获取 → 再次测试
```

### 3. **定期刷新Cookie**
```
长时间测试 → 定期验证 → 失效？重新获取 → 继续测试
```

### 4. **配合测试标记使用**
```
优化前测试 → 验证Cookie ✅ → 运行测试 → 记录结果
优化后测试 → 验证Cookie ✅ → 运行测试 → 对比结果
```

## 🔗 相关文档

- [Cookie自动获取指南](COOKIE_AUTO_FETCH.md)
- [Cookie修复文档](COOKIE_FIX.md)
- [Cookie测试调试](COOKIE_TEST_DEBUG.md)
- [Cookie调试指南](COOKIE_DEBUG_GUIDE.md)

## 🎉 功能优势

- ✅ **即时反馈**：自动获取后立即验证，确保Cookie可用
- ✅ **详细信息**：显示用户信息，确认Cookie身份
- ✅ **快速诊断**：测试失败时快速定位Cookie问题
- ✅ **格式兼容**：自动识别字符串和JSON格式
- ✅ **可视化结果**：清晰的成功/失败指示

配合Cookie自动获取功能，让Cookie管理更加智能和可靠！🚀

---

**文档版本**: v1.0
**创建时间**: 2025-11-20
**功能状态**: ✅ 已实现
