# 压测和Benchmark同步执行 - 使用指南

## 🎯 功能概述

从现在开始，压测和Benchmark测试将**同时进行**，而不是依次进行。这大幅减少了测试总耗时。

## 📊 性能对比

### 真实场景示例

**场景1：直播间压测**
- 压测时长：60秒
- Benchmark时长：120秒
- 改进前：180秒 (3分钟)
- 改进后：120秒 (2分钟)
- **节省：1分钟 (33%)**

**场景2：长期压力测试**
- 压测时长：300秒 (5分钟)
- Benchmark时长：180秒 (3分钟)
- 改进前：480秒 (8分钟)
- 改进后：300秒 (5分钟)
- **节省：180秒 (37.5%)**

## 🚀 如何使用

### 1. 创建测试用例（包含压测配置）

在"添加测试用例"对话框中：

1. **基本信息**
   - 用例名称：输入一个清晰的名称
   - 测试描述：可选

2. **选择测试类型**
   - 勾选 **Runtime** 或其他Benchmark测试类型
   - （可选）配置压测参数

3. **配置压测**（如果需要）
   - URL：选择需要压测的URL
   - 房间号、UID：直播间参数
   - 广播类型：选择压测的广播命令
   - QPS：每秒请求数
   - 时长：压测持续时间（秒）

4. **点击"保存"**

### 2. 运行用例

- **单个运行**：点击用例右侧的"▶️ 运行"
- **批量运行**：选中多个用例，点击"⚡ 并行运行"

### 3. 观察执行过程

在**输出日志**面板中，你会看到：

```
============================================================
🚀 启动压测和Benchmark同步执行
============================================================

[压测和Benchmark同时进行...]

============================================================
🚀 启动压测模拟
============================================================
URL:        https://live.bilibili.com
房间号:     123456
UID:        987654
...
[压测进行中]

[同时Benchmark也在采集数据...]

============================================================
✅ 任务完成
============================================================
```

## 📈 实时监控

### 输出日志说明

- **绿色勾✅**: 操作成功
- **红色✕❌**: 操作失败
- **黄色⚠️**: 警告信息
- **时间戳**: 每行操作的执行时间

### 关键指标

| 指标 | 说明 |
|------|------|
| 房间号 | 直播间标识 |
| UID | 主播ID |
| QPS | 每秒请求数 |
| 时长 | 压测持续时间 |
| 广播数量 | 参与压测的广播类型数 |

## ⚠️ 注意事项

### 1. 压测失败不影响Benchmark

如果压测环节失败（例如网络错误），Benchmark仍会继续执行。

```
[StressTest] ❌ 后台压测失败: 网络连接超时
[Benchmark] ✅ Benchmark执行成功，报告已生成
```

### 2. 并发限制

- 最多同时运行 **10个任务**
- 超过限制的任务自动排队等待
- 一个任务完成后，队列中的下一个任务自动开始

### 3. 超时保护

- 单个任务最多运行 **30分钟**
- 超时后自动强制终止
- 可在输出中查看超时信息

## 🔍 故障排查

### 问题1：压测显示失败，但没有错误信息

**可能原因**：
- 压测服务不可用（IP: 10.23.183.87:8083）
- 网络连接问题
- 房间号/UID无效

**解决方案**：
1. 检查网络连接
2. 验证房间号和UID是否正确
3. 查看完整的错误日志
4. 联系运维团队检查压测服务状态

### 问题2：Benchmark显示失败

**可能原因**：
- 测试URL无法访问
- 浏览器兼容性问题
- 系统资源不足

**解决方案**：
1. 验证URL是否正确且可访问
2. 检查系统资源使用情况
3. 查看Benchmark的详细输出日志

### 问题3：总运行时间没有明显改进

**可能原因**：
- Benchmark时长 > 压测时长（此时无法优化）
- 系统资源争用导致的性能下降

**优化建议**：
1. 考虑减少压测时长
2. 在负载较低的时段运行
3. 增加服务器资源

## 📋 配置建议

### 推荐的压测配置

```
QPS: 100-500       # 根据服务器承载能力调整
时长: 30-120秒      # 足以暴露问题
广播类型: 2-5个    # 覆盖主要业务场景
```

### 推荐的Benchmark配置

```
Runtime: 120-300秒  # 足够长来稳定采集数据
LongTask: 启用      # 识别长任务
fps: 启用          # 监控帧率
```

## 🎓 最佳实践

### 1. 分时段测试

- **工作时间**: 运行轻量级测试
- **非工作时间**: 运行压力测试
- **深夜**: 运行长期稳定性测试

### 2. 对比测试

创建两个相同配置的用例，在变更前后运行，比较Perfcat报告：

```
用例A: 变更前版本 → 运行 → 获取Perfcat ID-1
用例B: 变更后版本 → 运行 → 获取Perfcat ID-2
对比: Perfcat对比ID-1和ID-2
```

### 3. 定期监控

- 每天早晨运行一次标准测试用例
- 监控关键指标变化
- 及时发现性能回退

## 📞 技术支持

遇到问题？

1. **查看日志**: 输出面板中的详细日志
2. **导出报告**: 使用"导出"功能保存配置
3. **查看历史**: 在"测试记录"页面查看过往数据
4. **联系团队**: 提供任务ID和完整日志信息

## 🔗 相关链接

- [完整实现文档](./CONCURRENT_EXECUTION.md)
- [Perfcat文档](https://fe-perfcat.bilibili.co)
- [Benchmark配置指南](./README.md)

---

**最后更新**: 2025-12-04
**版本**: 2.0 - 并行执行版本
